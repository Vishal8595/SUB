<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Management System</title>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100%;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2d3748;
            line-height: 1.6;
        }

        html, body {
            height: 100%;
        }

        * {
            box-sizing: border-box;
        }

        /* Header Design */
        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 3rem;
            height: 3rem;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .logo-text {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .date-display {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            font-weight: 500;
        }

        .stats-mini {
            display: flex;
            gap: 1rem;
        }

        .stat-mini {
            text-align: center;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            min-width: 4.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .stat-mini:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .stat-mini-number {
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
        }

        .stat-mini-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 0.5rem;
            gap: 0.5rem;
            overflow-x: auto;
            backdrop-filter: blur(10px);
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            flex: 1;
            min-width: 140px;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            white-space: nowrap;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateY(-1px);
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .nav-tab-icon {
            font-size: 1.1rem;
        }

        .nav-tab-text {
            display: inline;
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2.5rem 2rem;
            min-height: calc(100vh - 200px);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Loading Animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Floating Animation */
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        /* Card Styles */
        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .card-subtitle {
            color: #718096;
            font-size: 1rem;
            font-weight: 500;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            padding: 2rem;
            color: white;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            z-index: 1;
        }

        .stat-card-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-info h3 {
            font-size: 1rem;
            font-weight: 500;
            margin: 0 0 0.75rem 0;
            opacity: 0.9;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #333333;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid rgba(226, 232, 240, 0.8);
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
        }

        /* Button Styles */
        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #38a169, #2f855a);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #718096, #4a5568);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4a5568, #2d3748);
        }

        .btn-small {
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
        }

        /* Table Styles */
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            overflow: hidden;
            margin-bottom: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: white;
            font-size: 0.875rem;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        td {
            padding: 0.875rem 0.75rem;
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            font-size: 0.875rem;
            color: #4a5568;
            vertical-align: top;
        }

        tr:hover {
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.2s ease;
        }

        tr:nth-child(even) {
            background: rgba(247, 250, 252, 0.5);
        }

        /* Enhanced Mobile Table Styles */
        @media (max-width: 768px) {
            .table-container {
                margin: 0 -1rem 2rem -1rem;
                border-radius: 0;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            .table-wrapper {
                padding: 0;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
            }

            .table-wrapper::-webkit-scrollbar {
                height: 6px;
            }

            .table-wrapper::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.05);
            }

            .table-wrapper::-webkit-scrollbar-thumb {
                background: rgba(102, 126, 234, 0.3);
                border-radius: 3px;
            }

            table {
                min-width: 600px;
                font-size: 0.8rem;
                border-collapse: separate;
                border-spacing: 0;
            }

            th {
                padding: 1rem 0.75rem;
                font-size: 0.75rem;
                white-space: nowrap;
                background: linear-gradient(135deg, #667eea, #764ba2);
                position: sticky;
                top: 0;
                z-index: 10;
            }

            td {
                padding: 1rem 0.75rem;
                font-size: 0.8rem;
                line-height: 1.4;
                vertical-align: middle;
                border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            }

            /* Enhanced mobile actions */
            .mobile-actions {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                min-width: 120px;
                align-items: stretch;
            }

            .mobile-actions .btn {
                padding: 0.75rem 1rem;
                font-size: 0.75rem;
                white-space: nowrap;
                border-radius: 8px;
                font-weight: 600;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
                transition: all 0.2s ease;
            }

            .mobile-actions .btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            /* Enhanced table cell content for mobile */
            .table-cell-content {
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .table-cell-content:hover {
                background: rgba(102, 126, 234, 0.05);
                border-radius: 4px;
                padding: 0.25rem;
                margin: -0.25rem;
            }

            .table-cell-content.expanded {
                white-space: normal;
                word-wrap: break-word;
                max-width: none;
                background: rgba(102, 126, 234, 0.05);
                border-radius: 4px;
                padding: 0.5rem;
                margin: -0.5rem;
            }

            /* Status badges mobile optimization */
            .status-badge {
                padding: 0.4rem 0.8rem;
                border-radius: 12px;
                font-size: 0.7rem;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                white-space: nowrap;
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
            }

            /* Mobile table row hover effects */
            tr:hover {
                background: rgba(102, 126, 234, 0.08);
                transform: scale(1.01);
                transition: all 0.2s ease;
            }

            /* Mobile scroll indicator */
            .table-container::after {
                content: '‚Üê Swipe to see more ‚Üí';
                position: absolute;
                bottom: 0.5rem;
                right: 1rem;
                background: rgba(102, 126, 234, 0.9);
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 12px;
                font-size: 0.7rem;
                font-weight: 600;
                opacity: 0.8;
                pointer-events: none;
                animation: fadeInOut 3s ease-in-out infinite;
            }

            @keyframes fadeInOut {
                0%, 100% { opacity: 0.3; }
                50% { opacity: 0.8; }
            }
        }

        @media (max-width: 480px) {
            table {
                min-width: 550px;
            }

            th {
                padding: 0.75rem 0.5rem;
                font-size: 0.7rem;
            }

            td {
                padding: 0.75rem 0.5rem;
                font-size: 0.75rem;
            }

            .mobile-actions {
                min-width: 100px;
                gap: 0.4rem;
            }

            .mobile-actions .btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.7rem;
            }

            .table-cell-content {
                max-width: 100px;
            }

            .status-badge {
                padding: 0.3rem 0.6rem;
                font-size: 0.65rem;
            }

            .table-container::after {
                font-size: 0.65rem;
                padding: 0.2rem 0.6rem;
            }
        }

        /* Card-style mobile table alternative */
        @media (max-width: 640px) {
            .mobile-card-view {
                display: none;
            }

            .show-mobile-cards .table-wrapper {
                display: none;
            }

            .show-mobile-cards .mobile-card-view {
                display: block;
            }

            /* Show toggle button on mobile */
            .mobile-toggle-btn {
                display: block !important;
            }
        }

        @media (min-width: 641px) {
            .mobile-toggle-btn {
                display: none !important;
            }
        }

            .mobile-card {
                background: white;
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 1rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(226, 232, 240, 0.8);
                transition: all 0.3s ease;
            }

            .mobile-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }

            .mobile-card-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid rgba(226, 232, 240, 0.5);
            }

            .mobile-card-title {
                font-weight: 700;
                font-size: 1.1rem;
                color: #374151;
                margin: 0;
            }

            .mobile-card-body {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .mobile-card-field {
                display: flex;
                flex-direction: column;
            }

            .mobile-card-label {
                font-size: 0.75rem;
                font-weight: 600;
                color: #6b7280;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 0.25rem;
            }

            .mobile-card-value {
                font-size: 0.9rem;
                color: #374151;
                font-weight: 500;
            }

            .mobile-card-actions {
                display: flex;
                gap: 0.75rem;
                justify-content: flex-end;
            }

            .mobile-card-actions .btn {
                flex: 1;
                padding: 0.75rem;
                font-size: 0.8rem;
                border-radius: 8px;
                font-weight: 600;
            }
        }

        /* Responsive table content */
        .table-cell-content {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .table-cell-content.expandable {
            cursor: pointer;
        }

        .table-cell-content.expanded {
            white-space: normal;
            word-wrap: break-word;
        }

        /* Status badges responsive */
        .status-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            display: inline-block;
        }

        /* Search Input */
        .search-container {
            margin-bottom: 2rem;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: rgba(255, 255, 255, 1);
        }

        .search-input::placeholder {
            color: #a0aec0;
        }

        .search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 1.3rem;
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-expiring {
            background: #fef3c7;
            color: #92400e;
        }

        .status-expired {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Dropdown */
        .dropdown-container {
            position: relative;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #bdc3c7;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .dropdown-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #ecf0f1;
            transition: background 0.2s ease;
            font-family: 'Times New Roman', Georgia, serif;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            border: 3px solid #34495e;
            font-family: Georgia, serif;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            z-index: 3000;
            transform: translateX(400px);
            transition: all 0.3s ease;
            max-width: 350px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-family: Georgia, serif;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #27ae60;
            border-color: #229954;
        }

        .notification.error {
            background: #e74c3c;
            border-color: #c0392b;
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .mb-4 { margin-bottom: 1rem; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header-container {
                padding: 0.75rem 1rem;
            }

            .header-top {
                flex-direction: column;
                gap: 1rem;
                margin-bottom: 1rem;
            }

            .header-info {
                flex-direction: column;
                gap: 1rem;
                width: 100%;
            }

            .stats-mini {
                justify-content: center;
                width: 100%;
            }

            .logo-text {
                font-size: 1.5rem;
            }

            .nav-tabs {
                padding: 0.25rem;
                gap: 0.25rem;
                border-radius: 12px;
            }

            .nav-tab {
                min-width: 80px;
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
                gap: 0.5rem;
                border-radius: 8px;
                flex-shrink: 0;
            }

            .nav-tab-text {
                display: none;
            }

            .nav-tab-icon {
                font-size: 1.3rem;
            }

            .main-content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 1.5rem;
            }

            .card-title {
                font-size: 1.5rem;
                flex-direction: column;
            }

            .stat-card {
                padding: 1.5rem;
            }

            .stat-number {
                font-size: 2rem;
            }

            .notification {
                right: 1rem;
                left: 1rem;
                max-width: none;
            }

            th, td {
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
            }

            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .logo-icon {
                width: 2.5rem;
                height: 2.5rem;
                font-size: 1rem;
            }

            .logo-text {
                font-size: 1.1rem;
            }

            .date-display {
                font-size: 0.75rem;
                padding: 0.4rem 0.8rem;
            }

            .stat-mini {
                padding: 0.4rem;
                min-width: 2.5rem;
            }

            .stat-mini-number {
                font-size: 0.9rem;
            }

            .stat-mini-label {
                font-size: 0.55rem;
            }

            .nav-tabs {
                padding: 0.2rem;
                gap: 0.2rem;
                border-radius: 10px;
            }

            .nav-tab {
                min-width: 60px;
                padding: 0.6rem 0.3rem;
                font-size: 0.7rem;
                gap: 0.3rem;
                border-radius: 6px;
            }

            .nav-tab-icon {
                font-size: 1.1rem;
            }

            .card-title {
                font-size: 1.25rem;
            }

            .form-input, .search-input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <!-- Top Section -->
            <div class="header-top">
                <div class="logo-section">
                    <div class="logo-icon">S</div>
                    <h1 class="logo-text">Subscription Manager</h1>
                </div>
                
                <div class="header-info">
                    <div class="date-display">
                        <span id="currentDate"></span>
                    </div>
                    
                    <div class="stats-mini">
                        <div class="stat-mini">
                            <div class="stat-mini-number" id="miniTotal">0</div>
                            <div class="stat-mini-label">Total</div>
                        </div>
                        <div class="stat-mini">
                            <div class="stat-mini-number" id="miniActive">0</div>
                            <div class="stat-mini-label">Active</div>
                        </div>
                        <div class="stat-mini">
                            <div class="stat-mini-number" id="miniExpiring">0</div>
                            <div class="stat-mini-label">Expiring</div>
                        </div>
                        <div class="stat-mini">
                            <div class="stat-mini-number" id="miniExpired">0</div>
                            <div class="stat-mini-label">Expired</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button onclick="showTab('dashboard')" class="nav-tab active" id="dashboard-tab">
                    <span class="nav-tab-icon">üìä</span>
                    <span class="nav-tab-text">Dashboard</span>
                </button>
                <button onclick="showTab('master')" class="nav-tab" id="master-tab">
                    <span class="nav-tab-icon">üë•</span>
                    <span class="nav-tab-text">Master Entry</span>
                </button>
                <button onclick="showTab('renewal')" class="nav-tab" id="renewal-tab">
                    <span class="nav-tab-icon">üîÑ</span>
                    <span class="nav-tab-text">Renewal</span>
                </button>
                <button onclick="showTab('settings')" class="nav-tab" id="settings-tab">
                    <span class="nav-tab-icon">‚öôÔ∏è</span>
                    <span class="nav-tab-text">Settings</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <!-- Quick Actions -->
            <div class="card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15)); margin-bottom: 2rem; padding: 1.5rem; border: 2px solid rgba(102, 126, 234, 0.2);">
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #374151; margin: 0 0 1.5rem 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                    <span style="font-size: 1.5rem;">‚ö°</span>
                    <span>Quick Actions</span>
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <button onclick="quickAddMasterEntry()" class="btn btn-primary" style="padding: 1rem; font-size: 0.95rem; border-radius: 15px; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">
                        <span style="font-size: 1.2rem;">‚ûï</span>
                        <span>Add Master Entry</span>
                    </button>
                    <button onclick="quickRenewalEntry()" class="btn btn-success" style="padding: 1rem; font-size: 0.95rem; border-radius: 15px; box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3); transition: all 0.3s ease;">
                        <span style="font-size: 1.2rem;">üîÑ</span>
                        <span>Renewal Entry</span>
                    </button>
                    <button onclick="quickBulkImportExport()" class="btn btn-secondary" style="padding: 1rem; font-size: 0.95rem; border-radius: 15px; box-shadow: 0 6px 20px rgba(113, 128, 150, 0.3); transition: all 0.3s ease; background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                        <span style="font-size: 1.2rem;">üìä</span>
                        <span>Bulk Import/Export</span>
                    </button>
                    <button onclick="quickViewWarnings()" class="btn" style="padding: 1rem; font-size: 0.95rem; border-radius: 15px; box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3); transition: all 0.3s ease; background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                        <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
                        <span>View Warnings</span>
                    </button>
                </div>
            </div>

            <!-- Stats Overview Section -->
            <div class="card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15)); margin-bottom: 2rem; padding: 1.5rem; border: 2px solid rgba(102, 126, 234, 0.2);">
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #374151; margin: 0 0 1.5rem 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                    <span style="font-size: 1.5rem;">üìä</span>
                    <span>Subscription Overview</span>
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <!-- Total Subscriptions -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 15px; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3); transition: all 0.3s ease; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-5px) scale(1.02)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
                        <div style="position: absolute; top: -10px; right: -10px; width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.4;"></div>
                        <div style="display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 2;">
                            <div>
                                <div style="font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem; opacity: 0.9;">üìà Total Subscriptions</div>
                                <div style="font-size: 2.5rem; font-weight: 900; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3);" id="totalSubs">0</div>
                                <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.5rem;">All registered clients</div>
                            </div>
                            <div style="font-size: 2.5rem; opacity: 0.6;">üìä</div>
                        </div>
                    </div>

                    <!-- Active Subscriptions -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 15px; box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3); transition: all 0.3s ease; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-5px) scale(1.02)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
                        <div style="position: absolute; top: -10px; right: -10px; width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.4;"></div>
                        <div style="display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 2;">
                            <div>
                                <div style="font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem; opacity: 0.9;">‚úÖ Active Subscriptions</div>
                                <div style="font-size: 2.5rem; font-weight: 900; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3);" id="activeSubs">0</div>
                                <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.5rem;">Currently running</div>
                            </div>
                            <div style="font-size: 2.5rem; opacity: 0.6;">üü¢</div>
                        </div>
                    </div>

                    <!-- Expiring Soon -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: 15px; box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3); transition: all 0.3s ease; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-5px) scale(1.02)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
                        <div style="position: absolute; top: -10px; right: -10px; width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.4;"></div>
                        <div style="display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 2;">
                            <div>
                                <div style="font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem; opacity: 0.9;">‚ö†Ô∏è Expiring Soon</div>
                                <div style="font-size: 2.5rem; font-weight: 900; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3);" id="expiringSubs">0</div>
                                <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.5rem;" id="expiringDaysText">Within 30 days</div>
                            </div>
                            <div style="font-size: 2.5rem; opacity: 0.6;">üü°</div>
                        </div>
                    </div>

                    <!-- Expired -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border-radius: 15px; box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3); transition: all 0.3s ease; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-5px) scale(1.02)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
                        <div style="position: absolute; top: -10px; right: -10px; width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.4;"></div>
                        <div style="display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 2;">
                            <div>
                                <div style="font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem; opacity: 0.9;">‚ùå Expired</div>
                                <div style="font-size: 2.5rem; font-weight: 900; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3);" id="expiredSubs">0</div>
                                <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.5rem;">Need renewal</div>
                            </div>
                            <div style="font-size: 2.5rem; opacity: 0.6;">üî¥</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">

                <!-- Search and View Toggle -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center; flex-wrap: wrap;">
                    <div class="search-container" style="flex: 1; margin-bottom: 0;">
                        <div class="search-icon">üîç</div>
                        <input type="text" id="searchInput" placeholder="Search by company name, email, or subscription ID..." 
                               class="search-input">
                    </div>
                    <button id="toggleViewBtn" onclick="toggleMobileView('dashboard')" class="btn btn-secondary mobile-toggle-btn" style="white-space: nowrap; padding: 1rem 1.5rem;">
                        üì± Card View
                    </button>
                </div>

                <!-- Table -->
                <div class="table-container" id="dashboardTableContainer">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>üè¢ Company</th>
                                    <th>‚úâÔ∏è Email</th>
                                    <th>üîñ Sub ID</th>
                                    <th>üìã Model</th>
                                    <th>üìÜ Expiry</th>
                                    <th>üìä Status</th>
                                </tr>
                            </thead>
                            <tbody id="dashboardTable">
                                <tr>
                                    <td colspan="6" class="text-center" style="padding: 3rem;">
                                        <div style="color: #64748b; font-size: 1.1rem;">
                                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                                            <p>No subscriptions found</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mobile Card View -->
                    <div class="mobile-card-view" id="dashboardCards">
                        <div style="text-align: center; padding: 3rem; color: #64748b; font-size: 1.1rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                            <p>No subscriptions found</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Master Entry Tab -->
        <div id="master" class="tab-content">
            <!-- Add Button -->
            <div class="text-center mb-4">
                <div class="flex gap-4 justify-center">
                    <button onclick="toggleForm()" id="addBtn" class="btn btn-primary">
                        ‚ûï Add New Subscription
                    </button>
                    <button onclick="toggleBulkImport()" id="bulkBtn" class="btn btn-success">
                        üìä Bulk Import/Export
                    </button>
                </div>
            </div>

            <!-- Enhanced Master Entry Form -->
            <div id="masterForm" class="card hidden" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08)); border: 2px solid rgba(102, 126, 234, 0.2); box-shadow: 0 15px 35px rgba(102, 126, 234, 0.15);">
                <div class="flex justify-between items-center mb-4" style="padding-bottom: 1.5rem; border-bottom: 2px solid rgba(102, 126, 234, 0.1);">
                    <h2 class="card-title" style="margin-bottom: 0; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        <span style="font-size: 2rem; filter: drop-shadow(0 2px 4px rgba(102, 126, 234, 0.3));">üë•</span>
                        <span>Master Entry Form</span>
                    </h2>
                    <button onclick="toggleForm()" class="btn btn-secondary btn-small" style="border-radius: 50%; width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center;">
                        ‚úï
                    </button>
                </div>
                
                <!-- Form Progress Indicator -->
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem; font-weight: 600; color: #667eea;">üìù Fill Details</span>
                        <span style="font-size: 0.875rem; color: #6b7280;" id="formProgress">0/7 completed</span>
                    </div>
                    <div style="width: 100%; height: 6px; background: rgba(102, 126, 234, 0.1); border-radius: 3px; overflow: hidden;">
                        <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease; border-radius: 3px;"></div>
                    </div>
                </div>
                
                <form id="subscriptionForm">
                    <div class="form-grid">
                        <!-- Company Name -->
                        <div class="form-group" style="position: relative;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #374151;">
                                <span style="font-size: 1.2rem;">üè¢</span>
                                <span>Company Name *</span>
                            </label>
                            <div style="position: relative;">
                                <input type="text" id="companyName" required class="form-input" placeholder="Enter company name" 
                                       style="padding-left: 3rem; border: 2px solid rgba(102, 126, 234, 0.2); transition: all 0.3s ease;"
                                       oninput="updateFormProgress()" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='rgba(102, 126, 234, 0.2)'; this.style.boxShadow='none'">
                                <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.1rem; color: #667eea;">üè¢</span>
                            </div>
                        </div>

                        <!-- Mobile Number -->
                        <div class="form-group" style="position: relative;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #374151;">
                                <span style="font-size: 1.2rem;">üìû</span>
                                <span>Mobile Number *</span>
                            </label>
                            <div style="position: relative;">
                                <input type="tel" id="mobileNo" required class="form-input" placeholder="Enter 10-digit mobile number" 
                                       style="padding-left: 3rem; border: 2px solid rgba(102, 126, 234, 0.2); transition: all 0.3s ease;"
                                       oninput="updateFormProgress(); formatMobileNumber(this)" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='rgba(102, 126, 234, 0.2)'; this.style.boxShadow='none'">
                                <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.1rem; color: #667eea;">üìû</span>
                            </div>
                        </div>

                        <!-- Email ID -->
                        <div class="form-group" style="position: relative;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #374151;">
                                <span style="font-size: 1.2rem;">‚úâÔ∏è</span>
                                <span>Email Address *</span>
                            </label>
                            <div style="position: relative;">
                                <input type="email" id="emailId" required class="form-input" placeholder="Enter email address" 
                                       style="padding-left: 3rem; border: 2px solid rgba(102, 126, 234, 0.2); transition: all 0.3s ease;"
                                       oninput="updateFormProgress()" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='rgba(102, 126, 234, 0.2)'; this.style.boxShadow='none'">
                                <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.1rem; color: #667eea;">‚úâÔ∏è</span>
                            </div>
                        </div>

                        <!-- Subscription ID -->
                        <div class="form-group" style="position: relative;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #374151;">
                                <span style="font-size: 1.2rem;">üîñ</span>
                                <span>Subscription ID *</span>
                            </label>
                            <div style="position: relative;">
                                <input type="text" id="subscriptionId" required class="form-input" placeholder="Enter unique subscription ID" 
                                       style="padding-left: 3rem; border: 2px solid rgba(102, 126, 234, 0.2); transition: all 0.3s ease;"
                                       oninput="updateFormProgress()" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='rgba(102, 126, 234, 0.2)'; this.style.boxShadow='none'">
                                <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.1rem; color: #667eea;">üîñ</span>
                            </div>
                        </div>

                        <!-- Model/Plan -->
                        <div class="form-group" style="position: relative;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #374151;">
                                <span style="font-size: 1.2rem;">üìã</span>
                                <span>Subscription Model *</span>
                            </label>
                            <div style="position: relative;">
                                <input type="text" id="model" required class="form-input" placeholder="Enter subscription model/plan" 
                                       style="padding-left: 3rem; border: 2px solid rgba(102, 126, 234, 0.2); transition: all 0.3s ease;"
                                       oninput="updateFormProgress()" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='rgba(102, 126, 234, 0.2)'; this.style.boxShadow='none'">
                                <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.1rem; color: #667eea;">üìã</span>
                            </div>
                        </div>

                        <!-- Starting Date -->
                        <div class="form-group" style="position: relative;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #374151;">
                                <span style="font-size: 1.2rem;">üìÖ</span>
                                <span>Starting Date *</span>
                            </label>
                            <div style="position: relative;">
                                <input type="date" id="startingDate" required class="form-input" 
                                       style="padding-left: 3rem; border: 2px solid rgba(102, 126, 234, 0.2); transition: all 0.3s ease;"
                                       onchange="updateFormProgress(); calculateExpiryDate()" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='rgba(102, 126, 234, 0.2)'; this.style.boxShadow='none'">
                                <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.1rem; color: #667eea;">üìÖ</span>
                                <button type="button" onclick="setTodayDate()" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                                    üìÖ Today
                                </button>
                            </div>
                        </div>

                        <!-- Expiry Date -->
                        <div class="form-group" style="position: relative;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #374151;">
                                <span style="font-size: 1.2rem;">üìÜ</span>
                                <span>Expiry Date *</span>
                            </label>
                            <div style="position: relative;">
                                <input type="date" id="expiryDate" required class="form-input" 
                                       style="padding-left: 3rem; border: 2px solid rgba(102, 126, 234, 0.2); transition: all 0.3s ease;"
                                       onchange="updateFormProgress()" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='rgba(102, 126, 234, 0.2)'; this.style.boxShadow='none'">
                                <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.1rem; color: #667eea;">üìÜ</span>
                                <div style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); display: flex; gap: 0.25rem;">
                                    <button type="button" onclick="addMonths(6)" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 0.25rem 0.4rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">+6M</button>
                                    <button type="button" onclick="addMonths(12)" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; padding: 0.25rem 0.4rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">+1Y</button>
                                </div>
                            </div>
                        </div>

                        <!-- Remarks -->
                        <div class="form-group" style="position: relative; grid-column: 1 / -1;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #374151;">
                                <span style="font-size: 1.2rem;">üìù</span>
                                <span>Remarks (Optional)</span>
                            </label>
                            <div style="position: relative;">
                                <textarea id="remarks" class="form-input" placeholder="Enter any additional notes or remarks..." rows="3"
                                          style="padding-left: 3rem; padding-top: 1rem; border: 2px solid rgba(102, 126, 234, 0.2); transition: all 0.3s ease; resize: vertical; min-height: 80px;"
                                          onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='rgba(102, 126, 234, 0.2)'; this.style.boxShadow='none'"></textarea>
                                <span style="position: absolute; left: 1rem; top: 1rem; font-size: 1.1rem; color: #667eea;">üìù</span>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Action Buttons -->
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid rgba(102, 126, 234, 0.1); flex-wrap: wrap;">
                        <button type="submit" class="btn btn-success" style="padding: 1rem 2rem; font-size: 1rem; border-radius: 12px; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3); position: relative; overflow: hidden;">
                            <span style="position: relative; z-index: 2; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üíæ</span>
                                <span>Save Subscription</span>
                            </span>
                        </button>
                        <button type="button" onclick="clearForm()" class="btn btn-secondary" style="padding: 1rem 2rem; font-size: 1rem; border-radius: 12px;">
                            <span style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üóëÔ∏è</span>
                                <span>Clear Form</span>
                            </span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Excel Import/Export Section -->
            <div id="bulkImportSection" class="card hidden" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="card-title" style="font-size: 1.5rem; margin-bottom: 0;">
                        <span>üìä</span>
                        <span>Excel Data Management</span>
                    </h3>
                    <button onclick="toggleBulkImport()" class="btn btn-secondary btn-small">
                        ‚úï Close
                    </button>
                </div>
                <div class="flex gap-4 justify-center">
                    <button onclick="exportToExcel()" class="btn btn-success">
                        üì§ Export to Excel
                    </button>
                    <label class="btn btn-primary" style="cursor: pointer;">
                        üì• Import from Excel
                        <input type="file" id="excelImportFile" accept=".xlsx,.xls,.csv" class="hidden" onchange="importFromExcel(event)">
                    </label>
                    <button onclick="downloadExcelTemplate()" class="btn btn-secondary">
                        üìã Download Template
                    </button>
                </div>
            </div>

            <!-- Search and View Toggle -->
            <div style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center; flex-wrap: wrap;">
                <div class="search-container" style="flex: 1; margin-bottom: 0;">
                    <div class="search-icon">üîç</div>
                    <input type="text" id="masterSearch" placeholder="Search by company name, email, subscription ID, or mobile..." 
                           class="search-input">
                </div>
                <button id="toggleMasterViewBtn" onclick="toggleMobileView('master')" class="btn btn-secondary mobile-toggle-btn" style="white-space: nowrap; padding: 1rem 1.5rem;">
                    üì± Card View
                </button>
            </div>

            <!-- Master Table -->
            <div class="table-container" id="masterTableContainer">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>üè¢ Company</th>
                                <th>üìû Mobile</th>
                                <th>‚úâÔ∏è Email</th>
                                <th>üîñ Sub ID</th>
                                <th>‚öôÔ∏è Actions</th>
                            </tr>
                        </thead>
                        <tbody id="masterTable">
                            <tr>
                                <td colspan="5" class="text-center" style="padding: 3rem;">
                                    <div style="color: #64748b; font-size: 1.1rem;">
                                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                                        <p>No subscriptions added yet</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Card View -->
                <div class="mobile-card-view" id="masterCards">
                    <div style="text-align: center; padding: 3rem; color: #64748b; font-size: 1.1rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                        <p>No subscriptions added yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Renewal Tab -->
        <div id="renewal" class="tab-content">
            <!-- Enhanced Renewal Form -->
            <div class="card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(5, 150, 105, 0.08)); border: 2px solid rgba(16, 185, 129, 0.2); box-shadow: 0 15px 35px rgba(16, 185, 129, 0.15);">
                <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid rgba(16, 185, 129, 0.1);">
                    <h2 class="card-title" style="margin-bottom: 0.5rem; background: linear-gradient(135deg, #10b981, #059669); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        <span style="font-size: 2.5rem; filter: drop-shadow(0 2px 4px rgba(16, 185, 129, 0.3));">üîÑ</span>
                        <span>Renewal Entry</span>
                    </h2>
                    <p style="color: #6b7280; font-size: 1rem; margin: 0;">Extend subscription periods with ease</p>
                </div>
                
                <form id="renewalForm">
                    <!-- Step Indicator -->
                    <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div id="step1" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 25px; font-size: 0.875rem; font-weight: 600; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">
                                <span>1Ô∏è‚É£</span>
                                <span>Select Subscription</span>
                            </div>
                            <div style="width: 2rem; height: 2px; background: linear-gradient(90deg, #10b981, #d1d5db);"></div>
                            <div id="step2" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: #e5e7eb; color: #6b7280; border-radius: 25px; font-size: 0.875rem; font-weight: 600; transition: all 0.3s ease;">
                                <span>2Ô∏è‚É£</span>
                                <span>Set New Date</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <!-- Enhanced Subscription Search -->
                        <div class="form-group dropdown-container" style="position: relative;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #374151; margin-bottom: 1rem;">
                                <span style="font-size: 1.3rem;">üîç</span>
                                <span>Search Subscription *</span>
                                <span id="searchCounter" style="font-size: 0.8rem; color: #6b7280; font-weight: 400; margin-left: auto;"></span>
                            </label>
                            <div style="position: relative;">
                                <input type="text" id="renewalSubId" required class="form-input" 
                                       placeholder="Type subscription ID or company name to search..." 
                                       autocomplete="off" oninput="handleSearchInputFast()" onfocus="showDropdownFast()" onblur="hideDropdownDelayed()"
                                       style="padding-left: 3.5rem; padding-right: 3rem; border: 2px solid rgba(16, 185, 129, 0.2); transition: all 0.2s ease; font-size: 1rem;"
                                       onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.2)'; this.style.boxShadow='none'">
                                <span style="position: absolute; left: 1.25rem; top: 50%; transform: translateY(-50%); font-size: 1.2rem; color: #10b981;">üîñ</span>
                                <div id="searchLoader" class="hidden" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; border: 2px solid #e5e7eb; border-top: 2px solid #10b981; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                                <div id="searchStatus" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); font-size: 1rem; color: #10b981; display: none;">‚úÖ</div>
                            </div>
                            
                            <!-- Enhanced Dropdown -->
                            <div id="subscriptionDropdown" class="dropdown-list hidden" style="border: 2px solid rgba(16, 185, 129, 0.2); border-radius: 12px; box-shadow: 0 10px 25px rgba(16, 185, 129, 0.15); backdrop-filter: blur(10px); max-height: 300px;">
                                <div id="dropdownOptions">
                                    <!-- Options will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced New Expiry Date -->
                        <div class="form-group" style="position: relative;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #374151; margin-bottom: 1rem;">
                                <span style="font-size: 1.3rem;">üìÜ</span>
                                <span>New Expiry Date *</span>
                            </label>
                            <div style="position: relative;">
                                <input type="date" id="newExpiryDate" required class="form-input" 
                                       style="padding-left: 3.5rem; border: 2px solid rgba(16, 185, 129, 0.2); transition: all 0.3s ease; font-size: 1rem;"
                                       onchange="updateRenewalStep()" onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'" onblur="this.style.borderColor='rgba(16, 185, 129, 0.2)'; this.style.boxShadow='none'">
                                <span style="position: absolute; left: 1.25rem; top: 50%; transform: translateY(-50%); font-size: 1.2rem; color: #10b981;">üìÖ</span>
                                
                                <!-- Quick Date Buttons -->
                                <div style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); display: flex; gap: 0.25rem;">
                                    <button type="button" onclick="addRenewalMonths(6)" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 0.3rem 0.5rem; border-radius: 6px; font-size: 0.7rem; cursor: pointer; font-weight: 600;">+6M</button>
                                    <button type="button" onclick="addRenewalMonths(12)" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; padding: 0.3rem 0.5rem; border-radius: 6px; font-size: 0.7rem; cursor: pointer; font-weight: 600;">+1Y</button>
                                    <button type="button" onclick="addRenewalMonths(24)" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 0.3rem 0.5rem; border-radius: 6px; font-size: 0.7rem; cursor: pointer; font-weight: 600;">+2Y</button>
                                </div>
                            </div>
                            
                            <!-- Duration Calculator -->
                            <div id="durationInfo" class="hidden" style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; font-size: 0.875rem; color: #065f46;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span>‚è±Ô∏è</span>
                                    <span id="durationText">Extension period will be calculated</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Selected Details -->
                    <div id="selectedDetails" class="hidden" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05)); padding: 2rem; border-radius: 15px; margin: 2rem 0; border: 2px solid rgba(16, 185, 129, 0.1); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(16, 185, 129, 0.1); border-radius: 50%; opacity: 0.5;"></div>
                        <div style="position: relative; z-index: 2;">
                            <h3 style="font-weight: 700; color: #065f46; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; font-size: 1.25rem;">
                                <span style="font-size: 1.5rem;">üìã</span>
                                <span>Selected Subscription Details</span>
                            </h3>
                            <div id="detailsContent" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.1);"></div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Action Button -->
                    <div style="text-center; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid rgba(16, 185, 129, 0.1);">
                        <button type="submit" class="btn btn-success" style="padding: 1.25rem 3rem; font-size: 1.1rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3); position: relative; overflow: hidden; transform: scale(1); transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <span style="position: relative; z-index: 2; display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.3rem;">üîÑ</span>
                                <span>Renew Subscription</span>
                                <span style="font-size: 1rem;">‚ú®</span>
                            </span>
                        </button>
                        
                        <!-- Renewal Summary -->
                        <div id="renewalSummary" class="hidden" style="margin-top: 1.5rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 10px; font-size: 0.9rem; color: #065f46;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span>üìä</span>
                                <span id="summaryText">Ready to renew subscription</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Warning List -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>‚ö†Ô∏è</span>
                        <span>Expiry Warning List</span>
                    </h2>
                    <p class="card-subtitle">Subscriptions expiring soon and already expired</p>
                </div>

                <!-- Warning Stats -->
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <div class="stat-card-content">
                            <div class="stat-info">
                                <h3>Expiring Soon</h3>
                                <p class="stat-number" id="warningSoon">0</p>
                            </div>
                            <div class="stat-icon">‚ö†Ô∏è</div>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                        <div class="stat-card-content">
                            <div class="stat-info">
                                <h3>Already Expired</h3>
                                <p class="stat-number" id="warningExpired">0</p>
                            </div>
                            <div class="stat-icon">‚ùå</div>
                        </div>
                    </div>
                </div>

                <!-- View Toggle for Warning Table -->
                <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                    <button id="toggleWarningViewBtn" onclick="toggleMobileView('warning')" class="btn btn-secondary mobile-toggle-btn" style="padding: 0.75rem 1.25rem;">
                        üì± Card View
                    </button>
                </div>

                <!-- Warning Table -->
                <div class="table-container" id="warningTableContainer">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>üè¢ Company</th>
                                    <th>üîñ Sub ID</th>
                                    <th>üìã Model</th>
                                    <th>üìÜ Expiry</th>
                                    <th>üìä Status</th>
                                    <th>üìû Contact</th>
                                    <th>‚öôÔ∏è Actions</th>
                                </tr>
                            </thead>
                            <tbody id="warningTable">
                                <tr>
                                    <td colspan="7" class="text-center" style="padding: 3rem;">
                                        <div style="color: #64748b; font-size: 1.1rem;">
                                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                                            <p>No subscriptions expiring soon</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mobile Card View -->
                    <div class="mobile-card-view" id="warningCards">
                        <div style="text-align: center; padding: 3rem; color: #64748b; font-size: 1.1rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                            <p>No subscriptions expiring soon</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>‚öôÔ∏è</span>
                        <span>Settings & Configuration</span>
                    </h2>
                    <p class="card-subtitle">Manage your app preferences and data</p>
                </div>
                
                <!-- Warning Days Setting -->
                <div class="card" style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.1), rgba(239, 68, 68, 0.1));">
                    <h3 class="card-title" style="font-size: 1.5rem;">
                        <span>‚ö†Ô∏è</span>
                        <span>Expiry Warning Settings</span>
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">üìÖ Warning Days Before Expiry</label>
                            <input type="number" id="warningDays" min="1" max="365" value="30" class="form-input" placeholder="Enter number of days">
                            <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">Subscriptions expiring within this many days will be shown in the warning list</p>
                        </div>
                        <div class="form-group">
                            <button onclick="updateWarningDays()" class="btn btn-primary" style="width: 100%;">
                                üíæ Save Settings
                            </button>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Message Templates -->
                <div class="card" style="background: linear-gradient(135deg, rgba(37, 211, 102, 0.1), rgba(16, 185, 129, 0.1));">
                    <h3 class="card-title" style="font-size: 1.5rem;">
                        <span>üí¨</span>
                        <span>WhatsApp Message Templates</span>
                    </h3>
                    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1.5rem; text-align: center;">
                        Customize WhatsApp messages for expired and expiring subscriptions. Use placeholders: {COMPANY_NAME}, {SUB_ID}, {EXPIRY_DATE}, {MODEL}
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                        <!-- Expired Template -->
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; color: #dc2626; font-weight: 700;">
                                <span style="font-size: 1.2rem;">üö®</span>
                                <span>Expired Subscription Template</span>
                            </label>
                            <textarea id="expiredTemplate" class="form-input" rows="12" 
                                      style="font-family: monospace; font-size: 0.875rem; line-height: 1.5; border: 2px solid rgba(220, 38, 38, 0.2);"
                                      placeholder="Enter template for expired subscriptions..."></textarea>
                        </div>
                        
                        <!-- Expiring Soon Template -->
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; color: #f59e0b; font-weight: 700;">
                                <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
                                <span>Expiring Soon Template</span>
                            </label>
                            <textarea id="expiringSoonTemplate" class="form-input" rows="12" 
                                      style="font-family: monospace; font-size: 0.875rem; line-height: 1.5; border: 2px solid rgba(245, 158, 11, 0.2);"
                                      placeholder="Enter template for expiring subscriptions..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Template Actions -->
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button onclick="saveMessageTemplates()" class="btn btn-success" style="padding: 0.875rem 2rem;">
                            üíæ Save Templates
                        </button>
                        <button onclick="resetToDefaultTemplates()" class="btn btn-secondary" style="padding: 0.875rem 2rem;">
                            üîÑ Reset to Default
                        </button>
                        <button onclick="previewTemplate('expired')" class="btn" style="background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; padding: 0.875rem 2rem;">
                            üëÅÔ∏è Preview Expired
                        </button>
                        <button onclick="previewTemplate('expiringSoon')" class="btn" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 0.875rem 2rem;">
                            üëÅÔ∏è Preview Expiring
                        </button>
                    </div>
                </div>

                <!-- Google Sheets Integration -->
                <div class="card" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)); border: 2px solid rgba(34, 197, 94, 0.2);">
                    <h3 class="card-title" style="font-size: 1.5rem; color: #059669;">
                        <span>üìä</span>
                        <span>Google Sheets Database</span>
                    </h3>
                    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 2rem; text-align: center;">
                        Connect your webapp to Google Sheets for real-time sync across all devices
                    </p>
                    
                    <!-- Connection Status -->
                    <div id="connectionStatus" style="padding: 1rem; border-radius: 12px; margin-bottom: 2rem; text-align: center; font-weight: 600;">
                        <div id="statusIcon" style="font-size: 2rem; margin-bottom: 0.5rem;">üî¥</div>
                        <div id="statusText">Not Connected</div>
                        <div id="statusDetails" style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.8;"></div>
                        <div id="scriptStatus" style="font-size: 0.8rem; margin-top: 0.5rem; padding: 0.5rem; border-radius: 8px; background: rgba(239, 68, 68, 0.1); color: #dc2626; display: none;">
                            <span id="scriptStatusIcon">üî¥</span>
                            <span id="scriptStatusText">Apps Script: Not Connected</span>
                        </div>
                    </div>
                    
                    <!-- Setup Steps -->
                    <div id="setupSteps" style="background: rgba(34, 197, 94, 0.05); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
                        <h4 style="color: #059669; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üöÄ</span>
                            <span>Database Setup Guide</span>
                        </h4>
                        
                        <!-- Important Notice -->
                        <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: #92400e; font-weight: 600; margin-bottom: 0.5rem;">
                                <span>‚ö†Ô∏è</span>
                                <span>‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∏‡•Ç‡§ö‡§®‡§æ / Important Notice</span>
                            </div>
                            <p style="color: #92400e; font-size: 0.875rem; margin: 0; line-height: 1.5;">
                                <strong>Google Apps Script setup is required for database sync.</strong><br>
                                Without this, you'll get connection errors. Follow all 3 steps carefully.
                            </p>
                        </div>
                        
                        <div style="display: grid; gap: 1.5rem;">
                            <!-- Step 1 -->
                            <div style="display: flex; gap: 1rem; align-items: flex-start;">
                                <div style="background: #059669; color: white; width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                                <div>
                                    <h5 style="margin: 0 0 0.5rem 0; color: #374151;">Create Google Sheet Database</h5>
                                    <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">Create a new Google Sheet with proper column headers</p>
                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                        <button onclick="createGoogleSheet()" class="btn btn-success" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                            üìä Create Sheet
                                        </button>
                                        <button onclick="copySheetTemplate()" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                            üìã Copy Headers
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 2 -->
                            <div style="display: flex; gap: 1rem; align-items: flex-start;">
                                <div style="background: #059669; color: white; width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 0.5rem 0; color: #374151;">Setup Google Apps Script (Required)</h5>
                                    <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.875rem;">Install the sync script to enable database connectivity</p>
                                    <div style="background: #fee2e2; padding: 0.75rem; border-radius: 6px; margin: 0.5rem 0; border-left: 4px solid #ef4444;">
                                        <p style="color: #991b1b; font-size: 0.8rem; margin: 0; font-weight: 600;">
                                            ‚ö†Ô∏è This step is mandatory! Without Apps Script, sync will fail.
                                        </p>
                                    </div>
                                    <button onclick="showScriptSetup()" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                        ‚öôÔ∏è View Script Setup
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Step 3 -->
                            <div style="display: flex; gap: 1rem; align-items: flex-start;">
                                <div style="background: #059669; color: white; width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 0.5rem 0; color: #374151;">Connect Database</h5>
                                    <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.875rem;">Enter your Google Apps Script Web App URL to connect database</p>
                                    <input type="url" id="scriptUrl" placeholder="https://script.google.com/macros/s/AKfycbx.../exec" 
                                           class="form-input" style="margin-bottom: 0.5rem;">
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button onclick="connectScript()" class="btn btn-success" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                            üîó Connect Database
                                        </button>
                                        <button onclick="showDebugInfo()" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                            üîç Debug Info
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Troubleshooting -->
                        <div style="background: #f3f4f6; padding: 1rem; border-radius: 8px; margin-top: 1.5rem;">
                            <h6 style="color: #374151; margin: 0 0 0.5rem 0; font-weight: 600;">üîß Common Issues:</h6>
                            <ul style="color: #6b7280; font-size: 0.8rem; margin: 0; padding-left: 1.5rem; line-height: 1.4;">
                                <li>Make sure Apps Script is deployed as "Web app" with "Anyone" access</li>
                                <li>URL should end with "/exec" not "/dev"</li>
                                <li>Sheet must have proper column headers in Row 1</li>
                                <li>Check browser console (F12) for detailed error messages</li>
                            </ul>
                        </div>
                        
                        <!-- Hidden Sheet URL Input (for backward compatibility) -->
                        <input type="url" id="sheetUrl" class="hidden">
                    </div>
                    
                    <!-- Sync Controls -->
                    <div id="syncControls" class="hidden" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <button onclick="syncFromSheet()" class="btn btn-success" id="syncFromBtn">
                            ‚¨áÔ∏è Sync from Sheet
                        </button>
                        <button onclick="syncToSheet()" class="btn btn-primary" id="syncToBtn">
                            ‚¨ÜÔ∏è Sync to Sheet
                        </button>
                        <button onclick="enableAutoSync()" class="btn" id="autoSyncBtn" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;">
                            üîÑ Enable Auto Sync
                        </button>
                        <button onclick="testConnection()" class="btn btn-secondary">
                            üß™ Test Connection
                        </button>
                    </div>
                    
                    <!-- Auto Sync Settings -->
                    <div id="autoSyncSettings" class="hidden" style="background: rgba(139, 92, 246, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                        <h4 style="color: #7c3aed; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üîÑ</span>
                            <span>Auto Sync Settings</span>
                        </h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">‚è±Ô∏è Sync Interval (minutes)</label>
                                <select id="syncInterval" class="form-input">
                                    <option value="1">1 minute</option>
                                    <option value="5" selected>5 minutes</option>
                                    <option value="10">10 minutes</option>
                                    <option value="30">30 minutes</option>
                                    <option value="60">1 hour</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">üì± Sync on Page Load</label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="syncOnLoad" checked style="width: auto;">
                                    <span>Automatically sync when app loads</span>
                                </label>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 1rem;">
                            <button onclick="saveAutoSyncSettings()" class="btn btn-success">
                                üíæ Save Auto Sync Settings
                            </button>
                        </div>
                    </div>
                    
                    <!-- Sync Status -->
                    <div id="syncStatus" class="hidden" style="background: rgba(16, 185, 129, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-weight: 600; color: #059669;">Last Sync: <span id="lastSyncTime">Never</span></div>
                                <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem;" id="syncDetails">No sync performed yet</div>
                            </div>
                            <div id="syncIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444;"></div>
                        </div>
                    </div>
                    
                    <!-- Disconnect Button -->
                    <div id="disconnectSection" class="hidden" style="text-align: center; padding-top: 1rem; border-top: 2px solid rgba(34, 197, 94, 0.1);">
                        <button onclick="disconnectSheet()" class="btn btn-danger">
                            üîå Disconnect Sheet
                        </button>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));">
                    <h3 class="card-title" style="font-size: 1.5rem;">
                        <span>üìÅ</span>
                        <span>Local Data Management</span>
                    </h3>
                    <div class="form-grid">
                        <button onclick="exportData()" class="btn btn-primary">
                            üì§ Export Data
                        </button>
                        <label class="btn btn-success" style="cursor: pointer;">
                            üì• Import Data
                            <input type="file" id="importFile" accept=".json" class="hidden" onchange="importData(event)">
                        </label>
                        <button onclick="showResetConfirm()" class="btn btn-danger">
                            üóëÔ∏è Reset All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
            <h3 style="font-size: 1.25rem; font-weight: 700; color: #374151; margin-bottom: 1rem;">Confirm Action</h3>
            <p id="confirmMessage" style="color: #6b7280; margin-bottom: 2rem;"></p>
            <div class="flex justify-center gap-4">
                <button onclick="hideConfirmModal()" class="btn btn-secondary">
                    Cancel
                </button>
                <button id="confirmButton" class="btn btn-danger">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Global variables
        let subscriptions = [];
        let editingIndex = -1;
        let settings = { warningDays: 30 };
        let sheetConfig = {
            url: '',
            id: '',
            scriptUrl: '',
            connected: false,
            scriptConnected: false,
            autoSync: false,
            syncInterval: 5,
            syncOnLoad: true,
            lastSync: null
        };
        let syncTimer = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            loadData();
            loadSettings();
            loadSheetConfig();
            setupMobileView();
            
            // Set up event listeners
            document.getElementById('searchInput').addEventListener('input', filterDashboard);
            document.getElementById('masterSearch').addEventListener('input', filterMasterTable);
            
            // Enhanced form event listeners with retry mechanism
            setupFormEventListeners();
            
            function setupFormEventListeners() {
                console.log('üîß Setting up form event listeners...');
                
                // Setup subscription form with retry
                let retryCount = 0;
                const maxRetries = 5;
                
                function setupSubscriptionForm() {
                    const subscriptionForm = document.getElementById('subscriptionForm');
                    
                    if (subscriptionForm) {
                        console.log('‚úÖ Subscription form found, attaching event listener');
                        
                        // Remove any existing listeners to prevent duplicates
                        subscriptionForm.removeEventListener('submit', handleSubmit);
                        
                        // Add the event listener
                        subscriptionForm.addEventListener('submit', handleSubmit);
                        
                        // Test the form submission
                        console.log('üß™ Testing form submission setup...');
                        
                        return true;
                    } else {
                        console.warn(`‚ö†Ô∏è Subscription form not found (attempt ${retryCount + 1}/${maxRetries})`);
                        
                        if (retryCount < maxRetries) {
                            retryCount++;
                            setTimeout(setupSubscriptionForm, 500);
                        } else {
                            console.error('‚ùå Failed to find subscription form after maximum retries');
                            showNotification('‚ö†Ô∏è ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡•á‡§ü‡§Ö‡§™ ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ! Form setup issue detected!', 'error');
                        }
                        return false;
                    }
                }
                
                // Setup renewal form
                function setupRenewalForm() {
                    const renewalForm = document.getElementById('renewalForm');
                    
                    if (renewalForm) {
                        console.log('‚úÖ Renewal form found, attaching event listener');
                        renewalForm.removeEventListener('submit', handleRenewal);
                        renewalForm.addEventListener('submit', handleRenewal);
                    } else {
                        console.warn('‚ö†Ô∏è Renewal form not found, will retry later');
                        setTimeout(setupRenewalForm, 1000);
                    }
                }
                
                // Start setup
                setupSubscriptionForm();
                setupRenewalForm();
            }

            // Initialize Google Sheets sync
            initializeGoogleSheets();
            
            // Check if running from file:// protocol and show info
            if (window.location.protocol === 'file:') {
                console.log('üìÅ Running from local file - enhanced sync methods available');
                // Don't show warning immediately, let user try sync first
                setTimeout(() => {
                    if (sheetConfig.scriptConnected) {
                        console.log('üîÑ File protocol detected, but Apps Script sync may still work via JSONP');
                        // Try auto sync with enhanced methods
                        autoSyncOnLoad();
                    }
                }, 2000);
            } else {
                // Auto sync on load for web protocols
                autoSyncOnLoad();
            }

            // Show appropriate loading message based on protocol
            if (window.location.protocol === 'file:') {
                showNotification('üöÄ Subscription Manager loaded! File mode - JSONP sync available for Google Sheets.', 'success');
            } else {
                showNotification('üöÄ Subscription Manager loaded successfully!', 'success');
            }
        });

        // Mobile view setup
        function setupMobileView() {
            // Auto-enable card view on mobile screens
            function checkScreenSize() {
                const isMobile = window.innerWidth <= 640;
                
                if (isMobile) {
                    // Auto-enable card view for all tables on mobile
                    const containers = [
                        document.getElementById('dashboardTableContainer'),
                        document.getElementById('masterTableContainer'),
                        document.getElementById('warningTableContainer')
                    ];
                    
                    containers.forEach(container => {
                        if (container && !container.classList.contains('show-mobile-cards')) {
                            container.classList.add('show-mobile-cards');
                        }
                    });
                    
                    // Update button text
                    const buttons = [
                        document.getElementById('toggleViewBtn'),
                        document.getElementById('toggleMasterViewBtn'),
                        document.getElementById('toggleWarningViewBtn')
                    ];
                    
                    buttons.forEach(btn => {
                        if (btn) {
                            btn.innerHTML = 'üìä Table View';
                        }
                    });
                    
                    // Update card views
                    updateMobileCards('dashboard');
                    updateMobileCards('master');
                    updateMobileCards('warning');
                }
            }
            
            checkScreenSize();
            window.addEventListener('resize', checkScreenSize);
        }

        // Toggle between table and card view
        function toggleMobileView(tableType) {
            const containers = {
                dashboard: document.getElementById('dashboardTableContainer'),
                master: document.getElementById('masterTableContainer'),
                warning: document.getElementById('warningTableContainer')
            };
            
            const buttons = {
                dashboard: document.getElementById('toggleViewBtn'),
                master: document.getElementById('toggleMasterViewBtn'),
                warning: document.getElementById('toggleWarningViewBtn')
            };
            
            const container = containers[tableType];
            const button = buttons[tableType];
            
            if (container && button) {
                const isCardView = container.classList.contains('show-mobile-cards');
                
                if (isCardView) {
                    // Switch to table view
                    container.classList.remove('show-mobile-cards');
                    button.innerHTML = 'üì± Card View';
                } else {
                    // Switch to card view
                    container.classList.add('show-mobile-cards');
                    button.innerHTML = 'üìä Table View';
                    
                    // Update card view content
                    updateMobileCards(tableType);
                }
            }
        }

        // Update mobile card views
        function updateMobileCards(tableType) {
            switch(tableType) {
                case 'dashboard':
                    updateDashboardCards();
                    break;
                case 'master':
                    updateMasterCards();
                    break;
                case 'warning':
                    updateWarningCards();
                    break;
            }
        }

        // Update dashboard cards
        function updateDashboardCards() {
            const cardsContainer = document.getElementById('dashboardCards');
            
            if (subscriptions.length === 0) {
                cardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #64748b; font-size: 1.1rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                        <p>No subscriptions found</p>
                    </div>
                `;
                return;
            }

            cardsContainer.innerHTML = subscriptions.map(sub => `
                <div class="mobile-card">
                    <div class="mobile-card-header">
                        <h3 class="mobile-card-title">${escapeHtml(sub.companyName)}</h3>
                        ${getStatusBadge(sub)}
                    </div>
                    <div class="mobile-card-body">
                        <div class="mobile-card-field">
                            <div class="mobile-card-label">‚úâÔ∏è Email</div>
                            <div class="mobile-card-value">${escapeHtml(sub.emailId)}</div>
                        </div>
                        <div class="mobile-card-field">
                            <div class="mobile-card-label">üîñ Sub ID</div>
                            <div class="mobile-card-value">${escapeHtml(sub.subscriptionId)}</div>
                        </div>
                        <div class="mobile-card-field">
                            <div class="mobile-card-label">üìã Model</div>
                            <div class="mobile-card-value">${escapeHtml(sub.model)}</div>
                        </div>
                        <div class="mobile-card-field">
                            <div class="mobile-card-label">üìÜ Expiry</div>
                            <div class="mobile-card-value">${formatDate(sub.expiryDate)}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update master cards
        function updateMasterCards() {
            const cardsContainer = document.getElementById('masterCards');
            
            if (subscriptions.length === 0) {
                cardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #64748b; font-size: 1.1rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                        <p>No subscriptions added yet</p>
                    </div>
                `;
                return;
            }

            cardsContainer.innerHTML = subscriptions.map((sub, index) => `
                <div class="mobile-card">
                    <div class="mobile-card-header">
                        <h3 class="mobile-card-title">${escapeHtml(sub.companyName)}</h3>
                        ${getStatusBadge(sub)}
                    </div>
                    <div class="mobile-card-body">
                        <div class="mobile-card-field">
                            <div class="mobile-card-label">üìû Mobile</div>
                            <div class="mobile-card-value">${escapeHtml(sub.mobileNo)}</div>
                        </div>
                        <div class="mobile-card-field">
                            <div class="mobile-card-label">‚úâÔ∏è Email</div>
                            <div class="mobile-card-value">${escapeHtml(sub.emailId)}</div>
                        </div>
                        <div class="mobile-card-field" style="grid-column: 1 / -1;">
                            <div class="mobile-card-label">üîñ Subscription ID</div>
                            <div class="mobile-card-value">${escapeHtml(sub.subscriptionId)}</div>
                        </div>
                    </div>
                    <div class="mobile-card-actions">
                        <button onclick="editSubscription(${index})" class="btn btn-primary">
                            ‚úèÔ∏è Edit
                        </button>
                        <button onclick="deleteSubscription(${index})" class="btn btn-danger">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update warning cards
        function updateWarningCards() {
            const cardsContainer = document.getElementById('warningCards');
            const now = new Date();
            const warningDate = new Date(now.getTime() + (settings.warningDays * 24 * 60 * 60 * 1000));
            
            const warningSubs = subscriptions.filter(sub => {
                const expiryDate = new Date(sub.expiryDate);
                return expiryDate <= warningDate;
            });
            
            if (warningSubs.length === 0) {
                cardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #64748b; font-size: 1.1rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                        <p>No subscriptions expiring soon</p>
                    </div>
                `;
                return;
            }

            cardsContainer.innerHTML = warningSubs.map(sub => `
                <div class="mobile-card">
                    <div class="mobile-card-header">
                        <h3 class="mobile-card-title">${escapeHtml(sub.companyName)}</h3>
                        ${getStatusBadge(sub)}
                    </div>
                    <div class="mobile-card-body">
                        <div class="mobile-card-field">
                            <div class="mobile-card-label">üîñ Sub ID</div>
                            <div class="mobile-card-value">${escapeHtml(sub.subscriptionId)}</div>
                        </div>
                        <div class="mobile-card-field">
                            <div class="mobile-card-label">üìã Model</div>
                            <div class="mobile-card-value">${escapeHtml(sub.model)}</div>
                        </div>
                        <div class="mobile-card-field">
                            <div class="mobile-card-label">üìÜ Expiry</div>
                            <div class="mobile-card-value">${formatDate(sub.expiryDate)}</div>
                        </div>
                        <div class="mobile-card-field">
                            <div class="mobile-card-label">üìû Contact</div>
                            <div class="mobile-card-value">${escapeHtml(sub.mobileNo)}</div>
                        </div>
                    </div>
                    <div class="mobile-card-actions">
                        <button onclick="sendWhatsAppMessage('${escapeHtml(sub.subscriptionId)}')" 
                                class="btn btn-success" 
                                style="background: linear-gradient(135deg, #25d366, #128c7e);">
                            üì± WhatsApp
                        </button>
                        <button onclick="renewSubscriptionFromWarning('${escapeHtml(sub.subscriptionId)}')" 
                                class="btn btn-primary">
                            üîÑ Renew
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Load data from localStorage
        function loadData() {
            try {
                const data = localStorage.getItem('subscriptions');
                if (data) {
                    subscriptions = JSON.parse(data);
                    updateAllViews();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Error loading saved data. Starting fresh.', 'error');
                subscriptions = [];
            }
        }

        // Load settings
        function loadSettings() {
            try {
                const data = localStorage.getItem('appSettings');
                if (data) {
                    settings = { ...settings, ...JSON.parse(data) };
                }
                document.getElementById('warningDays').value = settings.warningDays;
                
                // Load message templates
                if (settings.messageTemplates) {
                    document.getElementById('expiredTemplate').value = settings.messageTemplates.expired;
                    document.getElementById('expiringSoonTemplate').value = settings.messageTemplates.expiringSoon;
                } else {
                    // Set default templates
                    const defaultTemplates = getDefaultMessageTemplates();
                    document.getElementById('expiredTemplate').value = defaultTemplates.expired;
                    document.getElementById('expiringSoonTemplate').value = defaultTemplates.expiringSoon;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                showNotification('Error loading settings. Using defaults.', 'error');
            }
        }

        // Save data to localStorage
        function saveData() {
            try {
                console.log('Saving data to localStorage...', subscriptions.length, 'records');
                localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
                console.log('Data saved successfully to localStorage');
                updateAllViews();
                console.log('All views updated');
            } catch (error) {
                console.error('Error saving data:', error);
                showNotification('‚ùå ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø! Error saving data. Please try again.', 'error');
            }
        }

        // Save settings
        function saveSettings() {
            try {
                localStorage.setItem('appSettings', JSON.stringify(settings));
            } catch (error) {
                console.error('Error saving settings:', error);
                showNotification('Error saving settings. Please try again.', 'error');
            }
        }

        // Update current date
        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('hi-IN');
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to selected button
            const activeBtn = document.getElementById(tabName + '-tab');
            activeBtn.classList.add('active');
            
            // Update views when switching tabs
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'renewal') {
                updateRenewalDropdown();
                updateWarningList();
            }
        }

        // Form management
        function toggleForm() {
            const form = document.getElementById('masterForm');
            const btn = document.getElementById('addBtn');
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.textContent = '‚ùå Cancel';
                // Hide bulk import section if open
                const bulkSection = document.getElementById('bulkImportSection');
                if (!bulkSection.classList.contains('hidden')) {
                    toggleBulkImport();
                }
            } else {
                form.classList.add('hidden');
                btn.textContent = '‚ûï Add New Subscription';
                clearForm();
            }
        }

        function toggleBulkImport() {
            const bulkSection = document.getElementById('bulkImportSection');
            const btn = document.getElementById('bulkBtn');
            
            if (bulkSection.classList.contains('hidden')) {
                bulkSection.classList.remove('hidden');
                btn.textContent = '‚ùå Cancel';
                // Hide form if open
                const form = document.getElementById('masterForm');
                if (!form.classList.contains('hidden')) {
                    toggleForm();
                }
            } else {
                bulkSection.classList.add('hidden');
                btn.textContent = 'üìä Bulk Import/Export';
            }
        }

        function clearForm() {
            document.getElementById('subscriptionForm').reset();
            editingIndex = -1;
        }

        // Handle form submission with enhanced error handling
        function handleSubmit(e) {
            e.preventDefault();
            
            console.log('üöÄ Form submission started...');
            
            try {
                // Get form elements with null checks
                const companyNameEl = document.getElementById('companyName');
                const mobileNoEl = document.getElementById('mobileNo');
                const emailIdEl = document.getElementById('emailId');
                const subscriptionIdEl = document.getElementById('subscriptionId');
                const modelEl = document.getElementById('model');
                const startingDateEl = document.getElementById('startingDate');
                const expiryDateEl = document.getElementById('expiryDate');
                const remarksEl = document.getElementById('remarks');
                
                // Check if all form elements exist
                if (!companyNameEl || !mobileNoEl || !emailIdEl || !subscriptionIdEl || 
                    !modelEl || !startingDateEl || !expiryDateEl) {
                    console.error('‚ùå Form elements not found!');
                    showNotification('‚ùå ‡§´‡•â‡§∞‡•ç‡§Æ ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü‡•ç‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á! Form elements not found!', 'error');
                    return;
                }
                
                const formData = {
                    companyName: companyNameEl.value.trim(),
                    mobileNo: mobileNoEl.value.trim(),
                    emailId: emailIdEl.value.trim(),
                    subscriptionId: subscriptionIdEl.value.trim(),
                    model: modelEl.value.trim(),
                    startingDate: startingDateEl.value,
                    expiryDate: expiryDateEl.value,
                    remarks: remarksEl ? remarksEl.value.trim() : '',
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };

                console.log('üìù Form data collected:', formData);

                // Validate required fields
                if (!formData.companyName || !formData.mobileNo || !formData.emailId || 
                    !formData.subscriptionId || !formData.model || !formData.startingDate || !formData.expiryDate) {
                    console.log('‚ùå Required fields missing');
                    showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç! Please fill all required fields!', 'error');
                    return;
                }

                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(formData.emailId)) {
                    console.log('‚ùå Invalid email format');
                    showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡•à‡§ß ‡§à‡§Æ‡•á‡§≤ ‡§™‡§§‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç! Please enter a valid email address!', 'error');
                    return;
                }

                // Validate mobile number
                const cleanMobile = formData.mobileNo.replace(/\D/g, '');
                if (cleanMobile.length !== 10) {
                    console.log('‚ùå Invalid mobile number');
                    showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡•à‡§ß 10-‡§Ö‡§Ç‡§ï‡•Ä‡§Ø ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç! Please enter a valid 10-digit mobile number!', 'error');
                    return;
                }

                // Validate dates
                const startDate = new Date(formData.startingDate);
                const endDate = new Date(formData.expiryDate);
                if (endDate <= startDate) {
                    console.log('‚ùå Invalid date range');
                    showNotification('‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡§ø ‡§§‡§ø‡§•‡§ø ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠ ‡§§‡§ø‡§•‡§ø ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è! Expiry date must be after starting date!', 'error');
                    return;
                }

                // Initialize subscriptions array if it doesn't exist
                if (!Array.isArray(subscriptions)) {
                    console.log('üîß Initializing subscriptions array');
                    subscriptions = [];
                }

                // Check for duplicate subscription ID
                const existingIndex = subscriptions.findIndex((sub, index) => 
                    sub && sub.subscriptionId === formData.subscriptionId && index !== editingIndex
                );
                
                if (existingIndex !== -1) {
                    console.log('‚ùå Duplicate subscription ID found');
                    showNotification('‡§∏‡§¨‡•ç‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ID ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à! Subscription ID already exists!', 'error');
                    return;
                }

                console.log('‚úÖ Validation passed, saving data...');

                // Save the data
                if (editingIndex >= 0 && editingIndex < subscriptions.length) {
                    console.log('üìù Updating existing subscription at index:', editingIndex);
                    subscriptions[editingIndex] = { ...subscriptions[editingIndex], ...formData };
                    showNotification('‚úÖ ‡§∏‡§¨‡•ç‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ! Subscription updated successfully!', 'success');
                    editingIndex = -1;
                } else {
                    console.log('‚ûï Adding new subscription');
                    subscriptions.push(formData);
                    showNotification('‚úÖ ‡§∏‡§¨‡•ç‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ! Subscription added successfully!', 'success');
                }
                
                console.log('üíæ Data saved, total subscriptions:', subscriptions.length);
                
                // Save data with immediate database sync for form submissions
                saveDataWithDatabaseSync();
                clearForm();
                toggleForm();
                
                console.log('üéâ Form submission completed successfully!');
                
            } catch (error) {
                console.error('‚ùå Critical error in handleSubmit:', error);
                showNotification('‚ùå ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø! Critical error occurred: ' + error.message, 'error');
            }
        }

        // Handle renewal
        function handleRenewal(e) {
            e.preventDefault();
            
            console.log('üîÑ Renewal form submission started...');
            
            try {
                const input = document.getElementById('renewalSubId');
                const subId = input.getAttribute('data-sub-id');
                const newExpiry = document.getElementById('newExpiryDate').value;
                
                console.log('üìù Renewal data:', { subId, newExpiry });
                
                if (!subId) {
                    console.log('‚ùå No subscription ID selected');
                    showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§¨‡•ç‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ID ‡§ö‡•Å‡§®‡•á‡§Ç! Please select a subscription ID!', 'error');
                    return;
                }

                if (!newExpiry) {
                    console.log('‚ùå No expiry date selected');
                    showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§à ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡§ø ‡§§‡§ø‡§•‡§ø ‡§ö‡•Å‡§®‡•á‡§Ç! Please select a new expiry date!', 'error');
                    return;
                }

                // Validate that new expiry date is in the future
                const today = new Date();
                const newExpiryDate = new Date(newExpiry);
                if (newExpiryDate <= today) {
                    console.log('‚ùå Invalid expiry date - not in future');
                    showNotification('‡§®‡§à ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡§ø ‡§§‡§ø‡§•‡§ø ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§Æ‡•á‡§Ç ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è! New expiry date must be in the future!', 'error');
                    return;
                }
                
                // Find and update subscription
                const index = subscriptions.findIndex(sub => sub.subscriptionId === subId);
                console.log('üîç Found subscription at index:', index);
                
                if (index !== -1) {
                    const oldExpiry = subscriptions[index].expiryDate;
                    const companyName = subscriptions[index].companyName;
                    
                    // Update subscription
                    subscriptions[index].expiryDate = newExpiry;
                    subscriptions[index].lastModified = new Date().toISOString();
                    
                    console.log('‚úÖ Subscription updated:', subscriptions[index]);
                    
                    // Save data with immediate database sync for renewals
                    saveDataWithDatabaseSync();
                    
                    // Clear form and reset UI
                    clearRenewalForm();
                    
                    // Show success notification with sync status
                    if (sheetConfig.scriptConnected) {
                        showNotification(`üîÑ ${companyName} ‡§ï‡§æ ‡§∏‡§¨‡•ç‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§∞‡§ø‡§®‡•ç‡§Ø‡•Ç ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§î‡§∞ ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡§ø‡§Ç‡§ï ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à! Renewed and syncing to database!`, 'success');
                    } else {
                        showNotification(`üîÑ ${companyName} ‡§ï‡§æ ‡§∏‡§¨‡•ç‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§∞‡§ø‡§®‡•ç‡§Ø‡•Ç ‡§π‡•ã ‡§ó‡§Ø‡§æ! Renewed from ${formatDate(oldExpiry)} to ${formatDate(newExpiry)}`, 'success');
                    }
                    
                    console.log('üéâ Renewal completed successfully');
                    
                } else {
                    console.log('‚ùå Subscription not found');
                    showNotification('‡§∏‡§¨‡•ç‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ! Subscription not found!', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Critical error in handleRenewal:', error);
                showNotification('‚ùå ‡§∞‡§ø‡§®‡•ç‡§Ø‡•Ç‡§Ö‡§≤ ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø! Renewal error: ' + error.message, 'error');
            }
        }

        // Clear renewal form
        function clearRenewalForm() {
            console.log('üßπ Clearing renewal form...');
            
            try {
                // Reset form
                const renewalForm = document.getElementById('renewalForm');
                if (renewalForm) {
                    renewalForm.reset();
                }
                
                // Clear subscription selection
                const renewalInput = document.getElementById('renewalSubId');
                if (renewalInput) {
                    renewalInput.value = '';
                    renewalInput.removeAttribute('data-sub-id');
                }
                
                // Hide selected details
                const selectedDetails = document.getElementById('selectedDetails');
                if (selectedDetails) {
                    selectedDetails.classList.add('hidden');
                }
                
                // Hide duration info
                const durationInfo = document.getElementById('durationInfo');
                if (durationInfo) {
                    durationInfo.classList.add('hidden');
                }
                
                // Hide renewal summary
                const renewalSummary = document.getElementById('renewalSummary');
                if (renewalSummary) {
                    renewalSummary.classList.add('hidden');
                }
                
                // Reset step indicators
                const step1 = document.getElementById('step1');
                const step2 = document.getElementById('step2');
                
                if (step1) {
                    step1.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    step1.style.color = 'white';
                    step1.style.boxShadow = '0 4px 15px rgba(16, 185, 129, 0.3)';
                }
                
                if (step2) {
                    step2.style.background = '#e5e7eb';
                    step2.style.color = '#6b7280';
                    step2.style.boxShadow = 'none';
                }
                
                console.log('‚úÖ Renewal form cleared successfully');
                
            } catch (error) {
                console.error('‚ùå Error clearing renewal form:', error);
            }
        }

        // Edit subscription
        function editSubscription(index) {
            console.log('‚úèÔ∏è Editing subscription at index:', index);
            
            if (index < 0 || index >= subscriptions.length) {
                console.error('‚ùå Invalid subscription index:', index);
                showNotification('‚ùå ‡§∏‡§¨‡•ç‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ! Subscription not found!', 'error');
                return;
            }
            
            const sub = subscriptions[index];
            console.log('üìù Subscription data:', sub);
            
            try {
                // Fill form with validation and proper date formatting
                const fields = {
                    companyName: sub.companyName || '',
                    mobileNo: sub.mobileNo || '',
                    emailId: sub.emailId || '',
                    subscriptionId: sub.subscriptionId || '',
                    model: sub.model || '',
                    startingDate: formatDateForInput(sub.startingDate) || '',
                    expiryDate: formatDateForInput(sub.expiryDate) || '',
                    remarks: sub.remarks || ''
                };
                
                console.log('üìÖ Formatted dates for input:', {
                    original: { startingDate: sub.startingDate, expiryDate: sub.expiryDate },
                    formatted: { startingDate: fields.startingDate, expiryDate: fields.expiryDate }
                });
                
                Object.keys(fields).forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = fields[fieldId];
                        console.log(`‚úÖ Set ${fieldId}: ${fields[fieldId]}`);
                        
                        // Trigger change event for date fields to ensure proper display
                        if (fieldId.includes('Date') && fields[fieldId]) {
                            element.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è Field not found: ${fieldId}`);
                    }
                });
                
                editingIndex = index;
                console.log('üìù Set editing index to:', editingIndex);
                
                // Show form
                const masterForm = document.getElementById('masterForm');
                const addBtn = document.getElementById('addBtn');
                
                if (masterForm && addBtn) {
                    masterForm.classList.remove('hidden');
                    addBtn.innerHTML = '‚ùå Cancel Edit';
                    
                    // Update form progress
                    updateFormProgress();
                    
                    // Scroll to form
                    masterForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Focus on first field
                    setTimeout(() => {
                        const firstField = document.getElementById('companyName');
                        if (firstField) {
                            firstField.focus();
                        }
                    }, 300);
                    
                    showNotification(`‚úèÔ∏è ${sub.companyName} ‡§ï‡•ã ‡§è‡§°‡§ø‡§ü ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç! Editing ${sub.companyName}`, 'success');
                } else {
                    console.error('‚ùå Form elements not found');
                    showNotification('‚ùå ‡§´‡•â‡§∞‡•ç‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ! Form not found!', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Error in editSubscription:', error);
                showNotification('‚ùå ‡§è‡§°‡§ø‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø! Error editing subscription!', 'error');
            }
        }

        // Format date for HTML input fields (YYYY-MM-DD)
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            
            try {
                // If already in YYYY-MM-DD format, return as is
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                    return dateString;
                }
                
                // Try to parse different date formats
                let date;
                
                // Try DD/MM/YYYY format
                const ddmmMatch = dateString.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
                if (ddmmMatch) {
                    const day = parseInt(ddmmMatch[1]);
                    const month = parseInt(ddmmMatch[2]) - 1; // Month is 0-indexed
                    const year = parseInt(ddmmMatch[3]);
                    date = new Date(year, month, day);
                } else {
                    // Try general date parsing
                    date = new Date(dateString);
                }
                
                // Validate the date
                if (isNaN(date.getTime())) {
                    console.warn('‚ö†Ô∏è Invalid date format:', dateString);
                    return '';
                }
                
                // Format as YYYY-MM-DD for HTML input
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                
                const formattedDate = `${year}-${month}-${day}`;
                console.log(`üìÖ Date conversion: ${dateString} ‚Üí ${formattedDate}`);
                
                return formattedDate;
                
            } catch (error) {
                console.error('‚ùå Error formatting date:', dateString, error);
                return '';
            }
        }

        // Delete subscription
        function deleteSubscription(index) {
            console.log('üóëÔ∏è Deleting subscription at index:', index);
            
            // Validate index with detailed logging
            if (typeof index !== 'number') {
                console.error('‚ùå Invalid index type:', typeof index, 'Value:', index);
                showNotification('‚ùå ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø! Invalid index type!', 'error');
                return;
            }
            
            if (index < 0 || index >= subscriptions.length) {
                console.error('‚ùå Index out of bounds:', index, 'Array length:', subscriptions.length);
                showNotification('‚ùå ‡§∏‡§¨‡•ç‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ! Subscription not found!', 'error');
                return;
            }
            
            const sub = subscriptions[index];
            if (!sub) {
                console.error('‚ùå Subscription is null/undefined at index:', index);
                showNotification('‚ùå ‡§∏‡§¨‡•ç‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ! Subscription data not found!', 'error');
                return;
            }
            
            console.log('üóëÔ∏è Subscription to delete:', sub);
            
            try {
                // Show enhanced confirmation modal
                const modal = document.getElementById('confirmModal');
                if (!modal) {
                    console.error('‚ùå Confirmation modal not found');
                    showNotification('‚ùå ‡§Æ‡•â‡§°‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ! Modal not found!', 'error');
                    return;
                }
                
                const modalContent = modal.querySelector('.modal-content');
                if (!modalContent) {
                    console.error('‚ùå Modal content not found');
                    showNotification('‚ùå ‡§Æ‡•â‡§°‡§≤ ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ! Modal content not found!', 'error');
                    return;
                }
                
                // Safely get subscription properties
                const companyName = sub.companyName || 'Unknown Company';
                const emailId = sub.emailId || 'No Email';
                const subscriptionId = sub.subscriptionId || 'No ID';
                const model = sub.model || 'No Model';
                
                modalContent.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 1rem; color: #ef4444;">üóëÔ∏è</div>
                    <h3 style="font-size: 1.25rem; font-weight: 700; color: #ef4444; margin-bottom: 1rem;">Delete Subscription</h3>
                    <div style="background: #fee2e2; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 2px solid #fecaca;">
                        <p style="color: #991b1b; font-weight: 600; margin: 0 0 1rem 0;">Are you sure you want to delete this subscription?</p>
                        <div style="background: white; padding: 1rem; border-radius: 6px; margin: 1rem 0;">
                            <div style="font-weight: 700; color: #374151; margin-bottom: 0.5rem;">üè¢ ${escapeHtml(companyName)}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">üìß ${escapeHtml(emailId)}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">üîñ ${escapeHtml(subscriptionId)}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">üìã ${escapeHtml(model)}</div>
                        </div>
                        <p style="color: #991b1b; font-weight: 700; margin: 1rem 0 0 0;">‚ö†Ô∏è This action cannot be undone!</p>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                        <button onclick="performDeleteSubscription(${index})" class="btn btn-danger" style="background: linear-gradient(135deg, #ef4444, #dc2626); font-weight: 700;">
                            üóëÔ∏è Yes, Delete
                        </button>
                        <button onclick="hideConfirmModal()" class="btn btn-success">
                            ‚ùå Cancel
                        </button>
                    </div>
                `;
                
                modal.classList.add('show');
                console.log('‚úÖ Delete confirmation modal shown');
                
            } catch (error) {
                console.error('‚ùå Critical error in deleteSubscription:', error);
                showNotification('‚ùå ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø! Critical delete error: ' + error.message, 'error');
            }
        }
        
        // Perform delete subscription with database sync
        function performDeleteSubscription(index) {
            console.log('‚úÖ Performing delete for index:', index);
            
            try {
                // Validate index with enhanced checks
                if (typeof index !== 'number') {
                    console.error('‚ùå Invalid index type for deletion:', typeof index, 'Value:', index);
                    showNotification('‚ùå ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø! Invalid index type!', 'error');
                    hideConfirmModal();
                    return;
                }
                
                if (index < 0 || index >= subscriptions.length) {
                    console.error('‚ùå Index out of bounds for deletion:', index, 'Array length:', subscriptions.length);
                    showNotification('‚ùå ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø! Index out of bounds!', 'error');
                    hideConfirmModal();
                    return;
                }
                
                // Check if subscriptions array is valid
                if (!Array.isArray(subscriptions)) {
                    console.error('‚ùå Subscriptions is not an array:', typeof subscriptions);
                    showNotification('‚ùå ‡§°‡•á‡§ü‡§æ ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ï‡•ç‡§ö‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø! Data structure error!', 'error');
                    hideConfirmModal();
                    return;
                }
                
                const deletedSub = subscriptions[index];
                if (!deletedSub) {
                    console.error('‚ùå Subscription not found at index:', index);
                    showNotification('‚ùå ‡§∏‡§¨‡•ç‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ! Subscription not found!', 'error');
                    hideConfirmModal();
                    return;
                }
                
                console.log('üóëÔ∏è Deleting subscription:', deletedSub);
                
                // Create a new array without the deleted item (safer than splice)
                const newSubscriptions = subscriptions.filter((_, i) => i !== index);
                console.log('‚úÖ Created new array. Old length:', subscriptions.length, 'New length:', newSubscriptions.length);
                
                // Update the global array
                subscriptions = newSubscriptions;
                
                // Save data with database sync
                saveDataWithDatabaseSync();
                
                // Update all views
                updateAllViews();
                console.log('‚úÖ All views updated');
                
                // Hide modal
                hideConfirmModal();
                
                // Show success notification
                const companyName = deletedSub.companyName || 'Unknown Company';
                showNotification(`üóëÔ∏è ${companyName} ‡§ï‡§æ ‡§∏‡§¨‡•ç‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ! Deleted and synced to database!`, 'success');
                
                // Reset editing index if we were editing the deleted item
                if (editingIndex === index) {
                    editingIndex = -1;
                    clearForm();
                    const masterForm = document.getElementById('masterForm');
                    if (masterForm && !masterForm.classList.contains('hidden')) {
                        toggleForm();
                    }
                    console.log('‚úÖ Reset editing state');
                } else if (editingIndex > index) {
                    // Adjust editing index if it's after the deleted item
                    editingIndex--;
                    console.log('‚úÖ Adjusted editing index to:', editingIndex);
                }
                
                console.log('üéâ Delete operation completed successfully with database sync');
                
            } catch (error) {
                console.error('‚ùå Critical error in performDeleteSubscription:', error);
                console.error('‚ùå Error stack:', error.stack);
                showNotification('‚ùå ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø! Critical delete error: ' + error.message, 'error');
                hideConfirmModal();
                
                // Try to recover by reloading data
                try {
                    loadData();
                    console.log('üîÑ Attempted data recovery');
                } catch (recoveryError) {
                    console.error('‚ùå Recovery failed:', recoveryError);
                }
            }
        }
        
        // Legacy function for backward compatibility
        function confirmDeleteSubscription(index) {
            console.log('‚ö†Ô∏è Legacy confirmDeleteSubscription called, redirecting to performDeleteSubscription');
            performDeleteSubscription(index);
        }

        // Update all views
        function updateAllViews() {
            updateDashboard();
            updateMasterTable();
            updateRenewalDropdown();
            updateWarningList();
            updateMiniStats();
        }

        // Update mini stats in header
        function updateMiniStats() {
            const now = new Date();
            const warningDate = new Date(now.getTime() + (settings.warningDays * 24 * 60 * 60 * 1000));
            
            let active = 0, expiring = 0, expired = 0;
            
            subscriptions.forEach(sub => {
                const expiryDate = new Date(sub.expiryDate);
                if (expiryDate < now) {
                    expired++;
                } else if (expiryDate <= warningDate) {
                    expiring++;
                } else {
                    active++;
                }
            });
            
            document.getElementById('miniTotal').textContent = subscriptions.length;
            document.getElementById('miniActive').textContent = active;
            document.getElementById('miniExpiring').textContent = expiring;
            document.getElementById('miniExpired').textContent = expired;
        }

        // Update dashboard
        function updateDashboard() {
            updateStats();
            updateDashboardTable();
        }

        // Update stats
        function updateStats() {
            const now = new Date();
            const warningDate = new Date(now.getTime() + (settings.warningDays * 24 * 60 * 60 * 1000));
            
            let active = 0, expiring = 0, expired = 0;
            
            subscriptions.forEach(sub => {
                const expiryDate = new Date(sub.expiryDate);
                if (expiryDate < now) {
                    expired++;
                } else if (expiryDate <= warningDate) {
                    expiring++;
                } else {
                    active++;
                }
            });
            
            // Update numbers with animation
            animateNumber('totalSubs', subscriptions.length);
            animateNumber('activeSubs', active);
            animateNumber('expiringSubs', expiring);
            animateNumber('expiredSubs', expired);
            
            // Update expiring days text
            const expiringDaysText = document.getElementById('expiringDaysText');
            if (expiringDaysText) {
                expiringDaysText.textContent = `Within ${settings.warningDays} days`;
            }
        }

        // Animate number changes
        function animateNumber(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const currentValue = parseInt(element.textContent) || 0;
            
            if (currentValue === targetValue) return;
            
            const increment = targetValue > currentValue ? 1 : -1;
            const duration = Math.abs(targetValue - currentValue) * 50; // 50ms per number
            const steps = Math.abs(targetValue - currentValue);
            const stepDuration = Math.min(duration / steps, 100); // Max 100ms per step
            
            let current = currentValue;
            const timer = setInterval(() => {
                current += increment;
                element.textContent = current;
                
                if (current === targetValue) {
                    clearInterval(timer);
                }
            }, stepDuration);
        }

        // Update dashboard table
        function updateDashboardTable() {
            const tbody = document.getElementById('dashboardTable');
            
            if (subscriptions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center" style="padding: 3rem;"><div style="color: #64748b; font-size: 1.1rem;"><div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div><p>No subscriptions found</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = subscriptions.map(sub => `
                <tr>
                    <td>
                        <div class="table-cell-content expandable" onclick="toggleCellExpansion(this)" title="${escapeHtml(sub.companyName)}">
                            <strong>${escapeHtml(sub.companyName)}</strong>
                        </div>
                    </td>
                    <td>
                        <div class="table-cell-content expandable" onclick="toggleCellExpansion(this)" title="${escapeHtml(sub.emailId)}">
                            ${escapeHtml(sub.emailId)}
                        </div>
                    </td>
                    <td>
                        <div class="table-cell-content" title="${escapeHtml(sub.subscriptionId)}">
                            ${escapeHtml(sub.subscriptionId)}
                        </div>
                    </td>
                    <td>
                        <div class="table-cell-content expandable" onclick="toggleCellExpansion(this)" title="${escapeHtml(sub.model)}">
                            ${escapeHtml(sub.model)}
                        </div>
                    </td>
                    <td style="white-space: nowrap;">${formatDate(sub.expiryDate)}</td>
                    <td>${getStatusBadge(sub)}</td>
                </tr>
            `).join('');
        }

        // Security function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update master table
        function updateMasterTable() {
            const tbody = document.getElementById('masterTable');
            
            if (subscriptions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding: 3rem;"><div style="color: #64748b; font-size: 1.1rem;"><div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div><p>No subscriptions added yet</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = subscriptions.map((sub, index) => `
                <tr>
                    <td>
                        <div class="table-cell-content expandable" onclick="toggleCellExpansion(this)" title="${escapeHtml(sub.companyName)}">
                            <strong>${escapeHtml(sub.companyName)}</strong>
                        </div>
                    </td>
                    <td>
                        <div class="table-cell-content" title="${escapeHtml(sub.mobileNo)}">
                            ${escapeHtml(sub.mobileNo)}
                        </div>
                    </td>
                    <td>
                        <div class="table-cell-content expandable" onclick="toggleCellExpansion(this)" title="${escapeHtml(sub.emailId)}">
                            ${escapeHtml(sub.emailId)}
                        </div>
                    </td>
                    <td>
                        <div class="table-cell-content" title="${escapeHtml(sub.subscriptionId)}">
                            ${escapeHtml(sub.subscriptionId)}
                        </div>
                    </td>
                    <td>
                        <div class="mobile-actions">
                            <button onclick="editSubscription(${index})" 
                                    class="btn btn-primary btn-small">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="deleteSubscription(${index})" 
                                    class="btn btn-danger btn-small">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Enhanced Dropdown functionality with performance optimization
        let dropdownTimeout;
        let searchTimeout;
        let cachedDropdownHTML = '';
        let lastSearchTerm = '';

        function handleSearchInput() {
            handleSearchInputFast();
        }

        function handleSearchInputFast() {
            const searchTerm = document.getElementById('renewalSubId').value.toLowerCase();
            const searchCounter = document.getElementById('searchCounter');
            const searchLoader = document.getElementById('searchLoader');
            const searchStatus = document.getElementById('searchStatus');
            
            // Clear previous selection if user is typing
            document.getElementById('renewalSubId').removeAttribute('data-sub-id');
            document.getElementById('selectedDetails').classList.add('hidden');
            
            // Show instant feedback
            if (searchTerm.length > 0) {
                searchLoader.classList.remove('hidden');
                searchStatus.style.display = 'none';
            } else {
                searchLoader.classList.add('hidden');
                searchStatus.style.display = 'none';
            }
            
            // Debounce search for better performance
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                showDropdownFast();
                const filteredCount = filterDropdownOptionsFast(searchTerm);
                
                // Update search counter and status
                if (searchTerm.length > 0) {
                    searchLoader.classList.add('hidden');
                    if (filteredCount > 0) {
                        searchStatus.style.display = 'block';
                        searchCounter.textContent = `${filteredCount} found`;
                        searchCounter.style.color = '#10b981';
                    } else {
                        searchStatus.style.display = 'none';
                        searchCounter.textContent = 'No matches';
                        searchCounter.style.color = '#ef4444';
                    }
                } else {
                    searchCounter.textContent = `${subscriptions.length} total`;
                    searchCounter.style.color = '#6b7280';
                }
            }, 100); // Further reduced to 100ms for instant feel
        }

        function showDropdownFast() {
            const dropdown = document.getElementById('subscriptionDropdown');
            dropdown.classList.remove('hidden');
            
            // Only update if not cached or data changed
            if (!cachedDropdownHTML || subscriptions.length !== cachedDropdownHTML.split('dropdown-item').length - 1) {
                updateDropdownOptions();
            }
        }

        function showDropdown() {
            const dropdown = document.getElementById('subscriptionDropdown');
            dropdown.classList.remove('hidden');
            
            // Only update if not cached or data changed
            if (!cachedDropdownHTML || subscriptions.length !== cachedDropdownHTML.split('dropdown-item').length - 1) {
                updateDropdownOptions();
            }
        }

        function hideDropdownDelayed() {
            dropdownTimeout = setTimeout(() => {
                document.getElementById('subscriptionDropdown').classList.add('hidden');
            }, 150); // Reduced delay for faster hiding
        }

        function updateRenewalDropdown() {
            // Clear cache when data changes
            cachedDropdownHTML = '';
            lastSearchTerm = '';
            updateDropdownOptions();
        }

        function updateDropdownOptions() {
            const optionsContainer = document.getElementById('dropdownOptions');
            
            if (subscriptions.length === 0) {
                const emptyHTML = '<div class="dropdown-item" style="text-align: center; color: #6b7280; padding: 2rem;">No subscriptions available</div>';
                optionsContainer.innerHTML = emptyHTML;
                cachedDropdownHTML = emptyHTML;
                return;
            }
            
            // Use cached HTML if available
            if (cachedDropdownHTML && lastSearchTerm === '') {
                optionsContainer.innerHTML = cachedDropdownHTML;
                return;
            }
            
            // Build optimized dropdown HTML
            const dropdownHTML = subscriptions.map(sub => {
                const status = getSubscriptionStatus(sub);
                const statusColor = status === 'Expired' ? '#ef4444' : status === 'Expiring Soon' ? '#f59e0b' : '#10b981';
                
                return `
                    <div class="dropdown-item" onmousedown="selectSubscription('${escapeHtml(sub.subscriptionId)}', '${escapeHtml(sub.companyName)}')" 
                         style="padding: 0.75rem; border-bottom: 1px solid rgba(16, 185, 129, 0.1); cursor: pointer; transition: background 0.1s ease;"
                         onmouseover="this.style.background='rgba(16, 185, 129, 0.05)'" onmouseout="this.style.background='white'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: #374151; font-size: 0.9rem;">${escapeHtml(sub.subscriptionId)}</div>
                                <div style="font-size: 0.8rem; color: #6b7280; margin: 0.2rem 0;">${escapeHtml(sub.companyName)} - ${escapeHtml(sub.model)}</div>
                                <div style="font-size: 0.7rem; color: #9ca3af;">Expires: ${formatDate(sub.expiryDate)}</div>
                            </div>
                            <div style="padding: 0.2rem 0.6rem; background: ${statusColor}; color: white; border-radius: 10px; font-size: 0.65rem; font-weight: 600;">
                                ${status}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            optionsContainer.innerHTML = dropdownHTML;
            cachedDropdownHTML = dropdownHTML;
            lastSearchTerm = '';
        }

        function filterDropdownOptions(searchTerm = '') {
            return filterDropdownOptionsFast(searchTerm);
        }

        function filterDropdownOptionsFast(searchTerm = '') {
            const optionsContainer = document.getElementById('dropdownOptions');
            
            // If no search term, show all options
            if (!searchTerm) {
                if (lastSearchTerm !== '') {
                    updateDropdownOptions();
                    lastSearchTerm = '';
                }
                return subscriptions.length;
            }
            
            // Skip if same search term to avoid unnecessary re-rendering
            if (searchTerm === lastSearchTerm) {
                return optionsContainer.children.length;
            }
            
            // Fast filtering with optimized search
            const filteredSubs = subscriptions.filter(sub => {
                const searchLower = searchTerm;
                return sub.subscriptionId.toLowerCase().includes(searchLower) ||
                       sub.companyName.toLowerCase().includes(searchLower) ||
                       sub.model.toLowerCase().includes(searchLower);
            });
            
            if (filteredSubs.length === 0) {
                optionsContainer.innerHTML = '<div class="dropdown-item" style="text-align: center; color: #6b7280; padding: 2rem;">‚ùå No matching subscriptions found<br><small style="color: #9ca3af;">Try different search terms</small></div>';
                lastSearchTerm = searchTerm;
                return 0;
            }
            
            // Build filtered HTML quickly with enhanced styling
            const filteredHTML = filteredSubs.map(sub => {
                const status = getSubscriptionStatus(sub);
                const statusColor = status === 'Expired' ? '#ef4444' : status === 'Expiring Soon' ? '#f59e0b' : '#10b981';
                const statusIcon = status === 'Expired' ? '‚ùå' : status === 'Expiring Soon' ? '‚ö†Ô∏è' : '‚úÖ';
                
                // Highlight search term in results
                const highlightText = (text, term) => {
                    if (!term) return escapeHtml(text);
                    const regex = new RegExp(`(${term})`, 'gi');
                    return escapeHtml(text).replace(regex, '<mark style="background: #fef3c7; padding: 0.1rem 0.2rem; border-radius: 3px;">$1</mark>');
                };
                
                return `
                    <div class="dropdown-item" onmousedown="selectSubscription('${escapeHtml(sub.subscriptionId)}', '${escapeHtml(sub.companyName)}')" 
                         style="padding: 0.75rem; border-bottom: 1px solid rgba(16, 185, 129, 0.1); cursor: pointer; transition: all 0.1s ease; border-left: 3px solid ${statusColor};"
                         onmouseover="this.style.background='rgba(16, 185, 129, 0.05)'; this.style.transform='translateX(2px)'" 
                         onmouseout="this.style.background='white'; this.style.transform='translateX(0)'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #374151; font-size: 0.9rem;">${highlightText(sub.subscriptionId, searchTerm)}</div>
                                <div style="font-size: 0.8rem; color: #6b7280; margin: 0.2rem 0;">${highlightText(sub.companyName, searchTerm)} - ${highlightText(sub.model, searchTerm)}</div>
                                <div style="font-size: 0.7rem; color: #9ca3af;">üìÖ Expires: ${formatDate(sub.expiryDate)}</div>
                            </div>
                            <div style="padding: 0.3rem 0.7rem; background: ${statusColor}; color: white; border-radius: 12px; font-size: 0.65rem; font-weight: 600; display: flex; align-items: center; gap: 0.3rem;">
                                <span>${statusIcon}</span>
                                <span>${status}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            optionsContainer.innerHTML = filteredHTML;
            lastSearchTerm = searchTerm;
            return filteredSubs.length;
        }

        function selectSubscription(subId, companyName) {
            if (dropdownTimeout) {
                clearTimeout(dropdownTimeout);
            }
            
            console.log('üîÑ Selecting subscription:', subId, companyName);
            
            const input = document.getElementById('renewalSubId');
            input.value = `${subId} - ${companyName}`;
            input.setAttribute('data-sub-id', subId);
            
            // Hide dropdown immediately for faster response
            const dropdown = document.getElementById('subscriptionDropdown');
            dropdown.classList.add('hidden');
            
            // Show selected details immediately
            showSelectedDetails();
            
            // Update step indicator immediately
            updateRenewalStep();
            
            // Focus on next field with minimal delay
            setTimeout(() => {
                const expiryField = document.getElementById('newExpiryDate');
                if (expiryField) {
                    expiryField.focus();
                }
            }, 50); // Reduced from 100ms to 50ms
            
            // Show quick success feedback
            showNotification(`‚úÖ ${companyName} selected for renewal!`, 'success');
        }

        // Show selected subscription details
        function showSelectedDetails() {
            const input = document.getElementById('renewalSubId');
            const subId = input.getAttribute('data-sub-id');
            const detailsDiv = document.getElementById('selectedDetails');
            const contentDiv = document.getElementById('detailsContent');
            
            if (!subId) {
                detailsDiv.classList.add('hidden');
                return;
            }
            
            const sub = subscriptions.find(s => s.subscriptionId === subId);
            if (sub) {
                contentDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.875rem;">
                        <div><strong>Company:</strong> ${escapeHtml(sub.companyName)}</div>
                        <div><strong>Model:</strong> ${escapeHtml(sub.model)}</div>
                        <div><strong>Current Expiry:</strong> ${formatDate(sub.expiryDate)}</div>
                        <div><strong>Status:</strong> ${getSubscriptionStatus(sub)}</div>
                    </div>
                `;
                detailsDiv.classList.remove('hidden');
            }
        }

        // Update warning list
        function updateWarningList() {
            const now = new Date();
            const warningDate = new Date(now.getTime() + (settings.warningDays * 24 * 60 * 60 * 1000));
            
            const warningSubs = subscriptions.filter(sub => {
                const expiryDate = new Date(sub.expiryDate);
                return expiryDate <= warningDate;
            });
            
            const expiringSoon = warningSubs.filter(sub => new Date(sub.expiryDate) > now);
            const expired = warningSubs.filter(sub => new Date(sub.expiryDate) <= now);
            
            document.getElementById('warningSoon').textContent = expiringSoon.length;
            document.getElementById('warningExpired').textContent = expired.length;
            
            const tbody = document.getElementById('warningTable');
            
            if (warningSubs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center" style="padding: 3rem;"><div style="color: #64748b; font-size: 1.1rem;"><div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div><p>No subscriptions expiring soon</p></div></td></tr>';
                return;
            }
            
            tbody.innerHTML = warningSubs.map(sub => `
                <tr>
                    <td>
                        <div class="table-cell-content expandable" onclick="toggleCellExpansion(this)" title="${escapeHtml(sub.companyName)}">
                            <strong>${escapeHtml(sub.companyName)}</strong>
                        </div>
                    </td>
                    <td>
                        <div class="table-cell-content" title="${escapeHtml(sub.subscriptionId)}">
                            ${escapeHtml(sub.subscriptionId)}
                        </div>
                    </td>
                    <td>
                        <div class="table-cell-content expandable" onclick="toggleCellExpansion(this)" title="${escapeHtml(sub.model)}">
                            ${escapeHtml(sub.model)}
                        </div>
                    </td>
                    <td style="white-space: nowrap;">${formatDate(sub.expiryDate)}</td>
                    <td>${getStatusBadge(sub)}</td>
                    <td>
                        <div class="table-cell-content" title="${escapeHtml(sub.mobileNo)}">
                            ${escapeHtml(sub.mobileNo)}
                        </div>
                    </td>
                    <td>
                        <div class="mobile-actions">
                            <button onclick="sendWhatsAppMessage('${escapeHtml(sub.subscriptionId)}')" 
                                    class="btn btn-success btn-small" 
                                    style="background: linear-gradient(135deg, #25d366, #128c7e); border: none; display: flex; align-items: center; gap: 0.25rem; font-weight: 600;"
                                    title="Send WhatsApp message to ${escapeHtml(sub.companyName)}">
                                <span style="font-size: 1rem;">üì±</span>
                                <span>WhatsApp</span>
                            </button>
                            <button onclick="renewSubscriptionFromWarning('${escapeHtml(sub.subscriptionId)}')" 
                                    class="btn btn-primary btn-small">
                                üîÑ Renew
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Filter functions
        function filterDashboard() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const tbody = document.getElementById('dashboardTable');
            
            if (!searchTerm) {
                updateDashboardTable();
                return;
            }
            
            const filtered = subscriptions.filter(sub => 
                sub.companyName.toLowerCase().includes(searchTerm) ||
                sub.emailId.toLowerCase().includes(searchTerm) ||
                sub.subscriptionId.toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center" style="padding: 2rem; color: #6b7280;">No matching subscriptions found</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(sub => `
                <tr>
                    <td>
                        <div class="table-cell-content expandable" onclick="toggleCellExpansion(this)" title="${escapeHtml(sub.companyName)}">
                            <strong>${escapeHtml(sub.companyName)}</strong>
                        </div>
                    </td>
                    <td>
                        <div class="table-cell-content expandable" onclick="toggleCellExpansion(this)" title="${escapeHtml(sub.emailId)}">
                            ${escapeHtml(sub.emailId)}
                        </div>
                    </td>
                    <td>
                        <div class="table-cell-content" title="${escapeHtml(sub.subscriptionId)}">
                            ${escapeHtml(sub.subscriptionId)}
                        </div>
                    </td>
                    <td>
                        <div class="table-cell-content expandable" onclick="toggleCellExpansion(this)" title="${escapeHtml(sub.model)}">
                            ${escapeHtml(sub.model)}
                        </div>
                    </td>
                    <td style="white-space: nowrap;">${formatDate(sub.expiryDate)}</td>
                    <td>${getStatusBadge(sub)}</td>
                </tr>
            `).join('');
        }

        function filterMasterTable() {
            const searchTerm = document.getElementById('masterSearch').value.toLowerCase();
            const tbody = document.getElementById('masterTable');
            
            if (!searchTerm) {
                updateMasterTable();
                return;
            }
            
            const filtered = subscriptions.filter(sub => 
                sub.companyName.toLowerCase().includes(searchTerm) ||
                sub.emailId.toLowerCase().includes(searchTerm) ||
                sub.subscriptionId.toLowerCase().includes(searchTerm) ||
                sub.mobileNo.toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding: 2rem; color: #6b7280;">No matching subscriptions found</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map((sub) => {
                const index = subscriptions.findIndex(s => s.subscriptionId === sub.subscriptionId);
                return `
                    <tr>
                        <td>
                            <div class="table-cell-content expandable" onclick="toggleCellExpansion(this)" title="${escapeHtml(sub.companyName)}">
                                <strong>${escapeHtml(sub.companyName)}</strong>
                            </div>
                        </td>
                        <td>
                            <div class="table-cell-content" title="${escapeHtml(sub.mobileNo)}">
                                ${escapeHtml(sub.mobileNo)}
                            </div>
                        </td>
                        <td>
                            <div class="table-cell-content expandable" onclick="toggleCellExpansion(this)" title="${escapeHtml(sub.emailId)}">
                                ${escapeHtml(sub.emailId)}
                            </div>
                        </td>
                        <td>
                            <div class="table-cell-content" title="${escapeHtml(sub.subscriptionId)}">
                                ${escapeHtml(sub.subscriptionId)}
                            </div>
                        </td>
                        <td>
                            <div class="mobile-actions">
                                <button onclick="editSubscription(${index})" 
                                        class="btn btn-primary btn-small">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button onclick="deleteSubscription(${index})" 
                                        class="btn btn-danger btn-small">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Utility functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('hi-IN');
        }

        function getSubscriptionStatus(sub) {
            const now = new Date();
            const expiryDate = new Date(sub.expiryDate);
            const warningDate = new Date(now.getTime() + (settings.warningDays * 24 * 60 * 60 * 1000));
            
            if (expiryDate < now) {
                return 'Expired';
            } else if (expiryDate <= warningDate) {
                return 'Expiring Soon';
            } else {
                return 'Active';
            }
        }

        function getStatusBadge(sub) {
            const status = getSubscriptionStatus(sub);
            
            if (status === 'Expired') {
                return '<span class="status-badge status-expired">‚ùå Expired</span>';
            } else if (status === 'Expiring Soon') {
                return '<span class="status-badge status-expiring">‚ö†Ô∏è Expiring</span>';
            } else {
                return '<span class="status-badge status-active">‚úÖ Active</span>';
            }
        }

        // Settings functions
        function updateWarningDays() {
            const days = parseInt(document.getElementById('warningDays').value);
            if (days > 0) {
                settings.warningDays = days;
                saveSettings();
                updateAllViews();
                showNotification('Warning days updated successfully!', 'success');
            }
        }

        function saveMessageTemplates() {
            const expiredTemplate = document.getElementById('expiredTemplate').value.trim();
            const expiringSoonTemplate = document.getElementById('expiringSoonTemplate').value.trim();
            
            if (!expiredTemplate || !expiringSoonTemplate) {
                showNotification('Please fill both message templates!', 'error');
                return;
            }
            
            settings.messageTemplates = {
                expired: expiredTemplate,
                expiringSoon: expiringSoonTemplate
            };
            
            saveSettings();
            showNotification('Message templates saved successfully!', 'success');
        }

        function resetToDefaultTemplates() {
            const defaultTemplates = getDefaultMessageTemplates();
            document.getElementById('expiredTemplate').value = defaultTemplates.expired;
            document.getElementById('expiringSoonTemplate').value = defaultTemplates.expiringSoon;
            showNotification('Templates reset to default!', 'success');
        }

        function getDefaultMessageTemplates() {
            return {
                expired: `üö® *SUBSCRIPTION EXPIRED* üö®

Dear {COMPANY_NAME},

Your subscription has *EXPIRED* ‚ùå
üìã Subscription ID: *{SUB_ID}*
üìÖ Expired on: *{EXPIRY_DATE}*

‚ö†Ô∏è *Immediate Action Required*
Please renew your subscription to continue using our services.

üìû Contact us now for instant renewal
üí¨ Reply to this message for assistance

Thank you! üôè`,
                expiringSoon: `‚ö†Ô∏è *SUBSCRIPTION EXPIRING SOON* ‚ö†Ô∏è

Dear {COMPANY_NAME},

Your subscription is about to expire! ‚è∞
üìã Subscription ID: *{SUB_ID}*
üìÖ Expiry Date: *{EXPIRY_DATE}*

üîÑ *Renew Now* to avoid service interruption
‚úÖ Continue enjoying uninterrupted services

üìû Contact us today for renewal
üí¨ Reply to this message for assistance

Don't wait - Renew today! üöÄ`
            };
        }

        function previewTemplate(templateType) {
            const templateId = templateType === 'expired' ? 'expiredTemplate' : 'expiringSoonTemplate';
            const template = document.getElementById(templateId).value;
            
            if (!template.trim()) {
                showNotification('Template is empty!', 'error');
                return;
            }
            
            // Sample data for preview
            const sampleData = {
                companyName: 'ABC Company Ltd',
                subscriptionId: 'SUB001',
                expiryDate: '31/12/2024',
                model: 'Premium Plan',
                mobileNo: '9876543210',
                emailId: 'contact@abccompany.com'
            };
            
            // Replace placeholders
            const previewMessage = template
                .replace(/{COMPANY_NAME}/g, sampleData.companyName)
                .replace(/{SUB_ID}/g, sampleData.subscriptionId)
                .replace(/{EXPIRY_DATE}/g, sampleData.expiryDate)
                .replace(/{MODEL}/g, sampleData.model)
                .replace(/{MOBILE}/g, sampleData.mobileNo)
                .replace(/{EMAIL}/g, sampleData.emailId);
            
            // Show preview in modal
            showTemplatePreview(previewMessage, templateType);
        }

        function showTemplatePreview(message, templateType) {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            const titleColor = templateType === 'expired' ? '#dc2626' : '#f59e0b';
            const titleIcon = templateType === 'expired' ? 'üö®' : '‚ö†Ô∏è';
            const titleText = templateType === 'expired' ? 'Expired Template Preview' : 'Expiring Soon Template Preview';
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem;">${titleIcon}</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: ${titleColor}; margin-bottom: 1rem;">${titleText}</h3>
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; text-align: left; max-height: 400px; overflow-y: auto; border: 2px solid ${titleColor}20;">
                    <pre style="white-space: pre-wrap; font-family: inherit; margin: 0; font-size: 0.875rem; line-height: 1.5; color: #374151;">${message}</pre>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem;">
                    <button onclick="hideConfirmModal()" class="btn btn-primary">
                        ‚úÖ Close Preview
                    </button>
                    <button onclick="copyTemplateToClipboard('${message.replace(/'/g, "\\'")}'); hideConfirmModal();" class="btn btn-secondary">
                        üìã Copy Message
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        function copyTemplateToClipboard(message) {
            navigator.clipboard.writeText(message).then(() => {
                showNotification('Message copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy message!', 'error');
            });
        }

        function sendWhatsAppMessage(subscriptionId) {
            const sub = subscriptions.find(s => s.subscriptionId === subscriptionId);
            if (!sub) {
                showNotification('Subscription not found!', 'error');
                return;
            }

            const now = new Date();
            const expiryDate = new Date(sub.expiryDate);
            const isExpired = expiryDate < now;
            
            // Get message templates from settings
            const templates = settings.messageTemplates || getDefaultMessageTemplates();
            let messageTemplate = isExpired ? templates.expired : templates.expiringSoon;
            
            // Replace placeholders with actual data
            const message = messageTemplate
                .replace(/{COMPANY_NAME}/g, sub.companyName)
                .replace(/{SUB_ID}/g, sub.subscriptionId)
                .replace(/{EXPIRY_DATE}/g, formatDate(sub.expiryDate))
                .replace(/{MODEL}/g, sub.model)
                .replace(/{MOBILE}/g, sub.mobileNo)
                .replace(/{EMAIL}/g, sub.emailId);
            
            // Clean mobile number (remove any non-digits)
            const cleanMobile = sub.mobileNo.replace(/\D/g, '');
            
            // Validate mobile number
            if (cleanMobile.length !== 10) {
                showNotification('Invalid mobile number format!', 'error');
                return;
            }
            
            // Create WhatsApp URL
            const whatsappUrl = `https://wa.me/91${cleanMobile}?text=${encodeURIComponent(message)}`;
            
            // Open WhatsApp
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
            
            // Show success notification
            const statusText = isExpired ? 'expired' : 'expiring soon';
            showNotification(`WhatsApp message sent to ${sub.companyName} (${statusText})!`, 'success');
        }

        function renewSubscriptionFromWarning(subscriptionId) {
            // Switch to renewal tab
            showTab('renewal');
            
            // Set the subscription ID in renewal form
            const renewalInput = document.getElementById('renewalSubId');
            const sub = subscriptions.find(s => s.subscriptionId === subscriptionId);
            
            if (sub) {
                renewalInput.value = `${subscriptionId} - ${sub.companyName}`;
                renewalInput.setAttribute('data-sub-id', subscriptionId);
                showSelectedDetails();
                
                // Focus on the new expiry date field
                document.getElementById('newExpiryDate').focus();
            }
        }

        // Excel functions
        function exportToExcel() {
            if (subscriptions.length === 0) {
                showNotification('No data to export!', 'error');
                return;
            }

            // Create CSV content
            const headers = ['Company Name', 'Mobile No', 'Email ID', 'Subscription ID', 'Model', 'Starting Date', 'Expiry Date', 'Remarks'];
            const csvContent = [
                headers.join(','),
                ...subscriptions.map(sub => [
                    `"${sub.companyName || ''}"`,
                    `"${sub.mobileNo || ''}"`,
                    `"${sub.emailId || ''}"`,
                    `"${sub.subscriptionId || ''}"`,
                    `"${sub.model || ''}"`,
                    `"${sub.startingDate || ''}"`,
                    `"${sub.expiryDate || ''}"`,
                    `"${sub.remarks || ''}"`
                ].join(','))
            ].join('\n');

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `subscriptions_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification(`${subscriptions.length} records exported successfully!`, 'success');
        }

        function downloadExcelTemplate() {
            const headers = ['Company Name', 'Mobile No', 'Email ID', 'Subscription ID', 'Model', 'Starting Date', 'Expiry Date', 'Remarks'];
            const sampleData = [
                'ABC Company', '9876543210', 'abc@company.com', 'SUB001', 'Premium Plan', '2024-01-01', '2024-12-31', 'Sample subscription'
            ];
            
            const csvContent = [
                headers.join(','),
                sampleData.map(field => `"${field}"`).join(',')
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'subscription_template.csv';
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification('Excel template downloaded successfully!', 'success');
        }

        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('üì• Starting Excel import...', file.name, file.type);
            
            // Show loading notification
            showNotification('üì• ‡§á‡§Æ‡•ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à... Importing file, please wait...', 'success');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    console.log('üìÑ File read successfully, processing...');
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    
                    console.log('üìä Total lines found:', lines.length);
                    
                    if (lines.length < 2) {
                        console.error('‚ùå File appears empty or invalid');
                        showNotification('‚ùå ‡§´‡§æ‡§á‡§≤ ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à ‡§Ø‡§æ ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§π‡•à! File appears to be empty or invalid!', 'error');
                        return;
                    }

                    // Parse header with better error handling
                    const headerLine = lines[0];
                    console.log('üìã Header line:', headerLine);
                    
                    const headers = parseCSVLine(headerLine).map(h => h.replace(/"/g, '').trim());
                    console.log('üìã Parsed headers:', headers);
                    
                    // Enhanced header matching with better priority
                    const getColumnIndex = (searchTerms) => {
                        // First try exact matches (case insensitive)
                        let index = headers.findIndex(h => {
                            const headerClean = h.toLowerCase().replace(/[^a-z]/g, '');
                            return searchTerms.some(term => {
                                const termClean = term.toLowerCase().replace(/[^a-z]/g, '');
                                return headerClean === termClean;
                            });
                        });
                        
                        // If no exact match, try partial matches
                        if (index === -1) {
                            index = headers.findIndex(h => {
                                const headerLower = h.toLowerCase().replace(/[^a-z]/g, '');
                                return searchTerms.some(term => {
                                    const termLower = term.toLowerCase().replace(/[^a-z]/g, '');
                                    return headerLower.includes(termLower) && headerLower.length <= termLower.length + 3;
                                });
                            });
                        }
                        
                        return index;
                    };

                    const columnIndices = {
                        companyName: getColumnIndex(['company', 'name', 'companyname']),
                        mobileNo: getColumnIndex(['mobile', 'phone', 'mobileno', 'contact']),
                        emailId: getColumnIndex(['email', 'mail', 'emailid']),
                        subscriptionId: getColumnIndex(['subscription', 'subscriptionid', 'subid', 'sub']),
                        model: getColumnIndex(['model', 'plan', 'type']),
                        startingDate: getColumnIndex(['starting', 'start', 'startingdate', 'from']),
                        expiryDate: getColumnIndex(['expiry', 'expire', 'end', 'expirydate', 'to']),
                        remarks: getColumnIndex(['remarks', 'notes', 'comment', 'note'])
                    };

                    console.log('üîç Column indices found:', columnIndices);
                    console.log('üìã Headers detected:', headers);
                    console.log('üóÇÔ∏è Column mapping:');
                    Object.keys(columnIndices).forEach(key => {
                        const index = columnIndices[key];
                        const headerName = index >= 0 ? headers[index] : 'NOT FOUND';
                        console.log(`  ${key} ‚Üí Column ${index} (${headerName})`);
                    });

                    // Check if essential columns are found
                    const essentialColumns = ['companyName', 'mobileNo', 'emailId', 'subscriptionId', 'model', 'startingDate', 'expiryDate'];
                    const missingColumns = essentialColumns.filter(col => columnIndices[col] === -1);
                    
                    if (missingColumns.length > 0) {
                        console.error('‚ùå Missing essential columns:', missingColumns);
                        showNotification(`‚ùå ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡•â‡§≤‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á! Missing required columns: ${missingColumns.join(', ')}`, 'error');
                        
                        // Show expected headers
                        setTimeout(() => {
                            showExpectedHeaders();
                        }, 1000);
                        return;
                    }

                    let importedCount = 0;
                    let updatedCount = 0;
                    let errorCount = 0;
                    const errorDetails = [];

                    // Process data rows
                    for (let i = 1; i < lines.length; i++) {
                        try {
                            const values = parseCSVLine(lines[i]);
                            console.log(`üìù Processing row ${i}:`, values);
                            
                            if (values.length === 0 || !values.some(v => v.trim())) {
                                console.log(`‚è≠Ô∏è Skipping empty row ${i}`);
                                continue; // Skip empty rows
                            }

                            const rowData = {
                                companyName: cleanValue(values[columnIndices.companyName]),
                                mobileNo: cleanValue(values[columnIndices.mobileNo]),
                                emailId: cleanValue(values[columnIndices.emailId]),
                                subscriptionId: cleanValue(values[columnIndices.subscriptionId]),
                                model: cleanValue(values[columnIndices.model]),
                                startingDate: cleanValue(values[columnIndices.startingDate]),
                                expiryDate: cleanValue(values[columnIndices.expiryDate]),
                                remarks: columnIndices.remarks >= 0 ? cleanValue(values[columnIndices.remarks]) : '',
                                createdAt: new Date().toISOString(),
                                lastModified: new Date().toISOString()
                            };

                            console.log(`üìã Row ${i} raw values:`, values);
                            console.log(`üìã Row ${i} mapped data:`, rowData);
                            console.log(`üîç Row ${i} field mapping:`);
                            console.log(`  Company: values[${columnIndices.companyName}] = "${values[columnIndices.companyName]}" ‚Üí "${rowData.companyName}"`);
                            console.log(`  Email: values[${columnIndices.emailId}] = "${values[columnIndices.emailId]}" ‚Üí "${rowData.emailId}"`);
                            console.log(`  Sub ID: values[${columnIndices.subscriptionId}] = "${values[columnIndices.subscriptionId]}" ‚Üí "${rowData.subscriptionId}"`);

                            // Validate required fields
                            if (!rowData.companyName || !rowData.mobileNo || !rowData.emailId || 
                                !rowData.subscriptionId || !rowData.model || !rowData.startingDate || !rowData.expiryDate) {
                                console.log(`‚ùå Row ${i} missing required fields`);
                                errorDetails.push(`Row ${i}: Missing required fields`);
                                errorCount++;
                                continue;
                            }

                            // Validate and convert date formats
                            const startDate = parseAndValidateDate(rowData.startingDate);
                            const endDate = parseAndValidateDate(rowData.expiryDate);
                            
                            if (!startDate || !endDate) {
                                console.log(`‚ùå Row ${i} invalid date format`);
                                errorDetails.push(`Row ${i}: Invalid date format`);
                                errorCount++;
                                continue;
                            }
                            
                            // Convert to YYYY-MM-DD format
                            rowData.startingDate = startDate;
                            rowData.expiryDate = endDate;

                            // Validate email format
                            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                            if (!emailRegex.test(rowData.emailId)) {
                                console.log(`‚ùå Row ${i} invalid email format`);
                                errorDetails.push(`Row ${i}: Invalid email format`);
                                errorCount++;
                                continue;
                            }

                            // Validate mobile number
                            const cleanMobile = rowData.mobileNo.replace(/\D/g, '');
                            if (cleanMobile.length !== 10) {
                                console.log(`‚ùå Row ${i} invalid mobile number`);
                                errorDetails.push(`Row ${i}: Invalid mobile number`);
                                errorCount++;
                                continue;
                            }

                            // Check if subscription exists
                            const existingIndex = subscriptions.findIndex(sub => 
                                sub && sub.subscriptionId === rowData.subscriptionId
                            );

                            if (existingIndex >= 0) {
                                // Update existing subscription
                                subscriptions[existingIndex] = { ...subscriptions[existingIndex], ...rowData };
                                updatedCount++;
                                console.log(`‚úÖ Updated existing subscription: ${rowData.subscriptionId}`);
                            } else {
                                // Add new subscription
                                subscriptions.push(rowData);
                                importedCount++;
                                console.log(`‚úÖ Added new subscription: ${rowData.subscriptionId}`);
                            }

                        } catch (error) {
                            console.error(`‚ùå Error processing row ${i}:`, error);
                            errorDetails.push(`Row ${i}: ${error.message}`);
                            errorCount++;
                            continue;
                        }
                    }

                    console.log('üìä Import summary:', { importedCount, updatedCount, errorCount });

                    // Save data with immediate database sync for imports
                    saveDataWithDatabaseSync();
                    
                    // Show detailed results
                    let message = '';
                    if (importedCount > 0) message += `‚úÖ ${importedCount} ‡§®‡§è ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§á‡§Æ‡•ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§π‡•Å‡§è! `;
                    if (updatedCount > 0) message += `üîÑ ${updatedCount} ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•Å‡§è! `;
                    if (errorCount > 0) message += `‚ö†Ô∏è ${errorCount} ‡§∞‡•ã ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞ ‡§•‡•á! `;
                    
                    const totalSuccess = importedCount + updatedCount;
                    if (totalSuccess > 0) {
                        showNotification(message || 'Import completed!', 'success');
                        
                        // Show detailed import results with preview
                        setTimeout(() => {
                            showImportResults(importedCount, updatedCount, errorCount, errorDetails, headers, columnIndices);
                        }, 1000);
                    } else {
                        showNotification('‚ùå ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§á‡§Æ‡•ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü! No data was imported. Please check file format.', 'error');
                        
                        // Show error details
                        if (errorDetails.length > 0) {
                            setTimeout(() => {
                                showImportErrors(errorDetails);
                            }, 1000);
                        }
                    }

                } catch (error) {
                    console.error('‚ùå Critical import error:', error);
                    showNotification('‚ùå ‡§´‡§æ‡§á‡§≤ ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞! Error processing file. Please check format and try again.', 'error');
                }
            };
            
            reader.onerror = function() {
                console.error('‚ùå File reading error');
                showNotification('‚ùå ‡§´‡§æ‡§á‡§≤ ‡§™‡§¢‡§º‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞! Error reading file. Please try again.', 'error');
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        // Helper functions for Excel processing
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current);
            return values;
        }

        function cleanValue(value) {
            if (!value) return '';
            return value.replace(/"/g, '').trim();
        }

        function isValidDate(dateString) {
            if (!dateString) return false;
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date);
        }

        // Enhanced date parsing function
        function parseAndValidateDate(dateString) {
            if (!dateString) return null;
            
            // Remove extra spaces and quotes
            const cleanDate = dateString.trim().replace(/"/g, '');
            
            // Try different date formats
            const formats = [
                // YYYY-MM-DD (ISO format)
                /^(\d{4})-(\d{1,2})-(\d{1,2})$/,
                // DD/MM/YYYY or DD-MM-YYYY
                /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/,
                // MM/DD/YYYY or MM-DD-YYYY
                /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/,
                // DD.MM.YYYY
                /^(\d{1,2})\.(\d{1,2})\.(\d{4})$/
            ];
            
            // Try ISO format first
            if (formats[0].test(cleanDate)) {
                const date = new Date(cleanDate);
                if (!isNaN(date.getTime())) {
                    return cleanDate; // Already in correct format
                }
            }
            
            // Try DD/MM/YYYY format
            const ddmmMatch = cleanDate.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
            if (ddmmMatch) {
                const day = parseInt(ddmmMatch[1]);
                const month = parseInt(ddmmMatch[2]);
                const year = parseInt(ddmmMatch[3]);
                
                // Validate ranges
                if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900 && year <= 2100) {
                    // Convert to YYYY-MM-DD format
                    const formattedDate = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    const testDate = new Date(formattedDate);
                    if (!isNaN(testDate.getTime())) {
                        return formattedDate;
                    }
                }
            }
            
            // Try parsing as general date
            const date = new Date(cleanDate);
            if (!isNaN(date.getTime())) {
                // Convert to YYYY-MM-DD format
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            return null;
        }

        // Show expected headers modal
        function showExpectedHeaders() {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem; color: #ef4444;">üìã</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #ef4444; margin-bottom: 1rem;">Required Excel Headers</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6;">
                    <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ef4444;">
                        <p style="color: #991b1b; margin: 0; font-weight: 600;">
                            ‚ùå ‡§Ü‡§™‡§ï‡•Ä Excel ‡§´‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï headers ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á! Required headers not found in your Excel file!
                        </p>
                    </div>
                    
                    <p><strong>‡§Ü‡§™‡§ï‡•Ä Excel ‡§´‡§æ‡§á‡§≤ ‡§ï‡•á ‡§™‡§π‡§≤‡•á row ‡§Æ‡•á‡§Ç ‡§Ø‡•á headers ‡§π‡•ã‡§®‡•á ‡§ö‡§æ‡§π‡§ø‡§è:</strong></p>
                    
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; font-family: monospace; font-size: 0.85rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div><strong>A1:</strong> Company Name</div>
                            <div><strong>B1:</strong> Mobile No</div>
                            <div><strong>C1:</strong> Email ID</div>
                            <div><strong>D1:</strong> Subscription ID</div>
                            <div><strong>E1:</strong> Model</div>
                            <div><strong>F1:</strong> Starting Date</div>
                            <div><strong>G1:</strong> Expiry Date</div>
                            <div><strong>H1:</strong> Remarks</div>
                        </div>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h4 style="color: #1e40af; margin: 0 0 0.5rem 0;">üí° Tips:</h4>
                        <ul style="color: #1e40af; margin: 0; padding-left: 1.5rem; font-size: 0.85rem;">
                            <li>Headers should be exactly as shown above</li>
                            <li>Headers should be in Row 1 of your Excel file</li>
                            <li>Data should start from Row 2</li>
                            <li>Save file as CSV format for best compatibility</li>
                        </ul>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="downloadExcelTemplate(); hideConfirmModal();" class="btn btn-success">
                        üìã Download Template
                    </button>
                    <button onclick="copySheetTemplate(); hideConfirmModal();" class="btn btn-primary">
                        üìã Copy Headers
                    </button>
                    <button onclick="hideConfirmModal()" class="btn btn-secondary">
                        ‚úÖ Close
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Show import results
        function showImportResults(importedCount, updatedCount, errorCount, errorDetails, headers = [], columnIndices = {}) {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            const totalSuccess = importedCount + updatedCount;
            const successColor = totalSuccess > 0 ? '#059669' : '#ef4444';
            const successIcon = totalSuccess > 0 ? '‚úÖ' : '‚ùå';
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem; color: ${successColor};">${successIcon}</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: ${successColor}; margin-bottom: 1rem;">Import Results</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6;">
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #22c55e;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #15803d;">${importedCount}</div>
                            <div style="font-size: 0.8rem; color: #15803d;">New Records</div>
                        </div>
                        <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #3b82f6;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #1e40af;">${updatedCount}</div>
                            <div style="font-size: 0.8rem; color: #1e40af;">Updated Records</div>
                        </div>
                        <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #f59e0b;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #92400e;">${errorCount}</div>
                            <div style="font-size: 0.8rem; color: #92400e;">Errors</div>
                        </div>
                    </div>
                    
                    ${headers.length > 0 ? `
                        <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #3b82f6;">
                            <h4 style="color: #1e40af; margin: 0 0 0.5rem 0;">üìã Column Mapping Detected:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.8rem;">
                                ${Object.keys(columnIndices).map(key => {
                                    const index = columnIndices[key];
                                    const headerName = index >= 0 ? headers[index] : 'NOT FOUND';
                                    const statusColor = index >= 0 ? '#15803d' : '#dc2626';
                                    return `<div style="color: ${statusColor};">
                                        <strong>${key}:</strong> ${headerName} ${index >= 0 ? `(Col ${index + 1})` : ''}
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${totalSuccess > 0 ? `
                        <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #22c55e;">
                            <p style="color: #15803d; margin: 0; font-weight: 600;">
                                üéâ ${totalSuccess} records successfully imported! Data has been saved and synced.
                            </p>
                        </div>
                    ` : ''}
                    
                    ${errorCount > 0 ? `
                        <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
                            <p style="color: #92400e; margin: 0 0 0.5rem 0; font-weight: 600;">‚ö†Ô∏è Some rows had errors:</p>
                            <div style="max-height: 150px; overflow-y: auto; background: white; padding: 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                ${errorDetails.slice(0, 10).map(error => `<div style="margin-bottom: 0.25rem;">‚Ä¢ ${error}</div>`).join('')}
                                ${errorDetails.length > 10 ? `<div style="font-style: italic; color: #6b7280;">... and ${errorDetails.length - 10} more errors</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    ${totalSuccess > 0 ? `
                        <button onclick="showTab('dashboard'); hideConfirmModal();" class="btn btn-success">
                            üìä View Dashboard
                        </button>
                    ` : ''}
                    <button onclick="downloadExcelTemplate(); hideConfirmModal();" class="btn btn-primary">
                        üìã Download Template
                    </button>
                    <button onclick="hideConfirmModal()" class="btn btn-secondary">
                        ‚úÖ Close
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Show import errors
        function showImportErrors(errorDetails) {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem; color: #ef4444;">‚ùå</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #ef4444; margin-bottom: 1rem;">Import Errors</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6;">
                    
                    <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ef4444;">
                        <p style="color: #991b1b; margin: 0; font-weight: 600;">
                            ‚ùå ${errorDetails.length} rows ‡§Æ‡•á‡§Ç errors ‡§Æ‡§ø‡§≤‡•á! Found errors in ${errorDetails.length} rows!
                        </p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="color: #374151; margin: 0 0 0.5rem 0;">Error Details:</h4>
                        <div style="max-height: 200px; overflow-y: auto; background: white; padding: 0.75rem; border-radius: 4px; font-size: 0.8rem; border: 1px solid #e5e7eb;">
                            ${errorDetails.map(error => `<div style="margin-bottom: 0.5rem; padding: 0.25rem; border-left: 3px solid #ef4444; padding-left: 0.5rem;">‚Ä¢ ${error}</div>`).join('')}
                        </div>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="color: #1e40af; margin: 0 0 0.5rem 0;">üí° Common Issues:</h4>
                        <ul style="color: #1e40af; margin: 0; padding-left: 1.5rem; font-size: 0.85rem;">
                            <li>Missing required fields (Company Name, Email, etc.)</li>
                            <li>Invalid date format (use DD/MM/YYYY or YYYY-MM-DD)</li>
                            <li>Invalid email format</li>
                            <li>Invalid mobile number (should be 10 digits)</li>
                            <li>Empty rows or incomplete data</li>
                        </ul>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="downloadExcelTemplate(); hideConfirmModal();" class="btn btn-success">
                        üìã Download Template
                    </button>
                    <button onclick="showExpectedHeaders(); hideConfirmModal();" class="btn btn-primary">
                        üìã View Required Headers
                    </button>
                    <button onclick="hideConfirmModal()" class="btn btn-secondary">
                        ‚úÖ Close
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Data management functions
        function exportData() {
            const dataStr = JSON.stringify(subscriptions, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `subscriptions_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Data exported successfully!', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        subscriptions = importedData;
                        saveData();
                        showNotification('Data imported successfully!', 'success');
                    } else {
                        showNotification('Invalid file format!', 'error');
                    }
                } catch (error) {
                    showNotification('Error reading file!', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function showResetConfirm() {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem; color: #ef4444;">üóëÔ∏è</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #ef4444; margin-bottom: 1rem;">‚ö†Ô∏è Reset All Data</h3>
                <div style="background: #fee2e2; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 2px solid #fecaca;">
                    <p style="color: #991b1b; font-weight: 600; margin: 0 0 1rem 0;">This will permanently delete:</p>
                    <ul style="color: #991b1b; margin: 0; padding-left: 1.5rem;">
                        <li>All ${subscriptions.length} subscription records</li>
                        <li>All master entries</li>
                        <li>All renewal history</li>
                        <li>Local storage data</li>
                    </ul>
                    <p style="color: #991b1b; font-weight: 700; margin: 1rem 0 0 0;">‚ö†Ô∏è This action CANNOT be undone!</p>
                </div>
                <div style="background: #f3f4f6; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                    <p style="color: #374151; font-size: 0.9rem; margin: 0;">
                        üí° <strong>Tip:</strong> Consider exporting your data first as a backup before resetting.
                    </p>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="exportData()" class="btn btn-secondary" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                        üì§ Export First
                    </button>
                    <button onclick="confirmResetData()" class="btn btn-danger" style="background: linear-gradient(135deg, #ef4444, #dc2626); font-weight: 700;">
                        üóëÔ∏è Yes, Reset All Data
                    </button>
                    <button onclick="hideConfirmModal()" class="btn btn-success">
                        ‚ùå Cancel
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        function confirmResetData() {
            try {
                // Clear all subscription data
                subscriptions = [];
                
                // Clear localStorage
                localStorage.removeItem('subscriptions');
                localStorage.removeItem('appSettings');
                localStorage.removeItem('sheetConfig');
                
                // Reset settings to defaults
                settings = { warningDays: 30 };
                sheetConfig = {
                    url: '',
                    id: '',
                    scriptUrl: '',
                    connected: false,
                    scriptConnected: false,
                    autoSync: false,
                    syncInterval: 5,
                    syncOnLoad: true,
                    lastSync: null
                };
                
                // Stop any running sync timers
                if (syncTimer) {
                    clearInterval(syncTimer);
                    syncTimer = null;
                }
                
                // Reset all form inputs
                document.getElementById('subscriptionForm').reset();
                document.getElementById('renewalForm').reset();
                document.getElementById('warningDays').value = 30;
                document.getElementById('sheetUrl').value = '';
                document.getElementById('scriptUrl').value = '';
                document.getElementById('syncInterval').value = 5;
                document.getElementById('syncOnLoad').checked = true;
                
                // Reset message templates to default
                const defaultTemplates = getDefaultMessageTemplates();
                document.getElementById('expiredTemplate').value = defaultTemplates.expired;
                document.getElementById('expiringSoonTemplate').value = defaultTemplates.expiringSoon;
                
                // Update all views
                updateAllViews();
                updateConnectionStatus();
                
                // Hide modal
                hideConfirmModal();
                
                // Show success notification
                showNotification('üóëÔ∏è All data has been reset successfully! Starting fresh.', 'success');
                
                // Switch to dashboard tab
                setTimeout(() => {
                    showTab('dashboard');
                }, 500);
                
            } catch (error) {
                console.error('Error resetting data:', error);
                showNotification('‚ùå Error occurred while resetting data. Please refresh the page.', 'error');
                hideConfirmModal();
            }
        }

        // Modal functions
        function showConfirmModal() {
            document.getElementById('confirmModal').classList.add('show');
        }

        function hideConfirmModal() {
            document.getElementById('confirmModal').classList.remove('show');
        }

        // Quick Action Functions
        function quickAddMasterEntry() {
            showTab('master');
            setTimeout(() => {
                toggleForm();
                document.getElementById('companyName').focus();
            }, 300);
        }

        function quickRenewalEntry() {
            showTab('renewal');
            setTimeout(() => {
                document.getElementById('renewalSubId').focus();
            }, 300);
        }

        function quickBulkImportExport() {
            showTab('master');
            setTimeout(() => {
                toggleBulkImport();
            }, 300);
        }

        function quickViewWarnings() {
            showTab('renewal');
            setTimeout(() => {
                // Scroll to warning section
                const warningSection = document.querySelector('#renewal .card:last-child');
                if (warningSection) {
                    warningSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
        }

        // Cell expansion function for mobile
        function toggleCellExpansion(element) {
            element.classList.toggle('expanded');
        }

        // Enhanced Form Functions
        function updateFormProgress() {
            const requiredFields = ['companyName', 'mobileNo', 'emailId', 'subscriptionId', 'model', 'startingDate', 'expiryDate'];
            let filledCount = 0;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value.trim()) {
                    filledCount++;
                }
            });
            
            const progress = (filledCount / requiredFields.length) * 100;
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('formProgress');
            
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            if (progressText) {
                progressText.textContent = `${filledCount}/${requiredFields.length} completed`;
            }
        }

        function formatMobileNumber(input) {
            // Remove all non-digits
            let value = input.value.replace(/\D/g, '');
            
            // Limit to 10 digits
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            
            input.value = value;
        }

        function autoGenerateSubId() {
            const companyName = document.getElementById('companyName').value.trim();
            const prefix = companyName ? companyName.substring(0, 3).toUpperCase() : 'SUB';
            const timestamp = Date.now().toString().slice(-6);
            const randomNum = Math.floor(Math.random() * 100).toString().padStart(2, '0');
            
            const subId = `${prefix}${timestamp}${randomNum}`;
            document.getElementById('subscriptionId').value = subId;
            updateFormProgress();
            showNotification('Subscription ID generated automatically!', 'success');
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startingDate').value = today;
            updateFormProgress();
            calculateExpiryDate();
        }

        function calculateExpiryDate() {
            const startDate = document.getElementById('startingDate').value;
            if (startDate) {
                const date = new Date(startDate);
                date.setFullYear(date.getFullYear() + 1); // Default to 1 year
                document.getElementById('expiryDate').value = date.toISOString().split('T')[0];
                updateFormProgress();
            }
        }

        function addMonths(months) {
            const startDate = document.getElementById('startingDate').value;
            if (startDate) {
                const date = new Date(startDate);
                date.setMonth(date.getMonth() + months);
                document.getElementById('expiryDate').value = date.toISOString().split('T')[0];
                updateFormProgress();
            } else {
                showNotification('Please select starting date first!', 'error');
            }
        }

        // Enhanced Renewal Functions with Performance Optimization
        function addRenewalMonths(months) {
            const subId = document.getElementById('renewalSubId').getAttribute('data-sub-id');
            if (!subId) {
                showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á subscription select ‡§ï‡§∞‡•á‡§Ç! Please select a subscription first!', 'error');
                return;
            }
            
            const sub = subscriptions.find(s => s.subscriptionId === subId);
            if (sub) {
                const currentExpiry = new Date(sub.expiryDate);
                const newDate = new Date(currentExpiry);
                newDate.setMonth(newDate.getMonth() + months);
                
                const expiryField = document.getElementById('newExpiryDate');
                expiryField.value = newDate.toISOString().split('T')[0];
                
                // Immediate UI updates for faster response
                updateRenewalStepFast();
                calculateRenewalDurationFast();
                
                // Quick feedback
                showNotification(`üìÖ ${months} ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ú‡•ã‡§°‡§º‡•á ‡§ó‡§è! Added ${months} months extension!`, 'success');
            }
        }

        function updateRenewalStep() {
            updateRenewalStepFast();
        }

        function updateRenewalStepFast() {
            const step2 = document.getElementById('step2');
            const newExpiryDate = document.getElementById('newExpiryDate').value;
            
            if (newExpiryDate) {
                // Apply styles immediately without transitions for faster response
                step2.style.transition = 'none';
                step2.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                step2.style.color = 'white';
                step2.style.boxShadow = '0 4px 15px rgba(16, 185, 129, 0.3)';
                
                // Re-enable transitions after immediate update
                setTimeout(() => {
                    step2.style.transition = 'all 0.3s ease';
                }, 10);
                
                calculateRenewalDurationFast();
            } else {
                step2.style.transition = 'none';
                step2.style.background = '#e5e7eb';
                step2.style.color = '#6b7280';
                step2.style.boxShadow = 'none';
                
                setTimeout(() => {
                    step2.style.transition = 'all 0.3s ease';
                }, 10);
            }
        }

        function calculateRenewalDuration() {
            calculateRenewalDurationFast();
        }

        function calculateRenewalDurationFast() {
            const subId = document.getElementById('renewalSubId').getAttribute('data-sub-id');
            const newExpiryDate = document.getElementById('newExpiryDate').value;
            
            if (!subId || !newExpiryDate) {
                // Hide duration info immediately if no data
                const durationInfo = document.getElementById('durationInfo');
                const summaryDiv = document.getElementById('renewalSummary');
                if (durationInfo) durationInfo.classList.add('hidden');
                if (summaryDiv) summaryDiv.classList.add('hidden');
                return;
            }
            
            const sub = subscriptions.find(s => s.subscriptionId === subId);
            if (sub) {
                const currentExpiry = new Date(sub.expiryDate);
                const newExpiry = new Date(newExpiryDate);
                const diffTime = newExpiry - currentExpiry;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const diffMonths = Math.round(diffDays / 30);
                
                const durationInfo = document.getElementById('durationInfo');
                const durationText = document.getElementById('durationText');
                const summaryDiv = document.getElementById('renewalSummary');
                const summaryText = document.getElementById('summaryText');
                
                if (diffDays > 0) {
                    // Show duration info immediately
                    if (durationInfo) {
                        durationInfo.classList.remove('hidden');
                        if (durationText) {
                            durationText.textContent = `‚è±Ô∏è Extension: ${diffDays} days (‚âà ${diffMonths} months)`;
                        }
                    }
                    
                    if (summaryDiv) {
                        summaryDiv.classList.remove('hidden');
                        if (summaryText) {
                            summaryText.textContent = `üìä Extending ${sub.companyName} by ${diffMonths} months`;
                        }
                    }
                } else {
                    // Hide immediately if invalid dates
                    if (durationInfo) durationInfo.classList.add('hidden');
                    if (summaryDiv) summaryDiv.classList.add('hidden');
                }
            }
        }

        // Enhanced dropdown with better styling
        function updateDropdownOptions() {
            const optionsContainer = document.getElementById('dropdownOptions');
            
            if (subscriptions.length === 0) {
                optionsContainer.innerHTML = '<div class="dropdown-item" style="text-align: center; color: #6b7280; padding: 2rem;">No subscriptions available</div>';
                return;
            }
            
            optionsContainer.innerHTML = subscriptions.map(sub => {
                const status = getSubscriptionStatus(sub);
                const statusColor = status === 'Expired' ? '#ef4444' : status === 'Expiring Soon' ? '#f59e0b' : '#10b981';
                
                return `
                    <div class="dropdown-item" onmousedown="selectSubscription('${escapeHtml(sub.subscriptionId)}', '${escapeHtml(sub.companyName)}')" 
                         style="padding: 1rem; border-bottom: 1px solid rgba(16, 185, 129, 0.1); transition: all 0.2s ease; cursor: pointer;"
                         onmouseover="this.style.background='rgba(16, 185, 129, 0.05)'" onmouseout="this.style.background='white'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: #374151; font-size: 0.95rem;">${escapeHtml(sub.subscriptionId)}</div>
                                <div style="font-size: 0.875rem; color: #6b7280; margin: 0.25rem 0;">${escapeHtml(sub.companyName)} - ${escapeHtml(sub.model)}</div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">Expires: ${formatDate(sub.expiryDate)}</div>
                            </div>
                            <div style="padding: 0.25rem 0.75rem; background: ${statusColor}; color: white; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                                ${status}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Enhanced selected details display
        function showSelectedDetails() {
            const input = document.getElementById('renewalSubId');
            const subId = input.getAttribute('data-sub-id');
            const detailsDiv = document.getElementById('selectedDetails');
            const contentDiv = document.getElementById('detailsContent');
            
            if (!subId) {
                detailsDiv.classList.add('hidden');
                return;
            }
            
            const sub = subscriptions.find(s => s.subscriptionId === subId);
            if (sub) {
                const status = getSubscriptionStatus(sub);
                const statusColor = status === 'Expired' ? '#ef4444' : status === 'Expiring Soon' ? '#f59e0b' : '#10b981';
                
                contentDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; font-size: 0.9rem;">
                        <div style="padding: 1rem; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border-left: 4px solid #667eea;">
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 0.5rem;">üè¢ Company</div>
                            <div style="color: #374151;">${escapeHtml(sub.companyName)}</div>
                        </div>
                        <div style="padding: 1rem; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="font-weight: 600; color: #10b981; margin-bottom: 0.5rem;">üìã Model</div>
                            <div style="color: #374151;">${escapeHtml(sub.model)}</div>
                        </div>
                        <div style="padding: 1rem; background: rgba(245, 158, 11, 0.05); border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-weight: 600; color: #f59e0b; margin-bottom: 0.5rem;">üìÜ Current Expiry</div>
                            <div style="color: #374151;">${formatDate(sub.expiryDate)}</div>
                        </div>
                        <div style="padding: 1rem; background: rgba(${statusColor.replace('#', '')}, 0.05); border-radius: 8px; border-left: 4px solid ${statusColor};">
                            <div style="font-weight: 600; color: ${statusColor}; margin-bottom: 0.5rem;">üìä Status</div>
                            <div style="color: #374151;">${status}</div>
                        </div>
                    </div>
                `;
                detailsDiv.classList.remove('hidden');
                updateRenewalStep();
            }
        }

        // Add CSS animation for spinner
        const spinnerCSS = `
            @keyframes spin {
                0% { transform: translateY(-50%) rotate(0deg); }
                100% { transform: translateY(-50%) rotate(360deg); }
            }
        `;
        
        // Add spinner CSS to head
        const style = document.createElement('style');
        style.textContent = spinnerCSS;
        document.head.appendChild(style);

        // ==================== GOOGLE SHEETS INTEGRATION ====================

        // Initialize Google Sheets
        function initializeGoogleSheets() {
            updateConnectionStatus();
            
            // Only auto sync if properly connected and not running from file://
            if (sheetConfig.scriptConnected && sheetConfig.syncOnLoad && window.location.protocol !== 'file:') {
                setTimeout(() => {
                    syncFromSheet();
                }, 2000);
            } else if (window.location.protocol === 'file:') {
                console.log('‚ö†Ô∏è Running from file:// protocol - automatic sync disabled to prevent CORS errors');
                // Show info about manual sync options
                setTimeout(() => {
                    if (sheetConfig.scriptConnected) {
                        showNotification('‚ö†Ô∏è Manual sync required due to CORS restrictions. Use Export/Import buttons.', 'error');
                    }
                }, 3000);
            }
            
            // Setup auto sync if enabled and not file protocol
            if (sheetConfig.connected && sheetConfig.autoSync && window.location.protocol !== 'file:') {
                startAutoSync();
            }
        }

        // Load sheet configuration
        function loadSheetConfig() {
            try {
                const data = localStorage.getItem('sheetConfig');
                if (data) {
                    sheetConfig = { ...sheetConfig, ...JSON.parse(data) };
                }
                
                // Update UI elements
                if (sheetConfig.url) {
                    document.getElementById('sheetUrl').value = sheetConfig.url;
                }
                if (sheetConfig.scriptUrl) {
                    document.getElementById('scriptUrl').value = sheetConfig.scriptUrl;
                }
                document.getElementById('syncInterval').value = sheetConfig.syncInterval;
                document.getElementById('syncOnLoad').checked = sheetConfig.syncOnLoad;
            } catch (error) {
                console.error('Error loading sheet config:', error);
            }
        }

        // Save sheet configuration
        function saveSheetConfig() {
            try {
                localStorage.setItem('sheetConfig', JSON.stringify(sheetConfig));
            } catch (error) {
                console.error('Error saving sheet config:', error);
            }
        }

        // Create Google Sheet
        function createGoogleSheet() {
            const sheetUrl = 'https://docs.google.com/spreadsheets/create';
            window.open(sheetUrl, '_blank', 'noopener,noreferrer');
            
            showNotification('üìä Opening Google Sheets. Create a new sheet named "Subscription Database"', 'success');
            
            // Show instructions
            setTimeout(() => {
                showSheetCreationInstructions();
            }, 1000);
        }

        // Show sheet creation instructions
        function showSheetCreationInstructions() {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem;">üìä</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #059669; margin-bottom: 1rem;">Google Sheet Setup Instructions</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6;">
                    <p><strong>Step 1:</strong> Create a new Google Sheet</p>
                    <p><strong>Step 2:</strong> Rename it to "Subscription Database"</p>
                    <p><strong>Step 3:</strong> Add these column headers in Row 1:</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; font-family: monospace; font-size: 0.8rem;">
                        A1: Company Name<br>
                        B1: Mobile No<br>
                        C1: Email ID<br>
                        D1: Subscription ID<br>
                        E1: Model<br>
                        F1: Starting Date<br>
                        G1: Expiry Date<br>
                        H1: Remarks<br>
                        I1: Created At<br>
                        J1: Last Modified
                    </div>
                    <p><strong>Step 4:</strong> Copy the sheet URL and paste it in the "Enter Sheet URL" field</p>
                    <p><strong>Step 5:</strong> Click "Connect Sheet" button</p>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem;">
                    <button onclick="hideConfirmModal()" class="btn btn-primary">
                        ‚úÖ Got it!
                    </button>
                    <button onclick="copySheetTemplate(); hideConfirmModal();" class="btn btn-success">
                        üìã Copy Headers
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Copy sheet template headers to clipboard
        function copySheetTemplate() {
            const headers = 'Company Name\tMobile No\tEmail ID\tSubscription ID\tModel\tStarting Date\tExpiry Date\tRemarks\tCreated At\tLast Modified';
            navigator.clipboard.writeText(headers).then(() => {
                showNotification('üìã Headers copied! Paste them in Row 1 of your Google Sheet', 'success');
            }).catch(() => {
                showNotification('‚ùå Failed to copy headers. Please add them manually.', 'error');
            });
        }

        // Connect to Google Sheet
        function connectToSheet() {
            const url = document.getElementById('sheetUrl').value.trim();
            
            if (!url) {
                showNotification('‚ùå Please enter a Google Sheet URL!', 'error');
                return;
            }
            
            // Validate URL format
            if (!url.includes('docs.google.com/spreadsheets')) {
                showNotification('‚ùå Please enter a valid Google Sheets URL!', 'error');
                return;
            }
            
            // Extract sheet ID from URL
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if (!match) {
                showNotification('‚ùå Could not extract Sheet ID from URL!', 'error');
                return;
            }
            
            sheetConfig.url = url;
            sheetConfig.id = match[1];
            sheetConfig.connected = true;
            
            saveSheetConfig();
            updateConnectionStatus();
            
            showNotification('‚úÖ Connected to Google Sheet successfully!', 'success');
        }

        // Connect to Google Apps Script
        async function connectScript() {
            const scriptUrl = document.getElementById('scriptUrl').value.trim();
            
            if (!scriptUrl) {
                showNotification('‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ Google Apps Script URL ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç! Please enter Google Apps Script URL!', 'error');
                return;
            }
            
            // Validate URL format
            if (!scriptUrl.includes('script.google.com/macros/s/') || !scriptUrl.includes('/exec')) {
                showNotification('‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡•à‡§ß Google Apps Script Web App URL ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç! Please enter valid Apps Script URL!', 'error');
                return;
            }
            
            // Test connection immediately
            const connectBtn = document.querySelector('button[onclick="connectScript()"]');
            const originalText = connectBtn.innerHTML;
            connectBtn.innerHTML = 'üîÑ Connecting...';
            connectBtn.disabled = true;
            
            try {
                console.log('üß™ Testing Apps Script connection with enhanced JSONP...');
                
                // Use enhanced JSONP approach to avoid CORS issues
                const callbackName = 'connectTestCallback_' + Date.now();
                const testUrl = `${scriptUrl}?callback=${callbackName}&action=test&_=${Date.now()}`;
                
                // Create a promise-based JSONP request with better error handling
                const testConnection = new Promise((resolve, reject) => {
                    // Create callback function with proper cleanup
                    window[callbackName] = function(data) {
                        console.log('‚úÖ Connection test callback received:', data);
                        // Clean up callback immediately
                        try {
                            delete window[callbackName];
                        } catch (e) {
                            window[callbackName] = undefined;
                        }
                        resolve(data);
                    };
                    
                    // Create script element for JSONP
                    const script = document.createElement('script');
                    script.src = testUrl;
                    script.id = 'connect-test-script-' + Date.now();
                    
                    script.onerror = () => {
                        console.error('‚ùå Connection test script failed to load');
                        // Clean up callback
                        try {
                            delete window[callbackName];
                        } catch (e) {
                            window[callbackName] = undefined;
                        }
                        // Remove script
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('Apps Script URL not accessible - script failed to load'));
                    };
                    
                    script.onload = () => {
                        console.log('‚úÖ Connection test script loaded');
                        // Remove script after load
                        setTimeout(() => {
                            if (script.parentNode) {
                                script.parentNode.removeChild(script);
                            }
                        }, 2000);
                    };
                    
                    // Timeout after 15 seconds
                    const timeoutId = setTimeout(() => {
                        if (window[callbackName]) {
                            console.error('‚ùå Connection test timeout - Apps Script not responding');
                            // Clean up callback
                            try {
                                delete window[callbackName];
                            } catch (e) {
                                window[callbackName] = undefined;
                            }
                            // Remove script
                            if (script.parentNode) {
                                script.parentNode.removeChild(script);
                            }
                            reject(new Error('Connection timeout - Apps Script may not be deployed correctly'));
                        }
                    }, 15000);
                    
                    // Override resolve/reject to clear timeout
                    const originalResolve = resolve;
                    resolve = (data) => {
                        clearTimeout(timeoutId);
                        originalResolve(data);
                    };
                    
                    const originalReject = reject;
                    reject = (error) => {
                        clearTimeout(timeoutId);
                        originalReject(error);
                    };
                    
                    document.head.appendChild(script);
                });
                
                // Test the connection
                try {
                    const result = await testConnection;
                    console.log('‚úÖ JSONP connection test successful:', result);
                    
                    // Validate response format
                    if (result && (result.subscriptions !== undefined || result.success !== undefined)) {
                        // Save configuration
                        sheetConfig.scriptUrl = scriptUrl;
                        sheetConfig.scriptConnected = true;
                        sheetConfig.connected = true;
                        
                        saveSheetConfig();
                        updateConnectionStatus();
                        
                        showNotification('‚úÖ Google Apps Script ‡§∏‡•á ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•Å‡§°‡§º ‡§ó‡§Ø‡§æ! Connected successfully!', 'success');
                        
                        // Auto-sync if enabled
                        if (sheetConfig.syncOnLoad) {
                            setTimeout(() => {
                                syncFromSheet();
                            }, 1000);
                        }
                        
                    } else {
                        console.warn('‚ö†Ô∏è Unexpected response format:', result);
                        
                        // Still save the URL but show warning
                        sheetConfig.scriptUrl = scriptUrl;
                        sheetConfig.scriptConnected = true;
                        sheetConfig.connected = true;
                        
                        saveSheetConfig();
                        updateConnectionStatus();
                        
                        showNotification('‚ö†Ô∏è Connected but response format unexpected. Try testing sync manually.', 'error');
                    }
                    
                } catch (jsonpError) {
                    console.log('‚ö†Ô∏è JSONP failed, trying fallback methods...', jsonpError.message);
                    
                    // Fallback: Try direct connection with no-cors mode
                    try {
                        const response = await fetch(scriptUrl + '?_=' + Date.now(), {
                            method: 'GET',
                            mode: 'no-cors',
                            cache: 'no-cache'
                        });
                        
                        // With no-cors, we can't read the response, but if no error is thrown,
                        // it means the URL is accessible
                        console.log('‚úÖ No-cors fetch completed (response unreadable)');
                        
                        // Save configuration with warning
                        sheetConfig.scriptUrl = scriptUrl;
                        sheetConfig.scriptConnected = true;
                        sheetConfig.connected = true;
                        
                        saveSheetConfig();
                        updateConnectionStatus();
                        
                        showNotification('‚ö†Ô∏è Apps Script URL saved! JSONP failed but URL is accessible. Try manual sync.', 'error');
                        
                    } catch (fetchError) {
                        console.error('‚ùå All connection methods failed:', fetchError);
                        throw new Error('Apps Script URL not accessible. Check deployment settings and URL.');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Script connection error:', error);
                
                let errorMessage = '‚ùå Apps Script ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§´‡•á‡§≤! ';
                if (error.message.includes('timeout')) {
                    errorMessage += 'Connection timeout. Apps Script may not be deployed or is very slow.';
                } else if (error.message.includes('script failed to load')) {
                    errorMessage += 'URL not accessible. Check Apps Script deployment and URL format.';
                } else if (error.message.includes('CORS')) {
                    errorMessage += 'CORS error. Ensure Apps Script is deployed with "Anyone" access.';
                } else {
                    errorMessage += error.message;
                }
                
                showNotification(errorMessage, 'error');
                
                // Show detailed troubleshooting
                setTimeout(() => {
                    showAppsScriptTroubleshooting();
                }, 1000);
                
            } finally {
                connectBtn.innerHTML = originalText;
                connectBtn.disabled = false;
            }
        }

        // Update connection status UI
        function updateConnectionStatus() {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const statusDetails = document.getElementById('statusDetails');
            const scriptStatus = document.getElementById('scriptStatus');
            const scriptStatusIcon = document.getElementById('scriptStatusIcon');
            const scriptStatusText = document.getElementById('scriptStatusText');
            const setupSteps = document.getElementById('setupSteps');
            const syncControls = document.getElementById('syncControls');
            const syncStatus = document.getElementById('syncStatus');
            const disconnectSection = document.getElementById('disconnectSection');
            const connectionStatus = document.getElementById('connectionStatus');
            
            // Update main connection status based on Apps Script connection
            if (sheetConfig.scriptConnected) {
                statusIcon.textContent = 'üü¢';
                statusText.textContent = 'Database Connected';
                statusDetails.textContent = 'Google Apps Script connected - Real-time sync enabled';
                connectionStatus.style.background = 'rgba(34, 197, 94, 0.1)';
                connectionStatus.style.border = '2px solid rgba(34, 197, 94, 0.3)';
                connectionStatus.style.color = '#059669';
                
                setupSteps.classList.add('hidden');
                syncControls.classList.remove('hidden');
                syncStatus.classList.remove('hidden');
                disconnectSection.classList.remove('hidden');
                
                // Update last sync time
                if (sheetConfig.lastSync) {
                    document.getElementById('lastSyncTime').textContent = new Date(sheetConfig.lastSync).toLocaleString('hi-IN');
                }
                
                // Update auto sync button
                const autoSyncBtn = document.getElementById('autoSyncBtn');
                if (sheetConfig.autoSync) {
                    autoSyncBtn.innerHTML = '‚è∏Ô∏è Disable Auto Sync';
                    autoSyncBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    document.getElementById('autoSyncSettings').classList.remove('hidden');
                } else {
                    autoSyncBtn.innerHTML = 'üîÑ Enable Auto Sync';
                    autoSyncBtn.style.background = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
                    document.getElementById('autoSyncSettings').classList.add('hidden');
                }
                
            } else {
                statusIcon.textContent = 'üî¥';
                statusText.textContent = 'Database Not Connected';
                statusDetails.textContent = 'Connect Google Apps Script for database sync';
                connectionStatus.style.background = 'rgba(239, 68, 68, 0.1)';
                connectionStatus.style.border = '2px solid rgba(239, 68, 68, 0.3)';
                connectionStatus.style.color = '#dc2626';
                
                setupSteps.classList.remove('hidden');
                syncControls.classList.add('hidden');
                syncStatus.classList.add('hidden');
                disconnectSection.classList.add('hidden');
                document.getElementById('autoSyncSettings').classList.add('hidden');
            }
            
            // Update Apps Script status
            if (sheetConfig.scriptConnected) {
                scriptStatus.style.display = 'block';
                scriptStatusIcon.textContent = 'üü¢';
                scriptStatusText.textContent = 'Apps Script: Connected & Active';
                scriptStatus.style.background = 'rgba(34, 197, 94, 0.1)';
                scriptStatus.style.color = '#059669';
                scriptStatus.style.border = '2px solid rgba(34, 197, 94, 0.3)';
            } else {
                scriptStatus.style.display = 'block';
                scriptStatusIcon.textContent = 'üî¥';
                scriptStatusText.textContent = 'Apps Script: Not Connected (Database sync disabled)';
                scriptStatus.style.background = 'rgba(239, 68, 68, 0.1)';
                scriptStatus.style.color = '#dc2626';
                scriptStatus.style.border = '2px solid rgba(239, 68, 68, 0.3)';
            }
        }

        // Test connection to Google Sheet
        async function testConnection() {
            if (!sheetConfig.scriptConnected) {
                showNotification('‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á Google Apps Script ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç! Please connect Google Apps Script first!', 'error');
                return;
            }
            
            const testBtn = document.querySelector('button[onclick="testConnection()"]');
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = 'üîÑ Testing...';
            testBtn.disabled = true;
            
            try {
                console.log('üß™ Testing Apps Script connection with JSONP...');
                
                // Use JSONP for testing (same method as sync)
                const callbackName = 'testConnectionCallback_' + Date.now();
                const testUrl = `${sheetConfig.scriptUrl}?callback=${callbackName}&action=test&_=${Date.now()}`;
                
                const testResult = await new Promise((resolve, reject) => {
                    // Create global callback function
                    window[callbackName] = function(response) {
                        console.log('‚úÖ Test callback received:', response);
                        delete window[callbackName];
                        resolve(response);
                    };
                    
                    // Create script element for JSONP
                    const script = document.createElement('script');
                    script.src = testUrl;
                    script.onerror = () => {
                        console.error('‚ùå JSONP script failed to load');
                        delete window[callbackName];
                        reject(new Error('JSONP request failed - script could not load'));
                    };
                    
                    // Timeout after 15 seconds
                    setTimeout(() => {
                        if (window[callbackName]) {
                            console.error('‚ùå JSONP timeout - callback not called');
                            delete window[callbackName];
                            script.remove();
                            reject(new Error('Connection timeout - Apps Script not responding'));
                        }
                    }, 15000);
                    
                    document.head.appendChild(script);
                    
                    // Clean up script element after use
                    setTimeout(() => {
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                    }, 2000);
                });
                
                console.log('‚úÖ Test response received:', testResult);
                
                if (testResult && testResult.subscriptions !== undefined) {
                    showNotification('‚úÖ Apps Script ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§∏‡§´‡§≤! Connection test successful!', 'success');
                    updateSyncIndicator('success');
                    
                    // Update sync details
                    const syncDetails = document.getElementById('syncDetails');
                    if (syncDetails) {
                        syncDetails.textContent = `Connection verified - ${testResult.subscriptions.length || 0} records available`;
                    }
                } else if (testResult && testResult.error) {
                    throw new Error(`Apps Script Error: ${testResult.error}`);
                } else {
                    showNotification('‚ö†Ô∏è Apps Script connected but response format unexpected', 'error');
                    updateSyncIndicator('warning');
                }
                
            } catch (error) {
                console.error('‚ùå Connection test error:', error);
                
                let errorMessage = '‚ùå Apps Script ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ü‡•á‡§∏‡•ç‡§ü ‡§´‡•á‡§≤! ';
                if (error.message.includes('timeout')) {
                    errorMessage += 'Connection timeout. Apps Script may be slow or not deployed correctly.';
                } else if (error.message.includes('script could not load')) {
                    errorMessage += 'URL not accessible. Check Apps Script deployment and URL.';
                } else if (error.message.includes('CORS')) {
                    errorMessage += 'CORS error. Ensure Apps Script is deployed with "Anyone" access.';
                } else {
                    errorMessage += error.message;
                }
                
                showNotification(errorMessage, 'error');
                updateSyncIndicator('error');
                
                // Show troubleshooting for test failures
                setTimeout(() => {
                    showTestConnectionTroubleshooting(error.message);
                }, 1000);
            } finally {
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            }
        }

        // Test connection to Google Apps Script
        async function testScriptConnection() {
            if (!sheetConfig.scriptConnected) {
                showNotification('‚ùå Please connect to Google Apps Script first!', 'error');
                return;
            }
            
            try {
                // Test GET request to script
                const response = await fetch(sheetConfig.scriptUrl, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showNotification('‚úÖ Apps Script connection test successful!', 'success');
                    updateSyncIndicator('success');
                } else {
                    throw new Error('Script not accessible');
                }
            } catch (error) {
                showNotification('‚ùå Apps Script test failed! Please check URL and permissions.', 'error');
                updateSyncIndicator('error');
            }
        }

        // Sync data from Google Sheet
        async function syncFromSheet() {
            if (!sheetConfig.scriptConnected) {
                showNotification('‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á Google Apps Script ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç! Please connect Google Apps Script first!', 'error');
                return;
            }
            
            const syncBtn = document.getElementById('syncFromBtn');
            if (syncBtn) {
                const originalText = syncBtn.innerHTML;
                syncBtn.innerHTML = '‚¨áÔ∏è Syncing...';
                syncBtn.disabled = true;
            }
            
            try {
                console.log('üîÑ Starting sync from Google Sheet via Apps Script...');
                console.log('üîó Script URL:', sheetConfig.scriptUrl);
                
                let data;
                let syncMethod = 'unknown';
                
                // Method 1: Try JSONP (Best for CORS)
                try {
                    console.log('üîÑ Attempting JSONP sync...');
                    const callbackName = 'syncCallback_' + Date.now();
                    const syncUrl = `${sheetConfig.scriptUrl}?callback=${callbackName}&action=get&_=${Date.now()}`;
                    
                    data = await new Promise((resolve, reject) => {
                        // Create global callback function with proper cleanup
                        window[callbackName] = function(response) {
                            console.log('‚úÖ JSONP callback received:', response);
                            // Clean up callback immediately
                            try {
                                delete window[callbackName];
                            } catch (e) {
                                window[callbackName] = undefined;
                            }
                            resolve(response);
                        };
                        
                        // Create script element for JSONP
                        const script = document.createElement('script');
                        script.src = syncUrl;
                        script.id = 'jsonp-script-' + Date.now();
                        
                        script.onerror = () => {
                            console.error('‚ùå JSONP script failed to load');
                            // Clean up callback
                            try {
                                delete window[callbackName];
                            } catch (e) {
                                window[callbackName] = undefined;
                            }
                            // Remove script
                            if (script.parentNode) {
                                script.parentNode.removeChild(script);
                            }
                            reject(new Error('JSONP request failed'));
                        };
                        
                        script.onload = () => {
                            console.log('‚úÖ JSONP script loaded successfully');
                            // Remove script after successful load
                            setTimeout(() => {
                                if (script.parentNode) {
                                    script.parentNode.removeChild(script);
                                }
                            }, 1000);
                        };
                        
                        // Timeout after 15 seconds
                        const timeoutId = setTimeout(() => {
                            if (window[callbackName]) {
                                console.error('‚ùå JSONP timeout - callback not called within 15 seconds');
                                // Clean up callback
                                try {
                                    delete window[callbackName];
                                } catch (e) {
                                    window[callbackName] = undefined;
                                }
                                // Remove script
                                if (script.parentNode) {
                                    script.parentNode.removeChild(script);
                                }
                                reject(new Error('JSONP timeout'));
                            }
                        }, 15000);
                        
                        // Clear timeout when promise resolves
                        const originalResolve = resolve;
                        resolve = (data) => {
                            clearTimeout(timeoutId);
                            originalResolve(data);
                        };
                        
                        const originalReject = reject;
                        reject = (error) => {
                            clearTimeout(timeoutId);
                            originalReject(error);
                        };
                        
                        document.head.appendChild(script);
                    });
                    
                    syncMethod = 'JSONP';
                    console.log('‚úÖ JSONP sync successful:', data);
                    
                } catch (jsonpError) {
                    console.log('‚ö†Ô∏è JSONP failed:', jsonpError.message);
                    
                    // Method 2: Try no-cors fetch (Fallback)
                    try {
                        console.log('üîÑ Attempting no-cors fetch...');
                        const response = await fetch(sheetConfig.scriptUrl + '?action=get&_=' + Date.now(), {
                            method: 'GET',
                            mode: 'no-cors',
                            cache: 'no-cache'
                        });
                        
                        // With no-cors, we can't read the response
                        // This is just to test if the URL is accessible
                        console.log('‚úÖ No-cors fetch completed (response unreadable)');
                        syncMethod = 'no-cors (limited)';
                        
                        // Show manual sync option
                        showManualSyncOption();
                        return;
                        
                    } catch (noCorsError) {
                        console.log('‚ö†Ô∏è No-cors fetch failed:', noCorsError.message);
                        
                        // Method 3: Try regular CORS fetch (Last resort)
                        try {
                            console.log('üîÑ Attempting CORS fetch...');
                            const response = await fetch(sheetConfig.scriptUrl + '?action=get&_=' + Date.now(), {
                                method: 'GET',
                                mode: 'cors',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });
                            
                            if (response.ok) {
                                data = await response.json();
                                syncMethod = 'CORS';
                                console.log('‚úÖ CORS fetch successful:', data);
                            } else {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            
                        } catch (corsError) {
                            console.error('‚ùå All sync methods failed');
                            throw new Error('All connection methods failed. Please check Apps Script deployment.');
                        }
                    }
                }
                
                // Process the received data
                if (data && data.subscriptions && Array.isArray(data.subscriptions)) {
                    // Filter out empty rows and validate data
                    const validSubscriptions = data.subscriptions.filter(sub => 
                        sub && sub.companyName && sub.subscriptionId && 
                        sub.startingDate && sub.expiryDate
                    );
                    
                    console.log('‚úÖ Valid subscriptions found:', validSubscriptions.length);
                    
                    // Update local data
                    subscriptions = validSubscriptions;
                    
                    // Save to localStorage
                    try {
                        localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
                        console.log('‚úÖ Data saved to localStorage successfully');
                    } catch (storageError) {
                        console.error('‚ùå localStorage save error:', storageError);
                    }
                    
                    // Update all views
                    updateAllViews();
                    
                    // Update sync status
                    sheetConfig.lastSync = new Date().toISOString();
                    saveSheetConfig();
                    updateConnectionStatus();
                    updateSyncIndicator('success');
                    
                    // Update sync details
                    const syncDetails = document.getElementById('syncDetails');
                    if (syncDetails) {
                        syncDetails.textContent = `Downloaded ${validSubscriptions.length} records`;
                    }
                    
                    showNotification(`‚úÖ ${validSubscriptions.length} ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§ø‡§Ç‡§ï ‡§π‡•Å‡§è! Records synced successfully!`, 'success');
                    
                } else if (data && data.error) {
                    console.error('‚ùå Apps Script error:', data.error);
                    showNotification(`‚ùå Apps Script Error: ${data.error}`, 'error');
                } else {
                    console.warn('‚ö†Ô∏è No valid subscription data received:', data);
                    showNotification('‚ö†Ô∏è Google Sheet ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à ‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ! Sheet is empty or no valid data found.', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Sync from sheet error:', error);
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    if (window.location.protocol === 'file:') {
                        showNotification('‚ùå JSONP sync failed! Try CSV Export/Import or host on web server.', 'error');
                    } else {
                        showNotification('‚ùå ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§è‡§∞‡§∞! Network error. Check Apps Script deployment.', 'error');
                    }
                } else if (error.message.includes('CORS')) {
                    showNotification('‚ùå CORS ‡§è‡§∞‡§∞! Apps Script must be deployed with "Anyone" access. Check deployment settings.', 'error');
                } else if (error.message.includes('timeout')) {
                    showNotification('‚ùå ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ü‡§æ‡§á‡§Æ‡§Ü‡§â‡§ü! Connection timeout. Apps Script may be slow or not responding.', 'error');
                } else {
                    showNotification(`‚ùå Sync Error: ${error.message}`, 'error');
                }
                
                updateSyncIndicator('error');
                
                // Show troubleshooting guide
                showSyncTroubleshooting();
            } finally {
                if (syncBtn) {
                    syncBtn.innerHTML = syncBtn.innerHTML.replace('‚¨áÔ∏è Syncing...', '‚¨áÔ∏è Sync from Sheet');
                    syncBtn.disabled = false;
                }
            }
        }

        // Sync from CSV (fallback method)
        async function syncFromCSV() {
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetConfig.id}/export?format=csv&gid=0`;
            const response = await fetch(csvUrl);
            
            if (!response.ok) {
                throw new Error('Failed to fetch sheet data');
            }
            
            const csvData = await response.text();
            const lines = csvData.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                showNotification('‚ö†Ô∏è Sheet appears to be empty or has no data rows.', 'error');
                return [];
            }
            
            // Parse CSV data
            const headers = parseCSVLine(lines[0]);
            const newSubscriptions = [];
            
            for (let i = 1; i < lines.length; i++) {
                try {
                    const values = parseCSVLine(lines[i]);
                    
                    if (values.length >= 7 && values[0] && values[3]) { // At least company name and sub ID
                        const subscription = {
                            companyName: cleanValue(values[0]),
                            mobileNo: cleanValue(values[1]),
                            emailId: cleanValue(values[2]),
                            subscriptionId: cleanValue(values[3]),
                            model: cleanValue(values[4]),
                            startingDate: cleanValue(values[5]),
                            expiryDate: cleanValue(values[6]),
                            remarks: cleanValue(values[7]) || '',
                            createdAt: cleanValue(values[8]) || new Date().toISOString(),
                            lastModified: cleanValue(values[9]) || new Date().toISOString()
                        };
                        
                        // Validate required fields
                        if (subscription.companyName && subscription.subscriptionId && 
                            subscription.startingDate && subscription.expiryDate) {
                            newSubscriptions.push(subscription);
                        }
                    }
                } catch (error) {
                    console.warn('Error parsing row:', i, error);
                }
            }
            
            showNotification(`‚úÖ Synced ${newSubscriptions.length} records from CSV!`, 'success');
            return newSubscriptions;
        }

        // Sync data to Google Sheet with enhanced verification
        async function syncToSheet() {
            if (!sheetConfig.scriptConnected) {
                showNotification('‚ùå ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á Google Apps Script ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç! Please connect Google Apps Script first!', 'error');
                return Promise.reject(new Error('Apps Script not connected'));
            }
            
            // Check if subscriptions array exists and has data
            if (!Array.isArray(subscriptions) || subscriptions.length === 0) {
                console.log('üìä Current subscriptions:', subscriptions);
                showNotification('‚ö†Ô∏è Google Sheet ‡§Æ‡•á‡§Ç ‡§≠‡•á‡§ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç! No data to sync to Google Sheet!', 'error');
                return;
            }
            
            const syncBtn = document.getElementById('syncToBtn');
            if (syncBtn) {
                const originalText = syncBtn.innerHTML;
                syncBtn.innerHTML = '‚¨ÜÔ∏è Syncing...';
                syncBtn.disabled = true;
            }
            
            try {
                console.log('üîÑ Starting sync to Google Sheet via Apps Script...');
                console.log('üì§ Sending data:', subscriptions.length, 'records');
                console.log('üìã Sample data:', subscriptions[0]);
                
                let result;
                let syncMethod = 'unknown';
                
                // Method 1: Try JSONP with POST data (Best for CORS)
                try {
                    console.log('üîÑ Attempting JSONP POST sync...');
                    const callbackName = 'syncToSheetCallback_' + Date.now();
                    
                    // Create form for POST data
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = sheetConfig.scriptUrl;
                    form.target = 'sync-iframe-' + Date.now();
                    form.style.display = 'none';
                    
                    // Add form fields
                    const actionField = document.createElement('input');
                    actionField.name = 'action';
                    actionField.value = 'sync';
                    form.appendChild(actionField);
                    
                    const dataField = document.createElement('input');
                    dataField.name = 'subscriptions';
                    dataField.value = JSON.stringify(subscriptions);
                    form.appendChild(dataField);
                    
                    const callbackField = document.createElement('input');
                    callbackField.name = 'callback';
                    callbackField.value = callbackName;
                    form.appendChild(callbackField);
                    
                    // Create iframe for form submission
                    const iframe = document.createElement('iframe');
                    iframe.name = form.target;
                    iframe.style.display = 'none';
                    
                    document.body.appendChild(form);
                    document.body.appendChild(iframe);
                    
                    // Set up callback
                    result = await new Promise((resolve, reject) => {
                        window[callbackName] = function(response) {
                            console.log('‚úÖ JSONP POST callback received:', response);
                            // Clean up
                            try {
                                delete window[callbackName];
                                if (form.parentNode) form.parentNode.removeChild(form);
                                if (iframe.parentNode) iframe.parentNode.removeChild(iframe);
                            } catch (e) {
                                console.warn('Cleanup error:', e);
                            }
                            resolve(response);
                        };
                        
                        // Submit form
                        form.submit();
                        
                        // Timeout after 20 seconds
                        setTimeout(() => {
                            if (window[callbackName]) {
                                console.error('‚ùå JSONP POST timeout');
                                try {
                                    delete window[callbackName];
                                    if (form.parentNode) form.parentNode.removeChild(form);
                                    if (iframe.parentNode) iframe.parentNode.removeChild(iframe);
                                } catch (e) {
                                    console.warn('Cleanup error:', e);
                                }
                                reject(new Error('JSONP POST timeout'));
                            }
                        }, 20000);
                    });
                    
                    syncMethod = 'JSONP POST';
                    console.log('‚úÖ JSONP POST sync successful:', result);
                    
                } catch (jsonpPostError) {
                    console.log('‚ö†Ô∏è JSONP POST failed:', jsonpPostError.message);
                    
                    // Method 2: Try JSONP GET with URL parameters
                    try {
                        console.log('üîÑ Attempting JSONP GET sync...');
                        const callbackName = 'syncToSheetGetCallback_' + Date.now();
                        
                        // Check data size for URL parameters
                        const dataString = JSON.stringify(subscriptions);
                        if (dataString.length > 1500) {
                            throw new Error('Data too large for GET parameters');
                        }
                        
                        const syncUrl = `${sheetConfig.scriptUrl}?callback=${callbackName}&action=sync&data=${encodeURIComponent(dataString)}&_=${Date.now()}`;
                        
                        result = await new Promise((resolve, reject) => {
                            window[callbackName] = function(response) {
                                console.log('‚úÖ JSONP GET callback received:', response);
                                try {
                                    delete window[callbackName];
                                } catch (e) {
                                    window[callbackName] = undefined;
                                }
                                resolve(response);
                            };
                            
                            const script = document.createElement('script');
                            script.src = syncUrl;
                            script.onerror = () => {
                                console.error('‚ùå JSONP GET script failed');
                                try {
                                    delete window[callbackName];
                                } catch (e) {
                                    window[callbackName] = undefined;
                                }
                                if (script.parentNode) script.parentNode.removeChild(script);
                                reject(new Error('JSONP GET script failed'));
                            };
                            
                            setTimeout(() => {
                                if (window[callbackName]) {
                                    console.error('‚ùå JSONP GET timeout');
                                    try {
                                        delete window[callbackName];
                                    } catch (e) {
                                        window[callbackName] = undefined;
                                    }
                                    if (script.parentNode) script.parentNode.removeChild(script);
                                    reject(new Error('JSONP GET timeout'));
                                }
                            }, 15000);
                            
                            document.head.appendChild(script);
                            
                            setTimeout(() => {
                                if (script.parentNode) script.parentNode.removeChild(script);
                            }, 2000);
                        });
                        
                        syncMethod = 'JSONP GET';
                        console.log('‚úÖ JSONP GET sync successful:', result);
                        
                    } catch (jsonpGetError) {
                        console.log('‚ö†Ô∏è JSONP GET failed:', jsonpGetError.message);
                        
                        // Method 3: Try regular POST with form data
                        try {
                            console.log('üîÑ Attempting regular POST sync...');
                            const formData = new FormData();
                            formData.append('action', 'sync');
                            formData.append('subscriptions', JSON.stringify(subscriptions));
                            
                            const response = await fetch(sheetConfig.scriptUrl, {
                                method: 'POST',
                                mode: 'no-cors',
                                body: formData
                            });
                            
                            // With no-cors, we can't read response but assume success if no error
                            console.log('‚úÖ Regular POST completed (no-cors mode)');
                            result = { success: true, count: subscriptions.length };
                            syncMethod = 'POST (no-cors)';
                            
                        } catch (postError) {
                            console.error('‚ùå All sync methods failed');
                            throw new Error('All sync methods failed. Check Apps Script deployment and URL.');
                        }
                    }
                }
                
                // Process the result
                if (result && (result.success || result.count !== undefined)) {
                    const recordCount = result.count || subscriptions.length;
                    
                    // Update sync status
                    sheetConfig.lastSync = new Date().toISOString();
                    saveSheetConfig();
                    updateConnectionStatus();
                    updateSyncIndicator('success');
                    
                    // Update sync details
                    const syncDetails = document.getElementById('syncDetails');
                    if (syncDetails) {
                        syncDetails.textContent = `Uploaded ${recordCount} records via ${syncMethod}`;
                    }
                    
                    console.log(`‚úÖ Sync completed successfully: ${recordCount} records via ${syncMethod}`);
                    showNotification(`‚úÖ ${recordCount} ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ Google Sheet ‡§Æ‡•á‡§Ç ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•Å‡§è! Records uploaded successfully!`, 'success');
                    
                    // Return success for promise chain
                    return Promise.resolve({ success: true, count: recordCount, method: syncMethod });
                    
                } else if (result && result.error) {
                    console.error('‚ùå Apps Script error:', result.error);
                    showNotification(`‚ùå Apps Script Error: ${result.error}`, 'error');
                    return Promise.reject(new Error(`Apps Script Error: ${result.error}`));
                } else {
                    console.warn('‚ö†Ô∏è Unexpected sync result:', result);
                    showNotification('‚ö†Ô∏è Sync completed but response format unexpected. Check Google Sheet manually.', 'error');
                    return Promise.reject(new Error('Unexpected sync result format'));
                }
                
            } catch (error) {
                console.error('‚ùå Sync to sheet error:', error);
                
                if (error.message.includes('too large')) {
                    showNotification('‚ùå ‡§°‡•á‡§ü‡§æ ‡§¨‡§π‡•Å‡§§ ‡§¨‡§°‡§º‡§æ ‡§π‡•à! Data too large. Use CSV export instead.', 'error');
                    
                    // Offer CSV export as alternative
                    setTimeout(() => {
                        const modal = document.getElementById('confirmModal');
                        const modalContent = modal.querySelector('.modal-content');
                        
                        modalContent.innerHTML = `
                            <div style="font-size: 2rem; margin-bottom: 1rem; color: #f59e0b;">‚ö†Ô∏è</div>
                            <h3 style="font-size: 1.25rem; font-weight: 700; color: #f59e0b; margin-bottom: 1rem;">Data Too Large for Direct Sync</h3>
                            <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6;">
                                <p>‡§Ü‡§™‡§ï‡§æ ‡§°‡•á‡§ü‡§æ automatic sync ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§π‡•Å‡§§ ‡§¨‡§°‡§º‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ CSV export ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                                <p>Your data is too large for automatic sync. Please use CSV export method.</p>
                                
                                <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                    <p style="color: #1e40af; margin: 0; font-weight: 600;">
                                        üì§ <strong>CSV Export Steps:</strong><br>
                                        1. Click "Export CSV" below<br>
                                        2. Open your Google Sheet<br>
                                        3. Go to File ‚Üí Import ‚Üí Upload<br>
                                        4. Select the CSV file and import
                                    </p>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: center; gap: 1rem;">
                                <button onclick="exportToExcel(); hideConfirmModal();" class="btn btn-success">
                                    üì§ Export CSV
                                </button>
                                <button onclick="hideConfirmModal()" class="btn btn-secondary">
                                    ‚ùå Cancel
                                </button>
                            </div>
                        `;
                        
                        modal.classList.add('show');
                    }, 1000);
                } else if (error.message.includes('CORS')) {
                    showNotification('‚ùå CORS ‡§è‡§∞‡§∞! Apps Script deployment settings may be incorrect.', 'error');
                } else if (error.message.includes('timeout')) {
                    showNotification('‚ùå ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ü‡§æ‡§á‡§Æ‡§Ü‡§â‡§ü! Apps Script may be slow. Try again or use CSV export.', 'error');
                } else {
                    showNotification('‚ùå Google Sheet ‡§Æ‡•á‡§Ç ‡§∏‡§ø‡§Ç‡§ï ‡§´‡•á‡§≤! Sync failed. Check Apps Script URL and permissions.', 'error');
                }
                
                updateSyncIndicator('error');
                
                // Return error for promise chain
                return Promise.reject(error);
                
            } finally {
                if (syncBtn) {
                    syncBtn.innerHTML = syncBtn.innerHTML.replace('‚¨ÜÔ∏è Syncing...', '‚¨ÜÔ∏è Sync to Sheet');
                    syncBtn.disabled = false;
                }
            }
        }

        // Show sync to sheet instructions
        function showSyncToSheetInstructions(csvData) {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem;">‚¨ÜÔ∏è</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #059669; margin-bottom: 1rem;">Sync to Google Sheet</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6;">
                    <p>To sync data to Google Sheet, you have two options:</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p><strong>Option 1: Manual Copy-Paste</strong></p>
                        <p>1. Click "Copy CSV Data" below</p>
                        <p>2. Open your Google Sheet</p>
                        <p>3. Select cell A1 and paste the data</p>
                    </div>
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p><strong>Option 2: Google Apps Script (Recommended)</strong></p>
                        <p>Click "Setup Apps Script" to get the automated sync code</p>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="copyToClipboard('${csvData.replace(/'/g, "\\'")}'); hideConfirmModal();" class="btn btn-success">
                        üìã Copy CSV Data
                    </button>
                    <button onclick="showScriptSetup(); hideConfirmModal();" class="btn btn-primary">
                        ‚öôÔ∏è Setup Apps Script
                    </button>
                    <button onclick="hideConfirmModal()" class="btn btn-secondary">
                        ‚ùå Cancel
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Copy text to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('üìã CSV data copied to clipboard! Paste it in your Google Sheet.', 'success');
            }).catch(() => {
                showNotification('‚ùå Failed to copy data to clipboard.', 'error');
            });
        }

        // Show Apps Script troubleshooting
        function showAppsScriptTroubleshooting() {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem; color: #ef4444;">üîß</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #ef4444; margin-bottom: 1rem;">Apps Script Connection Issues</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                    
                    <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ef4444;">
                        <h4 style="color: #991b1b; margin: 0 0 0.5rem 0;">üö® Common CORS Issues:</h4>
                        <ul style="color: #991b1b; margin: 0; padding-left: 1.5rem;">
                            <li>Apps Script not deployed as "Web app"</li>
                            <li>Access not set to "Anyone"</li>
                            <li>Using /dev URL instead of /exec URL</li>
                            <li>Script permissions not granted</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #92400e; margin: 0 0 0.5rem 0;">‚ö†Ô∏è Deployment Checklist:</h4>
                        <ol style="color: #92400e; margin: 0; padding-left: 1.5rem;">
                            <li>Go to Apps Script ‚Üí Deploy ‚Üí New Deployment</li>
                            <li>Type: <strong>Web app</strong></li>
                            <li>Execute as: <strong>Me</strong></li>
                            <li>Who has access: <strong>Anyone</strong></li>
                            <li>Copy the <strong>/exec</strong> URL (not /dev)</li>
                        </ol>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #1e40af; margin: 0 0 0.5rem 0;">üí° Alternative Solutions:</h4>
                        <ul style="color: #1e40af; margin: 0; padding-left: 1.5rem;">
                            <li>Use CSV Export/Import instead of live sync</li>
                            <li>Try opening the webapp in HTTPS mode</li>
                            <li>Check if your browser blocks third-party scripts</li>
                            <li>Disable ad blockers temporarily</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #22c55e;">
                        <h4 style="color: #15803d; margin: 0 0 0.5rem 0;">‚úÖ Test Your Setup:</h4>
                        <p style="color: #15803d; margin: 0;">
                            1. Open your Apps Script URL directly in browser<br>
                            2. You should see JSON response like: {"subscriptions":[]}<br>
                            3. If you see HTML or error, deployment is incorrect
                        </p>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="showScriptSetup(); hideConfirmModal();" class="btn btn-primary">
                        ‚öôÔ∏è View Script Code
                    </button>
                    <button onclick="window.open('https://script.google.com', '_blank', 'noopener,noreferrer');" class="btn btn-success">
                        üöÄ Open Apps Script
                    </button>
                    <button onclick="hideConfirmModal()" class="btn btn-secondary">
                        ‚úÖ Close
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Show test connection troubleshooting
        function showTestConnectionTroubleshooting(errorMessage) {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem; color: #ef4444;">üîß</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #ef4444; margin-bottom: 1rem;">Connection Test Failed</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                    
                    <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ef4444;">
                        <h4 style="color: #991b1b; margin: 0 0 0.5rem 0;">‚ùå Error Details:</h4>
                        <p style="color: #991b1b; margin: 0; font-family: monospace; font-size: 0.8rem; background: white; padding: 0.5rem; border-radius: 4px;">
                            ${errorMessage}
                        </p>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #92400e; margin: 0 0 0.5rem 0;">üîç Quick Diagnosis:</h4>
                        <ul style="color: #92400e; margin: 0; padding-left: 1.5rem;">
                            <li><strong>URL Check:</strong> Ensure URL ends with /exec (not /dev)</li>
                            <li><strong>Deployment:</strong> Apps Script must be deployed as "Web app"</li>
                            <li><strong>Access:</strong> Set "Who has access" to "Anyone"</li>
                            <li><strong>Permissions:</strong> Grant all required permissions</li>
                        </ul>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #1e40af; margin: 0 0 0.5rem 0;">üß™ Test Your Apps Script:</h4>
                        <ol style="color: #1e40af; margin: 0; padding-left: 1.5rem;">
                            <li>Open your Apps Script URL directly in browser</li>
                            <li>You should see: <code>{"subscriptions":[]}</code></li>
                            <li>If you see HTML or error page, deployment is wrong</li>
                            <li>If browser shows "This site can't be reached", URL is incorrect</li>
                        </ol>
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #22c55e;">
                        <h4 style="color: #15803d; margin: 0 0 0.5rem 0;">‚úÖ Working Connection Signs:</h4>
                        <ul style="color: #15803d; margin: 0; padding-left: 1.5rem;">
                            <li>Browser shows JSON response when visiting URL</li>
                            <li>No CORS errors in browser console</li>
                            <li>Apps Script execution transcript shows no errors</li>
                            <li>Test connection returns success message</li>
                        </ul>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="window.open(sheetConfig.scriptUrl, '_blank', 'noopener,noreferrer');" class="btn btn-primary">
                        üåê Test URL in Browser
                    </button>
                    <button onclick="showScriptSetup(); hideConfirmModal();" class="btn btn-success">
                        ‚öôÔ∏è Fix Apps Script
                    </button>
                    <button onclick="hideConfirmModal()" class="btn btn-secondary">
                        ‚úÖ Close
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Show sync to sheet troubleshooting
        function showSyncToSheetTroubleshooting(errorMessage) {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem; color: #ef4444;">üîß</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #ef4444; margin-bottom: 1rem;">Sync to Sheet Failed</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                    
                    <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ef4444;">
                        <h4 style="color: #991b1b; margin: 0 0 0.5rem 0;">‚ùå Error Details:</h4>
                        <p style="color: #991b1b; margin: 0; font-family: monospace; font-size: 0.8rem; background: white; padding: 0.5rem; border-radius: 4px;">
                            ${errorMessage || 'Unknown error occurred'}
                        </p>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #92400e; margin: 0 0 0.5rem 0;">üîç Common Issues:</h4>
                        <ul style="color: #92400e; margin: 0; padding-left: 1.5rem;">
                            <li><strong>Apps Script not deployed:</strong> Ensure Web App is deployed with "Anyone" access</li>
                            <li><strong>Wrong URL:</strong> Use /exec URL, not /dev URL</li>
                            <li><strong>CORS blocking:</strong> Apps Script may need proper CORS headers</li>
                            <li><strong>Data too large:</strong> Try CSV export for large datasets</li>
                            <li><strong>Script timeout:</strong> Apps Script may be taking too long to process</li>
                        </ul>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #1e40af; margin: 0 0 0.5rem 0;">üß™ Debug Steps:</h4>
                        <ol style="color: #1e40af; margin: 0; padding-left: 1.5rem;">
                            <li>Open browser console (F12) and check for errors</li>
                            <li>Test your Apps Script URL directly in browser</li>
                            <li>Verify Apps Script execution transcript for errors</li>
                            <li>Check Google Sheet permissions and sharing settings</li>
                            <li>Try with smaller dataset first</li>
                        </ol>
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #22c55e;">
                        <h4 style="color: #15803d; margin: 0 0 0.5rem 0;">‚úÖ Alternative Solutions:</h4>
                        <ul style="color: #15803d; margin: 0; padding-left: 1.5rem;">
                            <li><strong>CSV Export:</strong> Export data and manually import to Google Sheet</li>
                            <li><strong>Copy-Paste:</strong> Copy data from webapp tables and paste in sheet</li>
                            <li><strong>Smaller Batches:</strong> Try syncing fewer records at a time</li>
                            <li><strong>Re-deploy Script:</strong> Create new deployment with fresh URL</li>
                        </ul>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="exportToExcel(); hideConfirmModal();" class="btn btn-success">
                        üì§ Export CSV
                    </button>
                    <button onclick="showScriptSetup(); hideConfirmModal();" class="btn btn-primary">
                        ‚öôÔ∏è Fix Apps Script
                    </button>
                    <button onclick="window.open(sheetConfig.scriptUrl, '_blank', 'noopener,noreferrer');" class="btn btn-secondary">
                        üåê Test Script URL
                    </button>
                    <button onclick="hideConfirmModal()" class="btn">
                        ‚úÖ Close
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Show sync troubleshooting
        function showSyncTroubleshooting() {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem; color: #f59e0b;">üîÑ</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #f59e0b; margin-bottom: 1rem;">Sync Troubleshooting Guide</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                    
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #92400e; margin: 0 0 0.5rem 0;">üîç Quick Fixes:</h4>
                        <ul style="color: #92400e; margin: 0; padding-left: 1.5rem;">
                            <li>Check your internet connection</li>
                            <li>Verify Apps Script URL is correct (/exec not /dev)</li>
                            <li>Ensure Google Sheet has proper headers in Row 1</li>
                            <li>Try refreshing the page and reconnecting</li>
                        </ul>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #1e40af; margin: 0 0 0.5rem 0;">üõ†Ô∏è Manual Alternatives:</h4>
                        <ul style="color: #1e40af; margin: 0; padding-left: 1.5rem;">
                            <li><strong>Export CSV:</strong> Download data and manually paste in Google Sheet</li>
                            <li><strong>Import CSV:</strong> Download sheet as CSV and import here</li>
                            <li><strong>Copy-Paste:</strong> Use browser copy-paste between webapp and sheet</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #22c55e;">
                        <h4 style="color: #15803d; margin: 0 0 0.5rem 0;">üìã Required Sheet Headers:</h4>
                        <div style="background: white; padding: 0.5rem; border-radius: 4px; font-family: monospace; font-size: 0.8rem; color: #374151;">
                            A1: Company Name | B1: Mobile No | C1: Email ID<br>
                            D1: Subscription ID | E1: Model | F1: Starting Date<br>
                            G1: Expiry Date | H1: Remarks | I1: Created At | J1: Last Modified
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="exportToExcel(); hideConfirmModal();" class="btn btn-success">
                        üì§ Export CSV
                    </button>
                    <button onclick="showScriptSetup(); hideConfirmModal();" class="btn btn-primary">
                        ‚öôÔ∏è Fix Apps Script
                    </button>
                    <button onclick="hideConfirmModal()" class="btn btn-secondary">
                        ‚úÖ Close
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Show Google Apps Script setup
        function showScriptSetup() {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            const scriptCode = `
function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    
    // Handle both JSON and form data
    let data;
    if (e.postData.type === 'application/json') {
      data = JSON.parse(e.postData.contents);
    } else {
      // Handle form data
      data = {
        action: e.parameter.action,
        subscriptions: JSON.parse(e.parameter.subscriptions || '[]')
      };
    }
    
    if (data.action === 'sync') {
      // Clear existing data (except headers)
      const lastRow = sheet.getLastRow();
      if (lastRow > 1) {
        sheet.getRange(2, 1, lastRow - 1, 10).clear();
      }
      
      // Add new data
      if (data.subscriptions && data.subscriptions.length > 0) {
        const rows = data.subscriptions.map(sub => [
          sub.companyName || '',
          sub.mobileNo || '',
          sub.emailId || '',
          sub.subscriptionId || '',
          sub.model || '',
          sub.startingDate || '',
          sub.expiryDate || '',
          sub.remarks || '',
          sub.createdAt || '',
          new Date().toISOString()
        ]);
        
        sheet.getRange(2, 1, rows.length, 10).setValues(rows);
      }
      
      return ContentService
        .createTextOutput(JSON.stringify({success: true, count: data.subscriptions.length}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({error: 'Invalid action'}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    
    // Handle sync via GET parameters
    if (e.parameter.action === 'sync' && e.parameter.data) {
      const subscriptions = JSON.parse(decodeURIComponent(e.parameter.data));
      
      // Clear existing data (except headers)
      const lastRow = sheet.getLastRow();
      if (lastRow > 1) {
        sheet.getRange(2, 1, lastRow - 1, 10).clear();
      }
      
      // Add new data
      if (subscriptions && subscriptions.length > 0) {
        const rows = subscriptions.map(sub => [
          sub.companyName || '',
          sub.mobileNo || '',
          sub.emailId || '',
          sub.subscriptionId || '',
          sub.model || '',
          sub.startingDate || '',
          sub.expiryDate || '',
          sub.remarks || '',
          sub.createdAt || '',
          new Date().toISOString()
        ]);
        
        sheet.getRange(2, 1, rows.length, 10).setValues(rows);
      }
      
      // Handle JSONP callback
      const callback = e.parameter.callback;
      const response = JSON.stringify({success: true, count: subscriptions.length});
      
      if (callback) {
        return ContentService
          .createTextOutput(callback + '(' + response + ')')
          .setMimeType(ContentService.MimeType.JAVASCRIPT);
      } else {
        return ContentService
          .createTextOutput(response)
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // Regular GET request - return sheet data
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      const response = JSON.stringify({subscriptions: []});
      const callback = e.parameter.callback;
      
      if (callback) {
        return ContentService
          .createTextOutput(callback + '(' + response + ')')
          .setMimeType(ContentService.MimeType.JAVASCRIPT);
      } else {
        return ContentService
          .createTextOutput(response)
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    const subscriptions = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[0] && row[3]) { // Company name and subscription ID required
        subscriptions.push({
          companyName: row[0],
          mobileNo: row[1],
          emailId: row[2],
          subscriptionId: row[3],
          model: row[4],
          startingDate: row[5],
          expiryDate: row[6],
          remarks: row[7],
          createdAt: row[8],
          lastModified: row[9]
        });
      }
    }
    
    const response = JSON.stringify({subscriptions: subscriptions});
    const callback = e.parameter.callback;
    
    if (callback) {
      return ContentService
        .createTextOutput(callback + '(' + response + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    } else {
      return ContentService
        .createTextOutput(response)
        .setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    const response = JSON.stringify({error: error.toString()});
    const callback = e.parameter.callback;
    
    if (callback) {
      return ContentService
        .createTextOutput(callback + '(' + response + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    } else {
      return ContentService
        .createTextOutput(response)
        .setMimeType(ContentService.MimeType.JSON);
    }
  }
}
            `.trim();
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem;">‚öôÔ∏è</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #059669; margin-bottom: 1rem;">Google Apps Script Setup</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                    <p><strong>Follow these steps to enable automatic sync:</strong></p>
                    <ol style="padding-left: 1.5rem;">
                        <li>Open your Google Sheet</li>
                        <li>Go to <strong>Extensions ‚Üí Apps Script</strong></li>
                        <li>Delete the default code and paste the code below</li>
                        <li>Save the project (Ctrl+S)</li>
                        <li>Click <strong>Deploy ‚Üí New Deployment</strong></li>
                        <li>Choose <strong>Web app</strong> as type</li>
                        <li>Set <strong>Execute as: Me</strong></li>
                        <li>Set <strong>Who has access: Anyone</strong></li>
                        <li>Click <strong>Deploy</strong></li>
                        <li>Copy the Web App URL and paste it in the webapp settings</li>
                    </ol>
                    
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid #e9ecef;">
                        <p style="margin: 0 0 0.5rem 0; font-weight: 600;">Apps Script Code:</p>
                        <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.75rem; line-height: 1.4; margin: 0; max-height: 200px; overflow-y: auto; background: white; padding: 0.5rem; border-radius: 4px;">${scriptCode}</pre>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="copyToClipboard('${scriptCode.replace(/'/g, "\\'")}'); showNotification('üìã Apps Script code copied!', 'success');" class="btn btn-success">
                        üìã Copy Script Code
                    </button>
                    <button onclick="window.open('https://script.google.com', '_blank', 'noopener,noreferrer');" class="btn btn-primary">
                        üöÄ Open Apps Script
                    </button>
                    <button onclick="hideConfirmModal()" class="btn btn-secondary">
                        ‚úÖ Done
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Enable/Disable Auto Sync
        function enableAutoSync() {
            if (!sheetConfig.connected) {
                showNotification('‚ùå Please connect to a Google Sheet first!', 'error');
                return;
            }
            
            sheetConfig.autoSync = !sheetConfig.autoSync;
            saveSheetConfig();
            updateConnectionStatus();
            
            if (sheetConfig.autoSync) {
                startAutoSync();
                showNotification('‚úÖ Auto sync enabled!', 'success');
            } else {
                stopAutoSync();
                showNotification('‚è∏Ô∏è Auto sync disabled!', 'success');
            }
        }

        // Start auto sync
        function startAutoSync() {
            if (syncTimer) {
                clearInterval(syncTimer);
            }
            
            const intervalMs = sheetConfig.syncInterval * 60 * 1000; // Convert minutes to milliseconds
            
            syncTimer = setInterval(() => {
                if (sheetConfig.connected && sheetConfig.autoSync) {
                    syncFromSheet();
                }
            }, intervalMs);
        }

        // Stop auto sync
        function stopAutoSync() {
            if (syncTimer) {
                clearInterval(syncTimer);
                syncTimer = null;
            }
        }

        // Save auto sync settings
        function saveAutoSyncSettings() {
            const syncInterval = parseInt(document.getElementById('syncInterval').value);
            const syncOnLoad = document.getElementById('syncOnLoad').checked;
            
            sheetConfig.syncInterval = syncInterval;
            sheetConfig.syncOnLoad = syncOnLoad;
            
            saveSheetConfig();
            
            // Restart auto sync with new interval
            if (sheetConfig.autoSync) {
                startAutoSync();
            }
            
            showNotification('‚úÖ Auto sync settings saved!', 'success');
        }

        // Update sync indicator
        function updateSyncIndicator(status) {
            const indicator = document.getElementById('syncIndicator');
            
            switch (status) {
                case 'success':
                    indicator.style.background = '#10b981';
                    break;
                case 'warning':
                    indicator.style.background = '#f59e0b';
                    break;
                case 'error':
                    indicator.style.background = '#ef4444';
                    break;
                default:
                    indicator.style.background = '#6b7280';
            }
        }

        // Disconnect from Google Sheet
        function disconnectSheet() {
            document.getElementById('confirmMessage').textContent = 
                'Are you sure you want to disconnect from Google Sheets? Auto sync will be disabled.';
            document.getElementById('confirmButton').onclick = function() {
                sheetConfig = {
                    url: '',
                    id: '',
                    scriptUrl: '',
                    connected: false,
                    scriptConnected: false,
                    autoSync: false,
                    syncInterval: 5,
                    syncOnLoad: true,
                    lastSync: null
                };
                
                stopAutoSync();
                saveSheetConfig();
                updateConnectionStatus();
                
                // Clear URL inputs
                document.getElementById('sheetUrl').value = '';
                document.getElementById('scriptUrl').value = '';
                
                showNotification('üîå Disconnected from Google Sheets and Apps Script!', 'success');
                hideConfirmModal();
            };
            showConfirmModal();
        }

        // Enhanced save data with sync integration
        function saveDataWithSync() {
            try {
                console.log('Saving data to localStorage...', subscriptions.length, 'records');
                localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
                console.log('Data saved successfully to localStorage');
                updateAllViews();
                console.log('All views updated');
                
                // Auto sync to sheet if Apps Script is connected
                if (sheetConfig.scriptConnected) {
                    console.log('üîÑ Auto-syncing to Google Sheet...');
                    setTimeout(() => {
                        syncToSheet();
                    }, 500);
                }
            } catch (error) {
                console.error('Error saving data:', error);
                showNotification('‚ùå ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø! Error saving data. Please try again.', 'error');
            }
        }

        // Enhanced save data with immediate database sync for critical operations
        function saveDataWithDatabaseSync() {
            try {
                console.log('üîÑ Saving data with immediate database sync...', subscriptions.length, 'records');
                
                // Save to localStorage first
                localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
                console.log('‚úÖ Data saved to localStorage successfully');
                
                // Update all views immediately
                updateAllViews();
                console.log('‚úÖ All views updated');
                
                // Immediate sync to database if connected
                if (sheetConfig.scriptConnected) {
                    console.log('üîÑ Immediate database sync initiated...');
                    
                    // Show sync status
                    showNotification('üîÑ ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡§ø‡§Ç‡§ï ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à... Syncing to database...', 'success');
                    
                    // Sync immediately without delay for critical operations like delete
                    syncToSheet().then(() => {
                        console.log('‚úÖ Database sync completed successfully');
                        showNotification('‚úÖ ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§∏‡§ø‡§Ç‡§ï ‡§™‡•Ç‡§∞‡§æ! Database sync completed!', 'success');
                        
                        // Verify sync by reading back data after a short delay
                        setTimeout(() => {
                            console.log('üîç Verifying database sync...');
                            syncFromSheet();
                        }, 2000);
                        
                    }).catch((error) => {
                        console.error('‚ùå Database sync failed:', error);
                        showNotification('‚ö†Ô∏è ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§∏‡§ø‡§Ç‡§ï ‡§´‡•á‡§≤! Database sync failed. Data saved locally.', 'error');
                    });
                } else {
                    console.log('‚ö†Ô∏è Database not connected - data saved locally only');
                    showNotification('‚ö†Ô∏è ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à! Data saved locally. Connect database for sync.', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Critical error in saveDataWithDatabaseSync:', error);
                showNotification('‚ùå ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø! Critical error saving data: ' + error.message, 'error');
            }
        }

        // Test enhanced sync methods for file protocol
        async function testEnhancedSync() {
            if (!sheetConfig.scriptConnected) return;
            
            console.log('üß™ Testing enhanced sync methods for file protocol...');
            
            try {
                // Method 1: Try JSONP with enhanced error handling
                console.log('üîÑ Attempting enhanced JSONP sync...');
                const result = await attemptEnhancedJSONP();
                
                if (result.success) {
                    console.log('‚úÖ Enhanced JSONP sync successful!');
                    showNotification('‚úÖ Database sync successful! JSONP method working.', 'success');
                    return;
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Enhanced JSONP failed:', error.message);
            }
            
            try {
                // Method 2: Try iframe-based sync
                console.log('üîÑ Attempting iframe-based sync...');
                const result = await attemptIframeSync();
                
                if (result.success) {
                    console.log('‚úÖ Iframe sync successful!');
                    showNotification('‚úÖ Database sync successful! Iframe method working.', 'success');
                    return;
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Iframe sync failed:', error.message);
            }
            
            // If all methods fail, show manual sync options
            console.log('‚ùå All enhanced sync methods failed');
            setTimeout(() => {
                showFileProtocolSyncOptions();
            }, 1000);
        }

        // Enhanced JSONP method with better error handling
        async function attemptEnhancedJSONP() {
            return new Promise((resolve, reject) => {
                const callbackName = 'enhancedSyncCallback_' + Date.now();
                const testUrl = `${sheetConfig.scriptUrl}?callback=${callbackName}&action=get&_=${Date.now()}`;
                
                // Create callback with enhanced cleanup
                window[callbackName] = function(response) {
                    console.log('‚úÖ Enhanced JSONP callback received:', response);
                    
                    // Immediate cleanup
                    try {
                        delete window[callbackName];
                    } catch (e) {
                        window[callbackName] = undefined;
                    }
                    
                    if (response && response.subscriptions !== undefined) {
                        // Process the data
                        const validSubscriptions = response.subscriptions.filter(sub => 
                            sub && sub.companyName && sub.subscriptionId
                        );
                        
                        subscriptions = validSubscriptions;
                        localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
                        updateAllViews();
                        
                        resolve({ success: true, count: validSubscriptions.length });
                    } else {
                        resolve({ success: false, error: 'Invalid response format' });
                    }
                };
                
                // Create script with enhanced error handling
                const script = document.createElement('script');
                script.src = testUrl;
                script.id = 'enhanced-jsonp-' + Date.now();
                
                script.onload = () => {
                    console.log('‚úÖ Enhanced JSONP script loaded');
                    setTimeout(() => {
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                    }, 2000);
                };
                
                script.onerror = () => {
                    console.error('‚ùå Enhanced JSONP script failed');
                    try {
                        delete window[callbackName];
                    } catch (e) {
                        window[callbackName] = undefined;
                    }
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('Script failed to load'));
                };
                
                // Enhanced timeout with cleanup
                const timeoutId = setTimeout(() => {
                    if (window[callbackName]) {
                        console.error('‚ùå Enhanced JSONP timeout');
                        try {
                            delete window[callbackName];
                        } catch (e) {
                            window[callbackName] = undefined;
                        }
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        reject(new Error('Enhanced JSONP timeout'));
                    }
                }, 20000); // 20 second timeout
                
                // Clear timeout on success/failure
                const originalResolve = resolve;
                const originalReject = reject;
                
                resolve = (result) => {
                    clearTimeout(timeoutId);
                    originalResolve(result);
                };
                
                reject = (error) => {
                    clearTimeout(timeoutId);
                    originalReject(error);
                };
                
                document.head.appendChild(script);
            });
        }

        // Iframe-based sync method
        async function attemptIframeSync() {
            return new Promise((resolve, reject) => {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = sheetConfig.scriptUrl + '?action=get&_=' + Date.now();
                
                iframe.onload = () => {
                    try {
                        // Try to access iframe content
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const content = iframeDoc.body.textContent;
                        
                        if (content) {
                            const data = JSON.parse(content);
                            if (data.subscriptions !== undefined) {
                                const validSubscriptions = data.subscriptions.filter(sub => 
                                    sub && sub.companyName && sub.subscriptionId
                                );
                                
                                subscriptions = validSubscriptions;
                                localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
                                updateAllViews();
                                
                                resolve({ success: true, count: validSubscriptions.length });
                            } else {
                                resolve({ success: false, error: 'Invalid data format' });
                            }
                        } else {
                            resolve({ success: false, error: 'No content received' });
                        }
                    } catch (error) {
                        console.log('‚ö†Ô∏è Iframe content access blocked:', error.message);
                        resolve({ success: false, error: 'CORS blocked iframe access' });
                    } finally {
                        if (iframe.parentNode) {
                            iframe.parentNode.removeChild(iframe);
                        }
                    }
                };
                
                iframe.onerror = () => {
                    if (iframe.parentNode) {
                        iframe.parentNode.removeChild(iframe);
                    }
                    reject(new Error('Iframe failed to load'));
                };
                
                // Timeout for iframe
                setTimeout(() => {
                    if (iframe.parentNode) {
                        iframe.parentNode.removeChild(iframe);
                        reject(new Error('Iframe timeout'));
                    }
                }, 15000);
                
                document.body.appendChild(iframe);
            });
        }

        // Show file protocol sync options
        function showFileProtocolSyncOptions() {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem; color: #f59e0b;">‚ö†Ô∏è</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #f59e0b; margin-bottom: 1rem;">File Protocol Sync Options</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6;">
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
                        <p style="color: #92400e; margin: 0; font-weight: 600;">
                            üîí Your webapp is running from a local file, which limits automatic sync capabilities due to browser security.
                        </p>
                    </div>
                    
                    <p><strong>Available Sync Methods:</strong></p>
                    
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h4 style="color: #1e40af; margin: 0 0 0.5rem 0;">üì§ Method 1: CSV Export/Import</h4>
                        <p style="color: #1e40af; margin: 0; font-size: 0.85rem;">
                            Export data as CSV and manually import to Google Sheets. Most reliable method.
                        </p>
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h4 style="color: #15803d; margin: 0 0 0.5rem 0;">üîÑ Method 2: Manual Copy-Paste</h4>
                        <p style="color: #15803d; margin: 0; font-size: 0.85rem;">
                            Copy data from webapp tables and paste directly into Google Sheets.
                        </p>
                    </div>
                    
                    <div style="background: #fef2f2; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h4 style="color: #991b1b; margin: 0 0 0.5rem 0;">üåê Method 3: Host on Web Server</h4>
                        <p style="color: #991b1b; margin: 0; font-size: 0.85rem;">
                            Upload webapp to a web server (HTTPS) to enable automatic sync.
                        </p>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="exportToExcel(); hideConfirmModal();" class="btn btn-success">
                        üì§ Export CSV
                    </button>
                    <button onclick="showManualSyncGuide(); hideConfirmModal();" class="btn btn-primary">
                        üìã Manual Sync Guide
                    </button>
                    <button onclick="hideConfirmModal()" class="btn btn-secondary">
                        ‚úÖ Continue Offline
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Show manual sync guide
        function showManualSyncGuide() {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem;">üìã</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #059669; margin-bottom: 1rem;">Manual Sync Guide</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                    
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #22c55e;">
                        <h4 style="color: #15803d; margin: 0 0 0.5rem 0;">üì§ Webapp ‚Üí Google Sheets:</h4>
                        <ol style="color: #15803d; margin: 0; padding-left: 1.5rem; font-size: 0.85rem;">
                            <li>Go to Master Entry tab ‚Üí Click "Bulk Import/Export"</li>
                            <li>Click "Export to Excel" to download CSV file</li>
                            <li>Open your Google Sheet</li>
                            <li>Go to File ‚Üí Import ‚Üí Upload ‚Üí Select your CSV file</li>
                            <li>Choose "Replace spreadsheet" and click "Import data"</li>
                        </ol>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #1e40af; margin: 0 0 0.5rem 0;">üì• Google Sheets ‚Üí Webapp:</h4>
                        <ol style="color: #1e40af; margin: 0; padding-left: 1.5rem; font-size: 0.85rem;">
                            <li>Open your Google Sheet</li>
                            <li>Go to File ‚Üí Download ‚Üí Comma Separated Values (.csv)</li>
                            <li>In webapp, go to Master Entry tab</li>
                            <li>Click "Bulk Import/Export" ‚Üí "Import from Excel"</li>
                            <li>Select the downloaded CSV file</li>
                            <li>Data will be imported automatically</li>
                        </ol>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #92400e; margin: 0 0 0.5rem 0;">üí° Pro Tips:</h4>
                        <ul style="color: #92400e; margin: 0; padding-left: 1.5rem; font-size: 0.85rem;">
                            <li>Always backup your data before syncing</li>
                            <li>Ensure Google Sheet has proper column headers</li>
                            <li>Check data after import for accuracy</li>
                            <li>Use CSV format for best compatibility</li>
                            <li>Sync regularly to avoid data loss</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ef4444;">
                        <h4 style="color: #991b1b; margin: 0 0 0.5rem 0;">üö® Required Sheet Headers:</h4>
                        <div style="background: white; padding: 0.5rem; border-radius: 4px; font-family: monospace; font-size: 0.75rem; color: #374151;">
                            A1: Company Name | B1: Mobile No | C1: Email ID | D1: Subscription ID<br>
                            E1: Model | F1: Starting Date | G1: Expiry Date | H1: Remarks
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="exportToExcel(); hideConfirmModal();" class="btn btn-success">
                        üì§ Export Now
                    </button>
                    <button onclick="toggleBulkImport(); showTab('master'); hideConfirmModal();" class="btn btn-primary">
                        üì• Go to Import
                    </button>
                    <button onclick="copySheetTemplate(); hideConfirmModal();" class="btn btn-secondary">
                        üìã Copy Headers
                    </button>
                    <button onclick="hideConfirmModal()" class="btn">
                        ‚úÖ Close
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Auto sync from sheet on page load
        function autoSyncOnLoad() {
            if (sheetConfig.scriptConnected && sheetConfig.syncOnLoad) {
                console.log('üîÑ Auto sync enabled, attempting sync...');
                
                // For file protocol, use enhanced JSONP methods
                if (window.location.protocol === 'file:') {
                    console.log('üìÅ File protocol detected, using enhanced JSONP sync...');
                    setTimeout(() => {
                        syncFromSheet(); // This will use JSONP methods internally
                    }, 1500);
                } else {
                    // For web protocols, use standard sync
                    console.log('üåê Web protocol detected, using standard sync...');
                    setTimeout(() => {
                        syncFromSheet();
                    }, 1000);
                }
            } else {
                console.log('‚ö†Ô∏è Auto sync disabled or Apps Script not connected');
            }
        }

        // Show debug information
        function showDebugInfo() {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            const debugInfo = {
                'Script URL': sheetConfig.scriptUrl || 'Not set',
                'Script Connected': sheetConfig.scriptConnected ? '‚úÖ Yes' : '‚ùå No',
                'Last Sync': sheetConfig.lastSync ? new Date(sheetConfig.lastSync).toLocaleString('hi-IN') : 'Never',
                'Local Subscriptions': subscriptions.length,
                'Auto Sync': sheetConfig.autoSync ? '‚úÖ Enabled' : '‚ùå Disabled',
                'Browser': navigator.userAgent.split(' ').pop(),
                'Current Time': new Date().toLocaleString('hi-IN')
            };
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem;">üîç</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #374151; margin-bottom: 1rem;">Debug Information</h3>
                <div style="text-align: left; margin-bottom: 2rem;">
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; font-family: monospace; font-size: 0.85rem;">
                        ${Object.entries(debugInfo).map(([key, value]) => 
                            `<div style="margin-bottom: 0.5rem;"><strong>${key}:</strong> ${value}</div>`
                        ).join('')}
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <p style="color: #1e40af; font-size: 0.9rem; margin: 0; font-weight: 600;">
                            üí° If sync is failing, check browser console (F12) for detailed error messages.
                        </p>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem;">
                    <button onclick="copyToClipboard('${JSON.stringify(debugInfo, null, 2).replace(/'/g, "\\'")}'); showNotification('Debug info copied!', 'success');" class="btn btn-secondary">
                        üìã Copy Debug Info
                    </button>
                    <button onclick="hideConfirmModal()" class="btn btn-primary">
                        ‚úÖ Close
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Show manual sync option when automatic sync fails
        function showManualSyncOption() {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem; color: #f59e0b;">‚ö†Ô∏è</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #f59e0b; margin-bottom: 1rem;">Automatic Sync Failed</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6;">
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
                        <p style="color: #92400e; margin: 0; font-weight: 600;">
                            üö´ CORS Policy is blocking automatic sync from your Google Apps Script.
                        </p>
                    </div>
                    
                    <p><strong>This happens because:</strong></p>
                    <ul style="color: #6b7280; padding-left: 1.5rem;">
                        <li>You're running the webapp from a local file (file:// protocol)</li>
                        <li>Google Apps Script has strict CORS policies</li>
                        <li>Browser security prevents cross-origin requests</li>
                    </ul>
                    
                    <p><strong>Manual Sync Options:</strong></p>
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="color: #1e40af; margin: 0; font-weight: 600;">
                            üìã <strong>Option 1:</strong> Copy-paste data between webapp and Google Sheet
                        </p>
                    </div>
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="color: #15803d; margin: 0; font-weight: 600;">
                            üì§ <strong>Option 2:</strong> Export CSV from webapp and import to Google Sheet
                        </p>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="exportToExcel(); hideConfirmModal();" class="btn btn-success">
                        üì§ Export CSV
                    </button>
                    <button onclick="showManualSyncInstructions(); hideConfirmModal();" class="btn btn-primary">
                        üìã Manual Sync Guide
                    </button>
                    <button onclick="hideConfirmModal()" class="btn btn-secondary">
                        ‚úÖ Close
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Show manual sync instructions
        function showManualSyncInstructions() {
            const modal = document.getElementById('confirmModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem;">üìã</div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #059669; margin-bottom: 1rem;">Manual Sync Instructions</h3>
                <div style="text-align: left; margin-bottom: 2rem; font-size: 0.9rem; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                    
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #22c55e;">
                        <h4 style="color: #15803d; margin: 0 0 0.5rem 0;">üì§ From Webapp to Google Sheet:</h4>
                        <ol style="color: #15803d; margin: 0; padding-left: 1.5rem;">
                            <li>Click "Export CSV" button in webapp</li>
                            <li>Open the downloaded CSV file</li>
                            <li>Copy all data (Ctrl+A, Ctrl+C)</li>
                            <li>Open your Google Sheet</li>
                            <li>Select cell A1 and paste (Ctrl+V)</li>
                            <li>Choose "Split text to columns" if prompted</li>
                        </ol>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #1e40af; margin: 0 0 0.5rem 0;">üì• From Google Sheet to Webapp:</h4>
                        <ol style="color: #1e40af; margin: 0; padding-left: 1.5rem;">
                            <li>Open your Google Sheet</li>
                            <li>Go to File ‚Üí Download ‚Üí CSV (.csv)</li>
                            <li>In webapp, go to Master Entry tab</li>
                            <li>Click "Bulk Import/Export" button</li>
                            <li>Click "Import from Excel" and select the CSV file</li>
                            <li>Data will be imported automatically</li>
                        </ol>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #92400e; margin: 0 0 0.5rem 0;">üí° Pro Tips:</h4>
                        <ul style="color: #92400e; margin: 0; padding-left: 1.5rem;">
                            <li>Always backup your data before manual sync</li>
                            <li>Use CSV format for best compatibility</li>
                            <li>Check data after import to ensure accuracy</li>
                            <li>Keep column headers consistent</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ef4444;">
                        <h4 style="color: #991b1b; margin: 0 0 0.5rem 0;">üö® To Fix Automatic Sync:</h4>
                        <ul style="color: #991b1b; margin: 0; padding-left: 1.5rem;">
                            <li>Host webapp on HTTPS server (not local file)</li>
                            <li>Use Google Apps Script Web App with proper CORS headers</li>
                            <li>Deploy Apps Script with "Anyone" access</li>
                            <li>Use /exec URL (not /dev URL)</li>
                        </ul>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="exportToExcel(); hideConfirmModal();" class="btn btn-success">
                        üì§ Export CSV Now
                    </button>
                    <button onclick="toggleBulkImport(); showTab('master'); hideConfirmModal();" class="btn btn-primary">
                        üì• Go to Import
                    </button>
                    <button onclick="hideConfirmModal()" class="btn btn-secondary">
                        ‚úÖ Got it!
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // ==================== END GOOGLE SHEETS INTEGRATION ====================

        // Test form submission function for debugging
        function testFormSubmission() {
            console.log('üß™ Testing form submission...');
            
            // Fill form with test data
            const testData = {
                companyName: 'Test Company ' + Date.now(),
                mobileNo: '9876543210',
                emailId: 'test@company.com',
                subscriptionId: 'TEST' + Date.now(),
                model: 'Test Plan',
                startingDate: '2024-01-01',
                expiryDate: '2024-12-31',
                remarks: 'Test subscription entry'
            };
            
            // Fill the form
            Object.keys(testData).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = testData[key];
                    console.log(`‚úÖ Set ${key}: ${testData[key]}`);
                } else {
                    console.error(`‚ùå Element not found: ${key}`);
                }
            });
            
            // Update progress
            updateFormProgress();
            
            // Test form submission
            console.log('üöÄ Triggering form submission...');
            const form = document.getElementById('subscriptionForm');
            if (form) {
                // Create and dispatch submit event
                const submitEvent = new Event('submit', {
                    bubbles: true,
                    cancelable: true
                });
                
                form.dispatchEvent(submitEvent);
                console.log('üì§ Submit event dispatched');
            } else {
                console.error('‚ùå Form not found for testing');
                showNotification('‚ùå ‡§´‡•â‡§∞‡•ç‡§Æ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ! Form test failed!', 'error');
            }
        }

        // Notification function
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f728e4f1bcf556',t:'MTc2MDYxMzU1MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
